<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>《UNIX 环境高级编程》笔记0x4：标准I/O库 | Schwarzeni&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="此为第五章笔记">
<meta name="keywords" content="Linux,操作系统">
<meta property="og:type" content="article">
<meta property="og:title" content="《UNIX 环境高级编程》笔记0x4：标准I&#x2F;O库">
<meta property="og:url" content="http://blog.schwarzeni.com/2019/08/23/《UNIX-环境高级编程》笔记0x4：标准I-O/index.html">
<meta property="og:site_name" content="Schwarzeni&#39;s blog">
<meta property="og:description" content="此为第五章笔记">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://blog.schwarzeni.com/2019/08/23/《UNIX-环境高级编程》笔记0x4：标准I-O/image1.png">
<meta property="og:image" content="http://blog.schwarzeni.com/2019/08/23/《UNIX-环境高级编程》笔记0x4：标准I-O/image2.png">
<meta property="og:updated_time" content="2021-04-14T11:25:09.548Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="《UNIX 环境高级编程》笔记0x4：标准I&#x2F;O库">
<meta name="twitter:description" content="此为第五章笔记">
<meta name="twitter:image" content="http://blog.schwarzeni.com/2019/08/23/《UNIX-环境高级编程》笔记0x4：标准I-O/image1.png">
  
    <link rel="alternate" href="/atom.xml" title="Schwarzeni&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/images/favicon.ico">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  <!-- <link rel="stylesheet" href="/plugin/bganimation/bg.css"> -->
  

  <link rel="stylesheet" href="/third-party/powerful-sidebar-util/powerful-sidebar-util.css">

  <!-- add plugin for gittalk -->
  <link rel="stylesheet" href="/third-party/gittalk/gittalk.css" type="text/css">
</head>

<body>
	<style>
		.main-folder {
			width: 100%;
			height: 100%;
			position: absolute;
			background-image: url("/blog/images/folder-pic.jpg") ;
			background-size: 100%;
			z-index: 100;
	
		}
	</style>
			<!--<div id="container" style="display: none"> -->
		<!--	<div class="main-folder" id="main_folder"> -->
		<!--	</div> -->
	<div id="container">
    <div id="wrap" style="min-height:100%">
			<div class="outer">
        <div class="widget-wrap mobile-header">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <img class="avatar" src="/images/avatar.png">
    <h2 class="author">Schwarzeni</h2>
    <h3 class="description"></h3>
    <div class="count-box">
      <a href="/archives"><div><strong>187</strong><br>文章</div></a>
      <a href="/categories"><div><strong>7</strong><br>分类</div></a>
      <a href="/tags"><div><strong>64</strong><br>标签</div></a>
    </div>
    <ul class="blog-link">
     
          <a href="/" title="Home">
            <li>主页</li>
          </a>
        
          <a href="/archives" title="Archives">
            <li>归档</li>
          </a>
        
          <a href="/categories" title="Categories">
            <li>分类</li>
          </a>
        
          <a href="/tags" title="Tags">
            <li>标签</li>
          </a>
        
          <a href="/plans" title="足迹">
            <li>足迹</li>
          </a>
        
          <a href="/about" title="About">
            <li>关于</li>
          </a>
        
          <a href="/works/leetcode-binarytree-edit/" title="LC 二叉树">
            <li>LC 二叉树</li>
          </a>
        
    </ul>
  </div>
</div>

        <section id="main"><article id="post-《UNIX-环境高级编程》笔记0x4：标准I-O" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/23/《UNIX-环境高级编程》笔记0x4：标准I-O/" class="article-date">
  <time class="post-time" datetime="2019-08-23T06:01:17.000Z" itemprop="datePublished">
    <span class="post-month">8月</span><br/>
    <span class="post-day">23</span>
  </time>
</a>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      《UNIX 环境高级编程》笔记0x4：标准I/O库
    </h1>
  

        <div>
          
  <div class="article-category">
    <a class="article-category-link" href="/categories/UNIX-环境高级编程/">UNIX 环境高级编程</a>
  </div>

          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>此为第五章笔记</p>
<a id="more"></a>
<hr>
<h2 id="流和FILE对象"><a href="#流和FILE对象" class="headerlink" title="流和FILE对象"></a>流和FILE对象</h2><p>在未定向的流上使用一个<strong>多字节I/O</strong>函数，则该流的定向设置为 <code>宽定向</code>，而使用一个<strong>单字节I/O</strong>函数，则被称为 <code>字节定向</code>。</p>
<p><code>freopen</code> 函数可清除一个流的走向， <code>fwide</code> 函数可用于设置流的走向。后者的函数原型如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;wchar.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fwide</span><span class="params">(FILE *fp, <span class="keyword">int</span> mode)</span></span>;</span><br></pre></td></tr></table></figure>
<p>mode有以下几种情况：</p>
<ul>
<li>负，字节定向</li>
<li>正，宽定向</li>
<li>0，不设置流走向，返回标识该流定向的值</li>
</ul>
<p>这里， <code>fwide</code> 不改变已定向流的定向，且无错误值返回。所以，需要事先将 <code>errno</code> 清除，从 <code>fwide</code> 返回时检查 <code>errno</code> 的值。</p>
<p>使用 <code>fopen</code> 函数可获得一个指向 <code>FILE</code> 对象（类型为 <code>FILE*</code>，文件指针）的指针，包含：</p>
<ul>
<li>实际I/O的文件描述符</li>
<li>指向用于该流缓冲区的指针</li>
<li>缓冲区的长度</li>
<li>当前缓冲区中的字符数以及出错标志</li>
</ul>
<p>进程中预定义了三个流：</p>
<ul>
<li>标准输入 <code>STDIN_FILENO</code></li>
<li>标准输出 <code>STDOUT_FILENO</code></li>
<li>标准错误 <code>STDERR_FILENO</code></li>
</ul>
<hr>
<h2 id="缓冲"><a href="#缓冲" class="headerlink" title="缓冲"></a>缓冲</h2><h3 id="类型"><a href="#类型" class="headerlink" title="类型"></a>类型</h3><p>缓冲的目的是尽可能减少使用 <code>read</code> 和 <code>write</code> 调用的次数。一下的几种缓冲类型：</p>
<ul>
<li>全缓冲</li>
<li>行缓冲</li>
<li>不带缓冲</li>
</ul>
<p><strong>全缓冲</strong>在填满标准I/O缓冲区后才进行实际I/O操作。一般对<strong>文件</strong>进行全缓冲。</p>
<p><strong>冲洗（flush）</strong> 说明标准I/O缓冲区的写操作。可由标准I/O例程自动冲洗，或调用 <code>fflush</code> 函数冲洗一个流，将缓冲区中的内容写到磁盘上。</p>
<p><strong>行缓冲</strong>当在输入和输出中遇到换行符时，进行I/O操作。一般用于终端。每一行的缓冲区的长度是固定的，所以只要填满了缓冲区，即使没有写一个换行符，也会进行I/O操作。</p>
<p><strong>不带缓冲</strong>常用于标准错误流 <code>strerr</code> 的输出。</p>
<p>很多系统默认使用下列类型的缓冲：</p>
<ul>
<li>标准错误是不带缓冲的</li>
<li>若是指向终端设备的流，则是行缓冲的；否则是全缓冲</li>
</ul>
<hr>
<h3 id="函数设置"><a href="#函数设置" class="headerlink" title="函数设置"></a>函数设置</h3><p>可以使用如下函数对缓冲的类型进行设置</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setbuf</span><span class="params">(FILE *<span class="keyword">restrict</span> fp, <span class="keyword">char</span> *<span class="keyword">restrict</span> buf)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">setvbuf</span><span class="params">(FILE *<span class="keyword">restrict</span> fp, <span class="keyword">char</span> *<span class="keyword">restrict</span> buf, <span class="keyword">int</span> mode, <span class="keyword">size_t</span> size)</span></span>;</span><br></pre></td></tr></table></figure>
<p><code>setbuf</code> 用于开启或关闭缓冲机制，开启缓冲则 <code>buf</code> 的大小为 <code>BUFSIZ</code>（定义在 <code>&lt;stdio.h&gt;</code> 中），否则将其设为 <code>NULL</code>。</p>
<p><code>setvbuf</code> 函数可以通过 <code>size</code> 自由设置缓冲区大小（若 <code>buf</code> 为 <code>NULL</code> 则系统自动分配长度为 <code>BUFSIZ</code> 长度的缓冲区），使用 <code>mode</code> 参数精准设置其类型：</p>
<ul>
<li><code>_IOFBF</code> 全缓冲</li>
<li><code>_IOLBF</code> 行缓冲</li>
<li><code>_IONBF</code> 不带缓冲</li>
</ul>
<p>GUN C 函数库使用 <code>stat</code> 的 <code>st_blksize</code> 所指定的值来设置最佳I/O缓冲区长度</p>
<p>使用函数 <code>fflush</code> 强制冲洗一个流，如下。若 <code>fp</code> 为 <code>NULL</code>，则将导致所有输出流被冲洗</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fflush</span><span class="params">(FILE *fp)</span></span>;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="打开和关闭流"><a href="#打开和关闭流" class="headerlink" title="打开和关闭流"></a>打开和关闭流</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">FILE *<span class="title">fopen</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">restrict</span> pathname, <span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">restrict</span> type)</span></span>;</span><br><span class="line"><span class="function">FILE *<span class="title">freopen</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">restrict</span> pathname, <span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">restrict</span> type, FILE *<span class="keyword">restrict</span> fp)</span></span>;</span><br><span class="line"><span class="function">FILE *<span class="title">fdopen</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">const</span> <span class="keyword">char</span> *type)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>fopen</code> 函数为打开一个文件</li>
<li><code>freopen</code> 函数为在一个指定流上打开一个指定文件。其中，若那个流已经被开启，则会先将其关闭；若已经定向，则会被清楚定向。一般用于将指定文件打开为那三个预定的流。</li>
<li><code>fdopen</code> 函数为取一个已有的文件描述符（通过 <code>open</code>、 <code>dup</code>、 <code>dup2</code>、 <code>fcntl</code>、 <code>pipe</code>、<code>socket</code>、 <code>socketpair</code> 或 <code>accept</code> ）。一般用于创建管道和网络通信函数返回的描述符。</li>
</ul>
<p>参数 <code>type</code> 的可选项</p>
<p><img src="image1.png" alt="image1.png"></p>
<p>使用如下函数关闭一个流</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fclose</span><span class="params">(FILE* fp)</span></span>;</span><br></pre></td></tr></table></figure>
<p>文件在关闭之前，冲洗缓冲中的输出数据，丢弃任何输入数据。若缓冲区为标准库自动分配，则其会被释放。</p>
<p>进程正常终止时（直接调用 <code>exit</code> 函数，或从 <code>main</code> 函数返回），则所有带未写缓冲数据的标志I/O流都会被冲洗，所有打开的标志I/O流都被关闭。</p>
<hr>
<h2 id="读和写流"><a href="#读和写流" class="headerlink" title="读和写流"></a>读和写流</h2><h3 id="每次一个字符"><a href="#每次一个字符" class="headerlink" title="每次一个字符"></a>每次一个字符</h3><h4 id="输入函数"><a href="#输入函数" class="headerlink" title="输入函数"></a>输入函数</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getc</span><span class="params">(FILE *fp)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fgetc</span><span class="params">(FILE *fp)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getchar</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p><code>getc</code> 可被实现为宏，所以其参数不能有副作用，而 <code>fgetc</code> 肯定为函数，但是其调用时间要长于 <code>getc</code> （宏）</p>
<p><code>getchar</code> 等同于 <code>getc(stdin)</code></p>
<p>他们返回时将 <code>unsigned char</code> 转换为 <code>int</code>。这样就可以返回所有可能的字符值再加上一个<strong>已出错</strong>或<strong>到达文件末尾</strong>的指示值。但是这两者的值相同，所有就需要 <code>ferror</code> 或 <code>feof</code> 函数来区分。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ferror</span><span class="params">(FILE *fp)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">feof</span><span class="params">(FILE *fp)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clearerr</span><span class="params">(FILE *fp)</span></span>;</span><br></pre></td></tr></table></figure>
<p><code>FILE</code> 对象维护两个标志：</p>
<ul>
<li>出错标志</li>
<li>文件结束标志</li>
</ul>
<p>可以使用上面第三个函数 <code>clearerr</code> 清除</p>
<p>读取数据后，可以调用 <code>ungetc</code> 函数将数据压会流中，和读出字符的<strong>顺序相反</strong>。不能回送 <code>EOF</code>。</p>
<p>下列程序的作用是：读取文件，同时将标志输出和另一个文件相关联，调用函数 <code>printf</code> 变成了写文件操作</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;apue.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// 将 stdout 和文件相关联</span></span><br><span class="line">  FILE *fp_log = freopen(<span class="string">"log.txt"</span>, <span class="string">"w+"</span>, <span class="built_in">stdout</span>);</span><br><span class="line">  FILE *fp = fopen(<span class="string">"ls_test.c"</span>, <span class="string">"r"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">int</span> c = fgetc(fp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (feof(fp) || ferror(fp)) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%c"</span>, c);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fflush(fp_log);</span><br><span class="line">  fclose(fp_log);</span><br><span class="line">  fclose(fp);</span><br><span class="line">  <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行此程序，会发现 <code>log.txt</code> 和 <code>ls_test.c</code> 的内容相同</p>
<hr>
<h4 id="输出函数"><a href="#输出函数" class="headerlink" title="输出函数"></a>输出函数</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">putc</span><span class="params">(<span class="keyword">int</span> c, FILE *fp)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fputc</span><span class="params">(<span class="keyword">int</span> c, FILE *fp)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">putchar</span><span class="params">(<span class="keyword">int</span> c)</span></span>;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="每次一行"><a href="#每次一行" class="headerlink" title="每次一行"></a>每次一行</h3><h4 id="读取"><a href="#读取" class="headerlink" title="读取"></a>读取</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">fgets</span><span class="params">(<span class="keyword">char</span> *<span class="keyword">restrict</span> buf, <span class="keyword">int</span> n, FILE *<span class="keyword">restrict</span> fp)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">gets</span><span class="params">(<span class="keyword">char</span> *buf)</span></span></span><br></pre></td></tr></table></figure>
<p>第二个函数不建议使用，会造成缓冲区溢出。</p>
<p>指定长度为 <code>n</code>，但是读取不超过 <code>n-1</code>，以 <code>null</code> 结尾。</p>
<hr>
<h4 id="写出"><a href="#写出" class="headerlink" title="写出"></a>写出</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fputs</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">restrict</span> str, FILE *<span class="keyword">restrict</span> fp)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">puts</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str)</span></span>;</span><br></pre></td></tr></table></figure>
<p>将一个以 <code>null</code> 字节终止的字符串写到指定的流中。</p>
<hr>
<h3 id="二进制"><a href="#二进制" class="headerlink" title="二进制"></a>二进制</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> fread(<span class="keyword">void</span> *<span class="keyword">restrict</span> ptr, <span class="keyword">size_t</span> size, <span class="keyword">size_t</span> nobj, FILE *<span class="keyword">restrict</span> fp);</span><br><span class="line"><span class="keyword">size_t</span> fwrite(<span class="keyword">const</span> <span class="keyword">void</span> *<span class="keyword">restrict</span> ptr, <span class="keyword">size_t</span> size, <span class="keyword">size_t</span> nobj, FILE *<span class="keyword">restrict</span> fp);</span><br></pre></td></tr></table></figure>
<p>不同编译程序以及系统间<strong>对齐的方式不同</strong>，以及<strong>多字节整数和浮点数的二进制格式不同</strong>，所以可以会产生误差。</p>
<hr>
<h2 id="定位"><a href="#定位" class="headerlink" title="定位"></a>定位</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">ftell</span><span class="params">(FILE *fp)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fseek</span><span class="params">(FILE *fp, <span class="keyword">long</span> offset, <span class="keyword">int</span> whence)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rewind</span><span class="params">(FILE *fp)</span></span>;</span><br></pre></td></tr></table></figure>
<p>其中， <code>whence</code> 为起始位置，同 <code>lseek</code> 参数相同，<code>SEEK_SET</code> 为起始位置、 <code>SEEK_CUR</code> 为当前文件位置、 <code>SEEK_END</code> 为从文件的尾端。</p>
<hr>
<h2 id="格式化I-O"><a href="#格式化I-O" class="headerlink" title="格式化I/O"></a>格式化I/O</h2><p>禁止死记硬背，不会的时候来查文档 PDFp147</p>
<hr>
<h2 id="临时文件"><a href="#临时文件" class="headerlink" title="临时文件"></a>临时文件</h2><h3 id="有缺陷的方案"><a href="#有缺陷的方案" class="headerlink" title="有缺陷的方案"></a>有缺陷的方案</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">tmpnam</span><span class="params">(<span class="keyword">char</span> *ptr)</span></span>;</span><br><span class="line"><span class="function">FILE *<span class="title">tmpfile</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p><code>tmpnam</code> 产生一个与现有文件名不同的有效路径名称，最多调用次数为 <code>TMP_MAX</code>（定义于 <code>&lt;stdio.h&gt;</code>）。其只有唯一的静态数据区，内存调用都会覆盖原有数据。传入参数为 <code>NULL</code>，则返回指向那个数据区的指针。路径最大长度为 <code>L_tmpnam</code>（定义于 <code>&lt;stdio.h&gt;</code>）。</p>
<p><code>tmpfile</code> 会创建一个临时二进制文件（wb+）。关闭文件或程序结束后自动删除。通过 <code>tmpnam</code> 生成一个路径，然后创建文件，立刻 <code>unlink</code>。立刻删除，但是在内存中依然有。</p>
<p>存在的问题是，在获取随机文件名和创建文件间存在一个时间窗口，另一个进程可以用同样的名字创建文件。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;apue.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> name[L_tmpnam], line[MAXLINE];</span><br><span class="line">  FILE *fp;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// generate one name</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"%s\n"</span>, tmpnam(<span class="literal">NULL</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// generate another name</span></span><br><span class="line">  tmpnam(name);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"%s\n"</span>, name);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// create temp file</span></span><br><span class="line">  <span class="keyword">if</span> ((fp = tmpfile()) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    err_sys(<span class="string">"tmpfile error"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">fputs</span>(<span class="string">"one line of output\n"</span>, fp);</span><br><span class="line">  rewind(fp);</span><br><span class="line">  <span class="keyword">if</span> (fgets(line, <span class="keyword">sizeof</span>(line), fp) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    err_sys(<span class="string">"fgets error"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">fputs</span>(line, <span class="built_in">stdout</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/tmp/fileeaj3A9</span><br><span class="line">/tmp/fileUssMkl</span><br><span class="line">one line of output</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="更好的方案"><a href="#更好的方案" class="headerlink" title="更好的方案"></a>更好的方案</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回指向目录名的指针</span></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">mkdtemp</span><span class="params">(<span class="keyword">char</span> *<span class="keyword">template</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回文件描述符，不会立刻删除，需要手动unlink</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mkstemp</span><span class="params">(<span class="keyword">char</span> *<span class="keyword">template</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p>使用的模板是 <code>....XXXXXX</code>，需要对最后6位进行设置。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;apue.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">make_temp</span><span class="params">(<span class="keyword">char</span> *<span class="keyword">template</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> good_tempalte[] = <span class="string">"/tmp/dirXXXXXX"</span>; <span class="comment">/* right way */</span></span><br><span class="line">  <span class="keyword">char</span> *bad_template = <span class="string">"/tmp/dirXXXXXX"</span>;   <span class="comment">/* bad way */</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"first ...\n"</span>);</span><br><span class="line">  make_temp(good_tempalte);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"second ...\n"</span>);</span><br><span class="line">  make_temp(bad_template);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">make_temp</span><span class="params">(<span class="keyword">char</span> *<span class="keyword">template</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> fd;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">sbuf</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((fd = mkstemp(<span class="keyword">template</span>)) &lt; <span class="number">0</span>)</span><br><span class="line">    err_sys(<span class="string">"can't create temp file"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"temp name = %s\n"</span>, <span class="keyword">template</span>);</span><br><span class="line">  close(fd);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (stat(<span class="keyword">template</span>, &amp;sbuf) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (errno == ENOENT)</span><br><span class="line">      <span class="comment">// printf("file doesn't exist\n");</span></span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"%s\n"</span>, strerror(errno));</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      err_sys(<span class="string">"stat failed"</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"file exists\n"</span>);</span><br><span class="line">      unlink(<span class="keyword">template</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第二段程序出现了段错误的问题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">first ...</span><br><span class="line">temp name = /tmp/dirxqkUS1</span><br><span class="line">file exists</span><br><span class="line">second ...</span><br><span class="line">[1]    4404 segmentation fault (core dumped)  ./a.out</span><br></pre></td></tr></table></figure>
<p><code>good_tempalte</code> 数值是在栈上分配的。而 <code>bad_template</code> 使用的指针，只有指针自身是停留在栈上，编译器将字符串存放在可执行文件的只读段，所以无法修改，产生了段错误。</p>
<hr>
<h2 id="内存流"><a href="#内存流" class="headerlink" title="内存流"></a>内存流</h2><p>使用下列函数可以自定义 <code>FILE</code> 指向的buffer</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FILE *<span class="title">fmemopen</span><span class="params">(<span class="keyword">void</span> *<span class="keyword">restrict</span> buf, <span class="keyword">size_t</span> size, <span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">restrict</span> type)</span></span>;</span><br></pre></td></tr></table></figure>
<p>示例用法如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;apue.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BSZ 48</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  FILE *fp;</span><br><span class="line">  <span class="keyword">char</span> buf[BSZ];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化自定义缓冲区</span></span><br><span class="line">  <span class="built_in">memset</span>(buf, <span class="string">'a'</span>, BSZ<span class="number">-2</span>);</span><br><span class="line">  buf[BSZ<span class="number">-2</span>] = <span class="string">'\0'</span>;</span><br><span class="line">  buf[BSZ<span class="number">-1</span>] = <span class="string">'X'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 使用内存流</span></span><br><span class="line">  <span class="keyword">if</span> ((fp = fmemopen(buf, BSZ, <span class="string">"w+"</span>)) == <span class="literal">NULL</span>) <span class="comment">// 打开后，buf的第一个位置被置为NULL</span></span><br><span class="line">    err_sys(<span class="string">"fmemopen failed"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"initial buffer contents: %s\n"</span>, buf);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(fp, <span class="string">"hello world"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"before flush: %s\n"</span>, buf);          <span class="comment">// 此时还没有将数据写入到buf中</span></span><br><span class="line">  fflush(fp);                                 <span class="comment">// flush，同时追加NULL</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"after fflush: %s\n"</span>, buf);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"len of string in buf = %ld\n"</span>, (<span class="keyword">long</span>)<span class="built_in">strlen</span>(buf));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(buf, <span class="string">'b'</span>, BSZ<span class="number">-2</span>);</span><br><span class="line">  buf[BSZ<span class="number">-2</span>] = <span class="string">'\0'</span>;</span><br><span class="line">  buf[BSZ<span class="number">-1</span>] = <span class="string">'X'</span>;</span><br><span class="line">  <span class="built_in">fprintf</span>(fp, <span class="string">"hello world"</span>);</span><br><span class="line">  fseek(fp, <span class="number">0</span>, SEEK_SET); <span class="comment">// fseek会引起flush，idx从12开始，然后再将指针置于起始位置</span></span><br><span class="line">  fflush(fp);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"after fseek: %s\n"</span>, buf);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"len of string in buf = %ld\n"</span>, (<span class="keyword">long</span>)<span class="built_in">strlen</span>(buf));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(buf, <span class="string">'c'</span>, BSZ<span class="number">-2</span>);</span><br><span class="line">  buf[BSZ<span class="number">-2</span>] = <span class="string">'\0'</span>;</span><br><span class="line">  buf[BSZ<span class="number">-1</span>] = <span class="string">'X'</span>;</span><br><span class="line">  <span class="built_in">fprintf</span>(fp, <span class="string">"hello world"</span>);</span><br><span class="line">  fclose(fp); <span class="comment">// 引起flush，由于指针置为开始，所以从头开始</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"after fclose: %s\n"</span>, buf);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"len of string in buf = %ld\n"</span>, (<span class="keyword">long</span>)<span class="built_in">strlen</span>(buf));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">initial buffer contents:</span><br><span class="line">before flush:</span><br><span class="line">after fflush: hello world</span><br><span class="line">len of string in buf = 11</span><br><span class="line">after fseek: bbbbbbbbbbbhello world</span><br><span class="line">len of string in buf = 22</span><br><span class="line">after fclose: hello worldccccccccccccccccccccccccccccccccccc</span><br><span class="line">len of string in buf = 46</span><br></pre></td></tr></table></figure>
<p>创建内存流的其他两个函数分别是面向<strong>字节</strong>的 <code>open_memstream</code> 和面向<strong>宽字节</strong>的 <code>open_wmemstream</code>。它们创建的流只能写打开，且不能指定自己的缓冲区，需要自行释放缓冲区，缓冲区大小会自动增加。<strong>非常适合用来创建字符串，仅在内存中操作，性能很好</strong>。测试函数如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;apue.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  FILE *out;</span><br><span class="line">  <span class="keyword">size_t</span> size;  <span class="comment">// 缓冲区的大小</span></span><br><span class="line">  <span class="keyword">char</span> *ptr;    <span class="comment">// 指向buf的指针</span></span><br><span class="line"></span><br><span class="line">  out = open_memstream(&amp;ptr, &amp;size);</span><br><span class="line">  size = <span class="built_in">fprintf</span>(out, <span class="string">"%d "</span>, <span class="number">10</span>);</span><br><span class="line">  size = <span class="built_in">fprintf</span>(out, <span class="string">"%s "</span>, <span class="string">"hello world"</span>);</span><br><span class="line"></span><br><span class="line">  fflush(out);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"size: %d\tcontent: %s\n"</span>, (<span class="keyword">int</span>)size, ptr);</span><br><span class="line"></span><br><span class="line">  fclose(out);</span><br><span class="line">  <span class="built_in">free</span>(ptr);  <span class="comment">// 自行释放buf</span></span><br><span class="line">  <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进行调试，查看 <code>ptr</code> 所指向的buf的变化：</p>
<p><img src="image2.png" alt="image2.png"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.schwarzeni.com/2019/08/23/《UNIX-环境高级编程》笔记0x4：标准I-O/" data-id="ckvoldzor007jgfvge93zjig6" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/操作系统/">操作系统</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/08/23/《UNIX-环境高级编程》笔记0x5：系统数据文件和信息/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          《UNIX 环境高级编程》笔记0x5：系统数据文件和信息
        
      </div>
    </a>
  
  
    <a href="/2019/08/22/《UNIX-环境高级编程》笔记0x3：文件和目录/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">《UNIX 环境高级编程》笔记0x3：文件和目录</div>
    </a>
  
</nav>

  
  
    
    <script src="/third-party/gittalk/gittalk.min.js"></script>
    <script src="/third-party/gittalk/md5.min.js"></script>
    <div id="gitalk-container"></div>
    <script>
    var gitalk = new Gitalk({
      clientID: '18bc624fc12c1f06fdd3',
      clientSecret: '3f7d7806ef813726f3f930b554f3ed5a12af9a25',
      repo: 'schwarzeni.comment.github.io',
      owner: 'schwarzeni',
      admin: ['schwarzeni'],
      id: md5(location.pathname),      // Ensure uniqueness and length less than 50
      distractionFreeMode: false  // Facebook-like distraction free mode
    })

    gitalk.render('gitalk-container')
    </script>
    
</article>


</section>
        
          <aside id="sidebar">
  
    <div class="widget-wrap">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <h1 class="blog-title">Schwarzeni&#39;s blog</h1>
    <h2 class="blog-subtitle">Welcome to my secret garden</h2>
    <ul class="blog-link">
     
          <a href="/" title="Home">
            <li>主页</li>
          </a>
        
          <a href="/archives" title="Archives">
            <li>归档</li>
          </a>
        
          <a href="/categories" title="Categories">
            <li>分类</li>
          </a>
        
          <a href="/tags" title="Tags">
            <li>标签</li>
          </a>
        
          <a href="/plans" title="足迹">
            <li>足迹</li>
          </a>
        
          <a href="/about" title="About">
            <li>关于</li>
          </a>
        
          <a href="/works/leetcode-binarytree-edit/" title="LC 二叉树">
            <li>LC 二叉树</li>
          </a>
        
    </ul>
  </div>
</div>

  
    <div class="widget-wrap">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <img class="avatar" src="/images/avatar.png">
    <h2 class="author">Schwarzeni</h2>
    <h3 class="description"></h3>
    <div class="count-box">
      <a href="/archives"><div><strong>187</strong><br>文章</div></a>
      <a href="/categories"><div><strong>7</strong><br>分类</div></a>
      <a href="/tags"><div><strong>64</strong><br>标签</div></a>
    </div>



    <div class="social-link">
      
        <a class="hvr-bounce-in" href="http://github.com/schwarzeni" target="_blank" title="Github">
          Github
        </a>
      
        <a class="hvr-bounce-in" href="https://space.bilibili.com/21884414" target="_blank" title="Bilibili">
          Bilibili
        </a>
      
        <a class="hvr-bounce-in" href="https://music.163.com/#/user/home?id=259848766" target="_blank" title="网易云音乐">
          网易云音乐
        </a>
      
        <a class="hvr-bounce-in" href="https://bangumi.tv/user/547268" target="_blank" title="Bangumi">
          Bangumi
        </a>
      
    </div>

    <div class="friend-link">
      <h2>友情链接</h2>
      
        <a class="hvr-bounce-in" href="https://blog.csdn.net/nzyalj" target="_blank" title="旧博客">
          旧博客
        </a>
      
        <a class="hvr-bounce-in" href="https://zybtree.github.io/" target="_blank" title="斌哥哥">
          斌哥哥
        </a>
      
        <a class="hvr-bounce-in" href="https://www.zhoujianguo.ltd/" target="_blank" title="国哥哥">
          国哥哥
        </a>
      
        <a class="hvr-bounce-in" href="https://blog.yanqing-wu.com/" target="_blank" title="pwyq">
          pwyq
        </a>
      
        <a class="hvr-bounce-in" href="https://qwqaq.com/" target="_blank" title="QWQAQ">
          QWQAQ
        </a>
      
        <a class="hvr-bounce-in" href="https://geektutu.com/" target="_blank" title="极客兔兔">
          极客兔兔
        </a>
      
        <a class="hvr-bounce-in" href="https://hj24.life/" target="_blank" title="hj24">
          hj24
        </a>
      
    </div>
  </div>
</div>

  
</aside>

        
      </div>
      
    </div>
    

<script src="/third-party/wow/jquery.min.js"></script>
<script src="/third-party/wow/wow.min.js"></script>
<script>
new WOW().init();
</script>
<!-- 修改浮动小按钮 -->
<script src="/third-party/powerful-sidebar-util/lib/axios.min.js"></script>
<script src="/third-party/powerful-sidebar-util/powerful-sidebar-util.js"></script>


  <link rel="stylesheet" href="/plugin/fancybox/jquery.fancybox.css">
  <script src="/plugin/fancybox/jquery.fancybox.pack.js"></script>



  <link rel="stylesheet" href="/plugin/galmenu/GalMenu.css">
  <script src="/plugin/galmenu/GalMenu.js"></script>
  <div class="GalMenu GalDropDown">
      <div class="circle" id="gal">
        <div class="ring">
          
            <a href="/" title="" class="menuItem">首页</a>
          
            <a href="/tags" title="" class="menuItem">标签</a>
          
            <a href="/categories" title="" class="menuItem">分类</a>
          
            <a href="/archives" title="" class="menuItem">归档</a>
          
            <a href="/about" title="" class="menuItem">关于</a>
          
        </div>
        
          <audio id="audio" src="#"></audio>
        
      </div> 
</div>
<div id="overlay" style="opacity: 1; cursor: pointer;"></div>
  <script type="text/javascript">var items = document.querySelectorAll('.menuItem');
    for (var i = 0,
    l = items.length; i < l; i++) {
      items[i].style.left = (50 - 35 * Math.cos( - 0.5 * Math.PI - 2 * (1 / l) * i * Math.PI)).toFixed(4) + "%";
      items[i].style.top = (50 + 35 * Math.sin( - 0.5 * Math.PI - 2 * (1 / l) * i * Math.PI)).toFixed(4) + "%"
    }</script>
<script type="text/javascript">
  $(document).ready(function() {
    $('body').GalMenu({
      'menu': 'GalDropDown'
    })
  });
</script>

  <!-- <section class="hidden-xs"> 
  <ul class="cb-slideshow"> 
    <li><span>我</span></li> 
    <li><span>永</span></li> 
    <li><span>远</span></li> 
    <li><span>喜</span></li> 
    <li><span>欢</span></li> 
    <li><span>02</span></li> 
  </ul>
</section> -->

<script src="/js/script.js"></script>


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-155992609-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-155992609-1');
</script>


<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>


  </div>
	<script>
	/*
		var host = "localhost:4000"
		var mainPageUrl = "http://" + host +"/blog";
		var $folder = document.getElementById('main_folder');
		var $main = document.getElementById('wrap');
		var $container = document.getElementById('container');
		if ( document.referrer.includes(host) || !(window.location.href === mainPageUrl || window.location.href === mainPageUrl + "/")) {
			$folder.style.display = "none";	
		} else {
			$main.style.display = "none";
		}
		$container.style = "";
		document.getElementById('go_to_main_page').onclick = function() {
			$folder.style.display = "none";	
			$main.style = "";
		}
*/
	</script>
</body>
</html>
