<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>kafka raft 模式无法选主问题介绍及止损方式研究 | Schwarzeni&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="版本为 3.9.1 ，处理方式比较 trick，目前仅在无流量的集群中验证过。">
<meta name="keywords" content="kafka">
<meta property="og:type" content="article">
<meta property="og:title" content="kafka raft 模式无法选主问题介绍及止损方式研究">
<meta property="og:url" content="http://blog.schwarzeni.com/2025/12/20/kafka-raft-模式无法选主问题介绍及止损方式研究/index.html">
<meta property="og:site_name" content="Schwarzeni&#39;s blog">
<meta property="og:description" content="版本为 3.9.1 ，处理方式比较 trick，目前仅在无流量的集群中验证过。">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://blog.schwarzeni.com/2025/12/20/kafka-raft-模式无法选主问题介绍及止损方式研究/Pasted%20image%2020251220222816.png">
<meta property="og:image" content="http://blog.schwarzeni.com/2025/12/20/kafka-raft-模式无法选主问题介绍及止损方式研究/Pasted%20image%2020251220222824.png">
<meta property="og:image" content="http://blog.schwarzeni.com/2025/12/20/kafka-raft-模式无法选主问题介绍及止损方式研究/Pasted%20image%2020251220222841.png">
<meta property="og:image" content="http://blog.schwarzeni.com/2025/12/20/kafka-raft-模式无法选主问题介绍及止损方式研究/Pasted%20image%2020251220222903.png">
<meta property="og:image" content="http://blog.schwarzeni.com/2025/12/20/kafka-raft-模式无法选主问题介绍及止损方式研究/Pasted%20image%2020251220224932.png">
<meta property="og:image" content="http://blog.schwarzeni.com/2025/12/20/kafka-raft-模式无法选主问题介绍及止损方式研究/Pasted%20image%2020251220224918.png">
<meta property="og:updated_time" content="2025-12-20T15:29:24.994Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="kafka raft 模式无法选主问题介绍及止损方式研究">
<meta name="twitter:description" content="版本为 3.9.1 ，处理方式比较 trick，目前仅在无流量的集群中验证过。">
<meta name="twitter:image" content="http://blog.schwarzeni.com/2025/12/20/kafka-raft-模式无法选主问题介绍及止损方式研究/Pasted%20image%2020251220222816.png">
  
    <link rel="alternate" href="/atom.xml" title="Schwarzeni&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/images/favicon.ico">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  <!-- <link rel="stylesheet" href="/plugin/bganimation/bg.css"> -->
  

  <link rel="stylesheet" href="/third-party/powerful-sidebar-util/powerful-sidebar-util.css">

  <!-- add plugin for gittalk -->
  <link rel="stylesheet" href="/third-party/gittalk/gittalk.css" type="text/css">
</head>

<body>
	<style>
		.main-folder {
			width: 100%;
			height: 100%;
			position: absolute;
			background-image: url("/blog/images/folder-pic.jpg") ;
			background-size: 100%;
			z-index: 100;
	
		}
	</style>
			<!--<div id="container" style="display: none"> -->
		<!--	<div class="main-folder" id="main_folder"> -->
		<!--	</div> -->
	<div id="container">
    <div id="wrap" style="min-height:100%">
			<div class="outer">
        <div class="widget-wrap mobile-header">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <img class="avatar" src="/images/avatar.png">
    <h2 class="author">Schwarzeni</h2>
    <h3 class="description"></h3>
    <div class="count-box">
      <a href="/archives"><div><strong>213</strong><br>文章</div></a>
      <a href="/categories"><div><strong>7</strong><br>分类</div></a>
      <a href="/tags"><div><strong>72</strong><br>标签</div></a>
    </div>
    <ul class="blog-link">
     
          <a href="/" title="Home">
            <li>主页</li>
          </a>
        
          <a href="/archives" title="Archives">
            <li>归档</li>
          </a>
        
          <a href="/categories" title="Categories">
            <li>分类</li>
          </a>
        
          <a href="/tags" title="Tags">
            <li>标签</li>
          </a>
        
          <a href="/plans" title="足迹">
            <li>足迹</li>
          </a>
        
          <a href="/about" title="About">
            <li>关于</li>
          </a>
        
          <a href="/works/leetcode-binarytree-edit/" title="LC 二叉树">
            <li>LC 二叉树</li>
          </a>
        
    </ul>
  </div>
</div>

        <section id="main"><article id="post-kafka-raft-模式无法选主问题介绍及止损方式研究" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2025/12/20/kafka-raft-模式无法选主问题介绍及止损方式研究/" class="article-date">
  <time class="post-time" datetime="2025-12-20T15:16:33.000Z" itemprop="datePublished">
    <span class="post-month">12月</span><br/>
    <span class="post-day">20</span>
  </time>
</a>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      kafka raft 模式无法选主问题介绍及止损方式研究
    </h1>
  

        <div>
          
  <div class="article-category">
    <a class="article-category-link" href="/categories/技术/">技术</a>
  </div>

          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>版本为 3.9.1 ，处理方式比较 trick，目前仅在无流量的集群中验证过。</p>
<a id="more"></a>
<h1 id="raft-voter-列表的维护"><a href="#raft-voter-列表的维护" class="headerlink" title="raft voter 列表的维护"></a>raft voter 列表的维护</h1><p>在引入了<a href="https://blog.schwarzeni.com/2025/08/13/KIP-853-%E5%8A%9F%E8%83%BD%E9%AA%8C%E8%AF%81-kraft-%E6%A8%A1%E5%BC%8F%E4%B8%8B%E5%8A%A8%E6%80%81%E5%8F%98%E6%9B%B4-kafka-controller-voter-%E5%88%97%E8%A1%A8/">KIP-853 功能验证</a>机制后，对于 raft voter 节点的列表信息，是存储在 raft log 中的，无法通过外部的配置文件进行干预（或者可能是我没找到对应的地方）。raft log 中存储的信息样例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 读取 __cluster_metadata-0 下最新的 checkpoint</span><br><span class="line">nzy@yq01-build-rd2.yq01.baidu.com /home/disk3/nizhenyang/dev/kafka_new_ver_search/std_hbe_err/metadata_bak_20251211_broker_2</span><br><span class="line">$ ../../kafka/new_cluster_demo_v3/c0/bin/kafka-metadata-shell.sh --snapshot __cluster_metadata-0/00000000000024473975-0000012041.checkpoint</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt; tree image/cluster/controllers</span><br><span class="line">0:</span><br><span class="line">  ControllerRegistration(id=0, incarnationId=Es2ouwWpQ1CwAP5aIr70iA, zkMigrationReady=false, listeners=[Endpoint(listenerName=&apos;CONTROLLER&apos;, securityProtocol=PLAINTEXT, host=&apos;bddwd-ps-beehive-agent189556.bddwd.baidu.com&apos;, port=9093)], supportedFeatures=&#123;kraft.version: 0-1, metadata.version: 1-21&#125;)</span><br><span class="line">1:</span><br><span class="line">  ControllerRegistration(id=1, incarnationId=v_6Dqtc_TDeaPCQtDO05rw, zkMigrationReady=false, listeners=[Endpoint(listenerName=&apos;CONTROLLER&apos;, securityProtocol=PLAINTEXT, host=&apos;bddwd-ps-beehive-agent186208.bddwd.baidu.com&apos;, port=9093)], supportedFeatures=&#123;kraft.version: 0-1, metadata.version: 1-21&#125;)</span><br><span class="line">2:</span><br><span class="line">  ControllerRegistration(id=2, incarnationId=Q-DrAW0CQ0adVzdjfQZWNA, zkMigrationReady=false, listeners=[Endpoint(listenerName=&apos;CONTROLLER&apos;, securityProtocol=PLAINTEXT, host=&apos;bddwd-ps-beehive-agent186248.bddwd.baidu.com&apos;, port=9093)], supportedFeatures=&#123;kraft.version: 0-1, metadata.version: 1-21&#125;)</span><br><span class="line">3:</span><br><span class="line">  ControllerRegistration(id=3, incarnationId=GQSZLOqUR8enDsWCuTrN9g, zkMigrationReady=false, listeners=[Endpoint(listenerName=&apos;CONTROLLER&apos;, securityProtocol=PLAINTEXT, host=&apos;bddwd-ps-beehive-agent188990.bddwd.baidu.com&apos;, port=9093)], supportedFeatures=&#123;kraft.version: 0-1, metadata.version: 1-21&#125;)</span><br><span class="line">4:</span><br><span class="line">  ControllerRegistration(id=4, incarnationId=exm0pjp8Tlqr_Egqw1vYZQ, zkMigrationReady=false, listeners=[Endpoint(listenerName=&apos;CONTROLLER&apos;, securityProtocol=PLAINTEXT, host=&apos;bddwd-ps-beehive-agent188790.bddwd.baidu.com&apos;, port=9093)], supportedFeatures=&#123;kraft.version: 0-1, metadata.version: 1-21&#125;)</span><br></pre></td></tr></table></figure>
<p>在 raft leader 存在时，可以通过脚本 <code>kafka-metadata-quorum.sh</code>的 <code>add-controller</code> 和 <code>remove-controller</code>来调整其中的 voter 列表信息，详细的操作流程见文档 <a href="https://ku.baidu-int.com/knowledge/HFVrC7hq1Q/pKzJfZczuc/cSiB8JEwLX/GdIyA6CDCqnD5a?t=mention&amp;mt=doc&amp;dt=doc" target="_blank" rel="noopener">Kafka KIP-853 功能验证</a></p>
<h1 id="故障发生时的现场"><a href="#故障发生时的现场" class="headerlink" title="故障发生时的现场"></a>故障发生时的现场</h1><h2 id="故障现场"><a href="#故障现场" class="headerlink" title="故障现场"></a>故障现场</h2><p>当前由于运维经验不足，缺少和 raft 相关的监控，导致一个目前未接流的集群出现了 raft 丢主的问题.</p>
<p><img src="Pasted image 20251220222816.png" alt=""></p>
<p><img src="Pasted image 20251220222824.png" alt=""></p>
<p>可以看到，从 10.41.113.145 挂掉之后，就无法选主了。当前实例列表如下，应该是有误的，因为 leader 已经挂了，所以 raft log 的信息不更新了，因为实际上已经挂了两个实例。在丢主后，当前没有找到通过外部方式来对 voter 进行干预的手段。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">nizhenyang@ningzhixian [11:30:39 AM] [~]</span><br><span class="line">-&gt; % kaf nodes  -b standard-build-kafka-hbe.www.hbe.serv:9092</span><br><span class="line">ID    ADDRESS                                             CONTROLLER</span><br><span class="line">0     bddwd-ps-beehive-agent189556.bddwd.baidu.com:9092   false</span><br><span class="line">1     bddwd-ps-beehive-agent186208.bddwd.baidu.com:9092   false</span><br><span class="line">2     bddwd-ps-beehive-agent186248.bddwd.baidu.com:9092   true</span><br><span class="line">3     bddwd-ps-beehive-agent188990.bddwd.baidu.com:9092   false</span><br><span class="line">5     bddwd-ps-beehive-agent186329.bddwd.baidu.com:9092   false</span><br><span class="line">6     bddwd-ps-beehive-agent189309.bddwd.baidu.com:9092   false</span><br><span class="line">7     bddwd-ps-beehive-agent189551.bddwd.baidu.com:9092   false</span><br><span class="line">8     bddwd-ps-beehive-agent188650.bddwd.baidu.com:9092   false</span><br><span class="line">9     bddwd-ps-beehive-agent298089.bddwd.baidu.com:9092   false</span><br></pre></td></tr></table></figure>
<p><img src="Pasted image 20251220222841.png" alt=""></p>
<h2 id="broker0-日志"><a href="#broker0-日志" class="headerlink" title="broker0 日志"></a>broker0 日志</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[2025-12-11 11:32:54,328] INFO [RaftManager id=0] Candidate sent a voter key (Optional[ReplicaKey(id=0, directoryId=Optional[i4eqWHkOz8EdjmAvBv-RTA])]) in the VOTE request that doesn&apos;t match the local key (OptionalInt[0], CYh4bpOcyVnbJuhnrrzudw); rejecting the vote (org.apache.kafka.raft.KafkaRaftClient)</span><br><span class="line">[2025-12-11 11:32:54,328] INFO [RaftManager id=0] Candidate sent a voter key (Optional[ReplicaKey(id=0, directoryId=Optional[i4eqWHkOz8EdjmAvBv-RTA])]) in the VOTE request that doesn&apos;t match the local key (OptionalInt[0], CYh4bpOcyVnbJuhnrrzudw); rejecting the vote (org.apache.kafka.raft.KafkaRaftClient)</span><br><span class="line">[2025-12-11 11:32:54,328] INFO [RaftManager id=0] Candidate sent a voter key (Optional[ReplicaKey(id=0, directoryId=Optional[i4eqWHkOz8EdjmAvBv-RTA])]) in the VOTE request that doesn&apos;t match the local key (OptionalInt[0], CYh4bpOcyVnbJuhnrrzudw); rejecting the vote (org.apache.kafka.raft.KafkaRaftClient)</span><br><span class="line">[2025-12-11 11:32:54,328] INFO [RaftManager id=0] Candidate sent a voter key (Optional[ReplicaKey(id=0, directoryId=Optional[i4eqWHkOz8EdjmAvBv-RTA])]) in the VOTE request that doesn&apos;t match the local key (OptionalInt[0], CYh4bpOcyVnbJuhnrrzudw); rejecting the vote (org.apache.kafka.raft.KafkaRaftClient)</span><br><span class="line">[2025-12-11 11:32:54,329] INFO [RaftManager id=0] Candidate sent a voter key (Optional[ReplicaKey(id=0, directoryId=Optional[i4eqWHkOz8EdjmAvBv-RTA])]) in the VOTE request that doesn&apos;t match the local key (OptionalInt[0], CYh4bpOcyVnbJuhnrrzudw); rejecting the vote (org.apache.kafka.raft.KafkaRaftClient)</span><br><span class="line">[2025-12-11 11:32:54,329] INFO [RaftManager id=0] Candidate sent a voter key (Optional[ReplicaKey(id=0, directoryId=Optional[i4eqWHkOz8EdjmAvBv-RTA])]) in the VOTE request that doesn&apos;t match the local key (OptionalInt[0], CYh4bpOcyVnbJuhnrrzudw); rejecting the vote (org.apache.kafka.raft.KafkaRaftClient)</span><br><span class="line">[2025-12-11 11:32:54,329] INFO [RaftManager id=0] Candidate sent a voter key (Optional[ReplicaKey(id=0, directoryId=Optional[i4eqWHkOz8EdjmAvBv-RTA])]) in the VOTE request that doesn&apos;t match the local key (OptionalInt[0], CYh4bpOcyVnbJuhnrrzudw); rejecting the vote (org.apache.kafka.raft.KafkaRaftClient)</span><br><span class="line">[2025-12-11 11:32:54,329] INFO [RaftManager id=0] Candidate sent a voter key (Optional[ReplicaKey(id=0, directoryId=Optional[i4eqWHkOz8EdjmAvBv-RTA])]) in the VOTE request that doesn&apos;t match the local key (OptionalInt[0], CYh4bpOcyVnbJuhnrrzudw); rejecting the vote (org.apache.kafka.raft.KafkaRaftClient)</span><br><span class="line">[2025-12-11 11:32:54,329] INFO [RaftManager id=0] Candidate sent a voter key (Optional[ReplicaKey(id=0, directoryId=Optional[i4eqWHkOz8EdjmAvBv-RTA])]) in the VOTE request that doesn&apos;t match the local key (OptionalInt[0], CYh4bpOcyVnbJuhnrrzudw); rejecting the vote (org.apache.kafka.raft.KafkaRaftClient)</span><br><span class="line">[2025-12-11 11:32:54,329] INFO [RaftManager id=0] Candidate sent a voter key (Optional[ReplicaKey(id=0, directoryId=Optional[i4eqWHkOz8EdjmAvBv-RTA])]) in the VOTE request that doesn&apos;t match the local key (OptionalInt[0], CYh4bpOcyVnbJuhnrrzudw); rejecting the vote (org.apache.kafka.raft.KafkaRaftClient)</span><br><span class="line">[2025-12-11 11:32:54,330] INFO [RaftManager id=0] Candidate sent a voter key (Optional[ReplicaKey(id=0, directoryId=Optional[i4eqWHkOz8EdjmAvBv-RTA])]) in the VOTE request that doesn&apos;t match the local key (OptionalInt[0], CYh4bpOcyVnbJuhnrrzudw); rejecting the vote (org.apache.kafka.raft.KafkaRaftClient)</span><br><span class="line">[2025-12-11 11:32:54,330] INFO [RaftManager id=0] Candidate sent a voter key (Optional[ReplicaKey(id=0, directoryId=Optional[i4eqWHkOz8EdjmAvBv-RTA])]) in the VOTE request that doesn&apos;t match the local key (OptionalInt[0], CYh4bpOcyVnbJuhnrrzudw); rejecting the vote (org.apache.kafka.raft.KafkaRaftClient)</span><br><span class="line">[2025-12-11 11:32:54,330] INFO [RaftManager id=0] Candidate sent a voter key (Optional[ReplicaKey(id=0, directoryId=Optional[i4eqWHkOz8EdjmAvBv-RTA])]) in the VOTE request that doesn&apos;t match the local key (OptionalInt[0], CYh4bpOcyVnbJuhnrrzudw); rejecting the vote (org.apache.kafka.raft.KafkaRaftClient)</span><br></pre></td></tr></table></figure>
<p>可以看到，预期的 voter key 是 i4eqWHkOz8EdjmAvBv-RTA ，但是本地是 CYh4bpOcyVnbJuhnrrzudw </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1000007.standard-build-kafka-hbe.www.hbe 1000007.standard-build-kafka-hbe.www.hbe $ cat metadata/meta.properties</span><br><span class="line">#</span><br><span class="line">#Thu Dec 04 19:43:04 CST 2025</span><br><span class="line">node.id=0</span><br><span class="line">directory.id=CYh4bpOcyVnbJuhnrrzudw</span><br><span class="line">version=1</span><br><span class="line">cluster.id=H5Bv6LfaTu2Q_KpBC5uwkA</span><br></pre></td></tr></table></figure>
<p>怀疑是 raft log 中存储的 voter 信息有误。在服务启动时，有一个前置的 agent 程序预期会将历史 brokerid=0 的信息全部移除，相关日志如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">time=&quot;2025-12-04T19:44:05+08:00&quot; level=debug msg=&quot;executing command: ./bin/kafka-metadata-quorum.sh --bootstrap-server standard-build-kafka-hbe.www.hbe.serv:9092 describe --status&quot;</span><br><span class="line">time=&quot;2025-12-04T19:44:07+08:00&quot; level=debug msg=&quot;describe command ./bin/kafka-metadata-quorum.sh --bootstrap-server standard-build-kafka-hbe.www.hbe.serv:9092 describe --status executed successfully, output: ClusterId:              H5Bv6LfaTu2Q_KpBC5uwkA\nLeaderId:               2\nLeaderEpoch:            11871\nHighWatermark:          23758215\nMaxFollowerLag:         23758217\nMaxFollowerLagTimeMs:   -1\nCurrentVoters:          [&#123;\&quot;id\&quot;: 0, \&quot;directoryId\&quot;: \&quot;i4eqWHkOz8EdjmAvBv-RTA\&quot;, \&quot;endpoints\&quot;: [\&quot;CONTROLLER://bddwd-ps-beehive-agent189477.bddwd.baidu.com:9093\&quot;]&#125;, &#123;\&quot;id\&quot;: 1, \&quot;directoryId\&quot;: \&quot;UlyndGC-0oAh9AJg78vIiQ\&quot;, \&quot;endpoints\&quot;: [\&quot;CONTROLLER://bddwd-ps-beehive-agent186208.bddwd.baidu.com:9093\&quot;]&#125;, &#123;\&quot;id\&quot;: 2, \&quot;directoryId\&quot;: \&quot;E9lSA4eVwvqVkK_Ne2oRHQ\&quot;, \&quot;endpoints\&quot;: [\&quot;CONTROLLER://bddwd-ps-beehive-agent186248.bddwd.baidu.com:9093\&quot;]&#125;, &#123;\&quot;id\&quot;: 3, \&quot;directoryId\&quot;: \&quot;EBIcY48DqyWSW6mYBclm4A\&quot;, \&quot;endpoints\&quot;: [\&quot;CONTROLLER://bddwd-ps-beehive-agent189478.bddwd.baidu.com:9093\&quot;]&#125;, &#123;\&quot;id\&quot;: 4, \&quot;directoryId\&quot;: \&quot;DfKBMNvPRbkmS9ngnYkeaw\&quot;, \&quot;endpoints\&quot;: [\&quot;CONTROLLER://bddwd-ps-beehive-agent188790.bddwd.baidu.com:9093\&quot;]&#125;]\nCurrentObservers:       [&#123;\&quot;id\&quot;: 8, \&quot;directoryId\&quot;: \&quot;xaJPiGOG5yBAQFLJNyBFCQ\&quot;&#125;, &#123;\&quot;id\&quot;: 9, \&quot;directoryId\&quot;: \&quot;AUv22avuzcLArZCSUgwcww\&quot;&#125;, &#123;\&quot;id\&quot;: 0, \&quot;directoryId\&quot;: \&quot;CYh4bpOcyVnbJuhnrrzudw\&quot;, \&quot;endpoints\&quot;: [\&quot;CONTROLLER://bddwd-ps-beehive-agent189477.bddwd.baidu.com:9093\&quot;]&#125;, &#123;\&quot;id\&quot;: 7, \&quot;directoryId\&quot;: \&quot;iS3MtpgY-rqQPOnV6ssVRw\&quot;&#125;, &#123;\&quot;id\&quot;: 5, \&quot;directoryId\&quot;: \&quot;7rgOIvgMcsNOY7rthFBHow\&quot;&#125;, &#123;\&quot;id\&quot;: 6, \&quot;directoryId\&quot;: \&quot;Ew8pIPeKYy6ka_vrVqdzrw\&quot;&#125;, &#123;\&quot;id\&quot;: 0, \&quot;directoryId\&quot;: \&quot;ZP1RA9RYH6Np2r6QP6Omwg\&quot;, \&quot;endpoints\&quot;: [\&quot;CONTROLLER://bddwd-ps-beehive-agent189477.bddwd.baidu.com:9093\&quot;]&#125;]\n&quot;</span><br><span class="line">time=&quot;2025-12-04T19:44:07+08:00&quot; level=debug msg=&quot;to move from observer to voter, first get endpoint info for 0 : &amp;&#123;ID:0 DirectoryID:CYh4bpOcyVnbJuhnrrzudw Endpoints:[CONTROLLER://bddwd-ps-beehive-agent189477.bddwd.baidu.com:9093]&#125; , curr cluster info: Cluster Information:\n  ClusterId: H5Bv6LfaTu2Q_KpBC5uwkA\n  LeaderId: 2\n  LeaderEpoch: 11871\n  HighWatermark: 23758215\n  MaxFollowerLag: 23758217\n  MaxFollowerLagTimeMs: -1\n  CurrentVoters: [\n      &#123;\n          \&quot;id\&quot;: 0,\n          \&quot;directoryId\&quot;: \&quot;i4eqWHkOz8EdjmAvBv-RTA\&quot;,\n          \&quot;endpoints\&quot;: [\n              \&quot;CONTROLLER://bddwd-ps-beehive-agent189477.bddwd.baidu.com:9093\&quot;\n          ]\n      &#125;,\n      &#123;\n          \&quot;id\&quot;: 1,\n          \&quot;directoryId\&quot;: \&quot;UlyndGC-0oAh9AJg78vIiQ\&quot;,\n          \&quot;endpoints\&quot;: [\n              \&quot;CONTROLLER://bddwd-ps-beehive-agent186208.bddwd.baidu.com:9093\&quot;\n          ]\n      &#125;,\n      &#123;\n          \&quot;id\&quot;: 2,\n          \&quot;directoryId\&quot;: \&quot;E9lSA4eVwvqVkK_Ne2oRHQ\&quot;,\n          \&quot;endpoints\&quot;: [\n              \&quot;CONTROLLER://bddwd-ps-beehive-agent186248.bddwd.baidu.com:9093\&quot;\n          ]\n      &#125;,\n      &#123;\n          \&quot;id\&quot;: 3,\n          \&quot;directoryId\&quot;: \&quot;EBIcY48DqyWSW6mYBclm4A\&quot;,\n          \&quot;endpoints\&quot;: [\n              \&quot;CONTROLLER://bddwd-ps-beehive-agent189478.bddwd.baidu.com:9093\&quot;\n          ]\n      &#125;,\n      &#123;\n          \&quot;id\&quot;: 4,\n          \&quot;directoryId\&quot;: \&quot;DfKBMNvPRbkmS9ngnYkeaw\&quot;,\n          \&quot;endpoints\&quot;: [\n              \&quot;CONTROLLER://bddwd-ps-beehive-agent188790.bddwd.baidu.com:9093\&quot;\n          ]\n      &#125;\n  ]\n  CurrentObservers: [\n      &#123;\n          \&quot;id\&quot;: 8,\n          \&quot;directoryId\&quot;: \&quot;xaJPiGOG5yBAQFLJNyBFCQ\&quot;\n      &#125;,\n      &#123;\n          \&quot;id\&quot;: 9,\n          \&quot;directoryId\&quot;: \&quot;AUv22avuzcLArZCSUgwcww\&quot;\n      &#125;,\n      &#123;\n          \&quot;id\&quot;: 0,\n          \&quot;directoryId\&quot;: \&quot;CYh4bpOcyVnbJuhnrrzudw\&quot;,\n          \&quot;endpoints\&quot;: [\n              \&quot;CONTROLLER://bddwd-ps-beehive-agent189477.bddwd.baidu.com:9093\&quot;\n          ]\n      &#125;,\n      &#123;\n          \&quot;id\&quot;: 7,\n          \&quot;directoryId\&quot;: \&quot;iS3MtpgY-rqQPOnV6ssVRw\&quot;\n      &#125;,\n      &#123;\n          \&quot;id\&quot;: 5,\n          \&quot;directoryId\&quot;: \&quot;7rgOIvgMcsNOY7rthFBHow\&quot;\n      &#125;,\n      &#123;\n          \&quot;id\&quot;: 6,\n          \&quot;directoryId\&quot;: \&quot;Ew8pIPeKYy6ka_vrVqdzrw\&quot;\n      &#125;,\n      &#123;\n          \&quot;id\&quot;: 0,\n          \&quot;directoryId\&quot;: \&quot;ZP1RA9RYH6Np2r6QP6Omwg\&quot;,\n          \&quot;endpoints\&quot;: [\n              \&quot;CONTROLLER://bddwd-ps-beehive-agent189477.bddwd.baidu.com:9093\&quot;\n          ]\n      &#125;\n  ]\n&quot;</span><br><span class="line">time=&quot;2025-12-04T19:44:07+08:00&quot; level=debug msg=&quot;in order to add controller, first remove broker 0 from voter&quot;</span><br><span class="line">time=&quot;2025-12-04T19:44:07+08:00&quot; level=debug msg=&quot;executing command: ./bin/kafka-metadata-quorum.sh --bootstrap-server standard-build-kafka-hbe.www.hbe.serv:9092 describe --status&quot;</span><br><span class="line">time=&quot;2025-12-04T19:44:08+08:00&quot; level=debug msg=&quot;describe command ./bin/kafka-metadata-quorum.sh --bootstrap-server standard-build-kafka-hbe.www.hbe.serv:9092 describe --status executed successfully, output: ClusterId:              H5Bv6LfaTu2Q_KpBC5uwkA\nLeaderId:               2\nLeaderEpoch:            11871\nHighWatermark:          23758218\nMaxFollowerLag:         23758219\nMaxFollowerLagTimeMs:   -1\nCurrentVoters:          [&#123;\&quot;id\&quot;: 0, \&quot;directoryId\&quot;: \&quot;i4eqWHkOz8EdjmAvBv-RTA\&quot;, \&quot;endpoints\&quot;: [\&quot;CONTROLLER://bddwd-ps-beehive-agent189477.bddwd.baidu.com:9093\&quot;]&#125;, &#123;\&quot;id\&quot;: 1, \&quot;directoryId\&quot;: \&quot;UlyndGC-0oAh9AJg78vIiQ\&quot;, \&quot;endpoints\&quot;: [\&quot;CONTROLLER://bddwd-ps-beehive-agent186208.bddwd.baidu.com:9093\&quot;]&#125;, &#123;\&quot;id\&quot;: 2, \&quot;directoryId\&quot;: \&quot;E9lSA4eVwvqVkK_Ne2oRHQ\&quot;, \&quot;endpoints\&quot;: [\&quot;CONTROLLER://bddwd-ps-beehive-agent186248.bddwd.baidu.com:9093\&quot;]&#125;, &#123;\&quot;id\&quot;: 3, \&quot;directoryId\&quot;: \&quot;EBIcY48DqyWSW6mYBclm4A\&quot;, \&quot;endpoints\&quot;: [\&quot;CONTROLLER://bddwd-ps-beehive-agent189478.bddwd.baidu.com:9093\&quot;]&#125;, &#123;\&quot;id\&quot;: 4, \&quot;directoryId\&quot;: \&quot;DfKBMNvPRbkmS9ngnYkeaw\&quot;, \&quot;endpoints\&quot;: [\&quot;CONTROLLER://bddwd-ps-beehive-agent188790.bddwd.baidu.com:9093\&quot;]&#125;]\nCurrentObservers:       [&#123;\&quot;id\&quot;: 8, \&quot;directoryId\&quot;: \&quot;xaJPiGOG5yBAQFLJNyBFCQ\&quot;&#125;, &#123;\&quot;id\&quot;: 9, \&quot;directoryId\&quot;: \&quot;AUv22avuzcLArZCSUgwcww\&quot;&#125;, &#123;\&quot;id\&quot;: 0, \&quot;directoryId\&quot;: \&quot;CYh4bpOcyVnbJuhnrrzudw\&quot;, \&quot;endpoints\&quot;: [\&quot;CONTROLLER://bddwd-ps-beehive-agent189477.bddwd.baidu.com:9093\&quot;]&#125;, &#123;\&quot;id\&quot;: 7, \&quot;directoryId\&quot;: \&quot;iS3MtpgY-rqQPOnV6ssVRw\&quot;&#125;, &#123;\&quot;id\&quot;: 5, \&quot;directoryId\&quot;: \&quot;7rgOIvgMcsNOY7rthFBHow\&quot;&#125;, &#123;\&quot;id\&quot;: 6, \&quot;directoryId\&quot;: \&quot;Ew8pIPeKYy6ka_vrVqdzrw\&quot;&#125;, &#123;\&quot;id\&quot;: 0, \&quot;directoryId\&quot;: \&quot;ZP1RA9RYH6Np2r6QP6Omwg\&quot;, \&quot;endpoints\&quot;: [\&quot;CONTROLLER://bddwd-ps-beehive-agent189477.bddwd.baidu.com:9093\&quot;]&#125;]\n&quot;</span><br><span class="line">time=&quot;2025-12-04T19:44:08+08:00&quot; level=debug msg=&quot;executing command: ./bin/kafka-metadata-quorum.sh --bootstrap-server standard-build-kafka-hbe.www.hbe.serv:9092 remove-controller --controller-id 0 --controller-directory-id i4eqWHkOz8EdjmAvBv-RTA&quot;</span><br><span class="line">time=&quot;2025-12-04T19:44:10+08:00&quot; level=error msg=&quot;running command ./bin/kafka-metadata-quorum.sh --bootstrap-server standard-build-kafka-hbe.www.hbe.serv:9092 remove-controller --controller-id 0 --controller-directory-id i4eqWHkOz8EdjmAvBv-RTA, stderr : org.apache.kafka.common.errors.NotLeaderOrFollowerException: \njava.util.concurrent.ExecutionException: org.apache.kafka.common.errors.NotLeaderOrFollowerException: \n\tat java.base/java.util.concurrent.CompletableFuture.reportGet(CompletableFuture.java:396)\n\tat java.base/java.util.concurrent.CompletableFuture.get(CompletableFuture.java:2073)\n\tat org.apache.kafka.common.internals.KafkaFutureImpl.get(KafkaFutureImpl.java:165)\n\tat org.apache.kafka.tools.MetadataQuorumCommand.handleRemoveController(MetadataQuorumCommand.java:499)\n\tat org.apache.kafka.tools.MetadataQuorumCommand.execute(MetadataQuorumCommand.java:151)\n\tat org.apache.kafka.tools.MetadataQuorumCommand.mainNoExit(MetadataQuorumCommand.java:81)\n\tat org.apache.kafka.tools.MetadataQuorumCommand.main(MetadataQuorumCommand.java:76)\nCaused by: org.apache.kafka.common.errors.NotLeaderOrFollowerException: \n\n, err : exit status 1&quot;</span><br><span class="line">time=&quot;2025-12-04T19:44:10+08:00&quot; level=error msg=&quot;record error, tag: move_from_observer_to_voter, err: running command ./bin/kafka-metadata-quorum.sh --bootstrap-server standard-build-kafka-hbe.www.hbe.serv:9092 remove-controller --controller-id 0 --controller-directory-id i4eqWHkOz8EdjmAvBv-RTA, stderr : org.apache.kafka.common.errors.NotLeaderOrFollowerException: \njava.util.concurrent.ExecutionException: org.apache.kafka.common.errors.NotLeaderOrFollowerException: \n\tat java.base/java.util.concurrent.CompletableFuture.reportGet(CompletableFuture.java:396)\n\tat java.base/java.util.concurrent.CompletableFuture.get(CompletableFuture.java:2073)\n\tat org.apache.kafka.common.internals.KafkaFutureImpl.get(KafkaFutureImpl.java:165)\n\tat org.apache.kafka.tools.MetadataQuorumCommand.handleRemoveController(MetadataQuorumCommand.java:499)\n\tat org.apache.kafka.tools.MetadataQuorumCommand.execute(MetadataQuorumCommand.java:151)\n\tat org.apache.kafka.tools.MetadataQuorumCommand.mainNoExit(MetadataQuorumCommand.java:81)\n\tat org.apache.kafka.tools.MetadataQuorumCommand.main(MetadataQuorumCommand.java:76)\nCaused by: org.apache.kafka.common.errors.NotLeaderOrFollowerException: \n\n, err : exit status 1, param: &#123;ExecDir: BrokerPort:9092 ControllerPort:9093 BrokerId:0 ClusterId:H5Bv6LfaTu2Q_KpBC5uwkA HostName:bddwd-ps-beehive-agent189556.bddwd.baidu.com KafkaConfigPath:/home/work/search/1000007.standard-build-kafka-hbe.www.hbe/config/kraft/server.properties LogDir:/home/mnt/disk0, MaxRetries:100 WaitTime:10&#125;&quot;</span><br><span class="line">time=&quot;2025-12-04T19:44:10+08:00&quot; level=info msg=&quot;defer cancel broker restart start ...&quot;</span><br><span class="line">time=&quot;2025-12-04T19:44:10+08:00&quot; level=info msg=&quot;defer cancel broker restart done&quot;</span><br><span class="line">time=&quot;2025-12-04T19:44:10+08:00&quot; level=info msg=&quot;defer shutdown fake server ...&quot;</span><br><span class="line">time=&quot;2025-12-04T19:44:10+08:00&quot; level=info msg=&quot;fake server shutdown: &lt;nil&gt;&quot;</span><br><span class="line">time=&quot;2025-12-04T19:44:10+08:00&quot; level=fatal msg=&quot;kafka agent failed: running command ./bin/kafka-metadata-quorum.sh --bootstrap-server standard-build-kafka-hbe.www.hbe.serv:9092 remove-controller --controller-id 0 --controller-directory-id i4eqWHkOz8EdjmAvBv-RTA, stderr : org.apache.kafka.common.errors.NotLeaderOrFollowerException: \njava.util.concurrent.ExecutionException: org.apache.kafka.common.errors.NotLeaderOrFollowerException: \n\tat java.base/java.util.concurrent.CompletableFuture.reportGet(CompletableFuture.java:396)\n\tat java.base/java.util.concurrent.CompletableFuture.get(CompletableFuture.java:2073)\n\tat org.apache.kafka.common.internals.KafkaFutureImpl.get(KafkaFutureImpl.java:165)\n\tat org.apache.kafka.tools.MetadataQuorumCommand.handleRemoveController(MetadataQuorumCommand.java:499)\n\tat org.apache.kafka.tools.MetadataQuorumCommand.execute(MetadataQuorumCommand.java:151)\n\tat org.apache.kafka.tools.MetadataQuorumCommand.mainNoExit(MetadataQuorumCommand.java:81)\n\tat org.apache.kafka.tools.MetadataQuorumCommand.main(MetadataQuorumCommand.java:76)\nCaused by: org.apache.kafka.common.errors.NotLeaderOrFollowerException: \n\n, err : exit status 1&quot;</span><br></pre></td></tr></table></figure>
<p>可以看到，此时 <code>remove-controller</code> （移除旧 voter 信息）执行失败了，老的 brokerid=0 的信息没有被移除，所以其中记录的 hostname 和投票使用的 id 都是错误。启动 agent 代码写的不严谨，缺少命令执行失败时的容错能力。</p>
<h2 id="broker1-日志"><a href="#broker1-日志" class="headerlink" title="broker1 日志"></a>broker1 日志</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[2025-12-11 13:08:50,377] WARN [RaftManager id=1] Connection to node 3 (bddwd-ps-beehive-agent189478.bddwd.baidu.com/10.41.121.217:9093) could not be established. Node may not be available. (org.apache.kafka.clients.NetworkClient)</span><br><span class="line">[2025-12-11 13:08:50,377] ERROR [RaftManager id=1] Unexpected error INCONSISTENT_CLUSTER_ID in VOTE response: InboundResponse(correlationId=771336793, data=VoteResponseData(errorCode=104, topics=[], nodeEndpoints=[]), source=bddwd-ps-beehive-agent188790.bddwd.baidu.com:9093 (id: 4 rack: null)) (org.apache.kafka.raft.KafkaRaftClient)</span><br><span class="line">[2025-12-11 13:08:50,397] ERROR [RaftManager id=1] Unexpected error INCONSISTENT_CLUSTER_ID in VOTE response: InboundResponse(correlationId=771336799, data=VoteResponseData(errorCode=104, topics=[], nodeEndpoints=[]), source=bddwd-ps-beehive-agent188790.bddwd.baidu.com:9093 (id: 4 rack: null)) (org.apache.kafka.raft.KafkaRaftClient)</span><br><span class="line">[2025-12-11 13:08:50,417] INFO [RaftManager id=1] Node 0 disconnected. (org.apache.kafka.clients.NetworkClient)</span><br><span class="line">[2025-12-11 13:08:50,417] WARN [RaftManager id=1] Connection to node 0 (bddwd-ps-beehive-agent189477.bddwd.baidu.com/10.41.121.215:9093) could not be established. Node may not be available. (org.apache.kafka.clients.NetworkClient)</span><br><span class="line">[2025-12-11 13:08:50,418] ERROR [RaftManager id=1] Unexpected error INCONSISTENT_CLUSTER_ID in VOTE response: InboundResponse(correlationId=771336801, data=VoteResponseData(errorCode=104, topics=[], nodeEndpoints=[]), source=bddwd-ps-beehive-agent188790.bddwd.baidu.com:9093 (id: 4 rack: null)) (org.apache.kafka.raft.KafkaRaftClient)</span><br><span class="line">[2025-12-11 13:08:50,438] ERROR [RaftManager id=1] Unexpected error INCONSISTENT_CLUSTER_ID in VOTE response: InboundResponse(correlationId=771336808, data=VoteResponseData(errorCode=104, topics=[], nodeEndpoints=[]), source=bddwd-ps-beehive-agent188790.bddwd.baidu.com:9093 (id: 4 rack: null)) (org.apache.kafka.raft.KafkaRaftClient)</span><br><span class="line">[2025-12-11 13:08:50,459] INFO [RaftManager id=1] Node 2 disconnected. (org.apache.kafka.clients.NetworkClient)</span><br><span class="line">[2025-12-11 13:08:50,459] WARN [RaftManager id=1] Connection to node 2 (bddwd-ps-beehive-agent186248.bddwd.baidu.com/10.41.63.216:9093) could not be established. Node may not be available. (org.apache.kafka.clients.NetworkClient)</span><br><span class="line">[2025-12-11 13:08:50,817] ERROR [RaftManager id=1] Unexpected error INCONSISTENT_CLUSTER_ID in VOTE response: InboundResponse(correlationId=771336809, data=VoteResponseData(errorCode=104, topics=[], nodeEndpoints=[]), source=bddwd-ps-beehive-agent188790.bddwd.baidu.com:9093 (id: 4 rack: null)) (org.apache.kafka.raft.KafkaRaftClient)</span><br><span class="line">[2025-12-11 13:08:50,837] ERROR [RaftManager id=1] Unexpected error INCONSISTENT_CLUSTER_ID in VOTE response: InboundResponse(correlationId=771336816, data=VoteResponseData(errorCode=104, topics=[], nodeEndpoints=[]), source=bddwd-ps-beehive-agent188790.bddwd.baidu.com:9093 (id: 4 rack: null)) (org.apache.kafka.raft.KafkaRaftClient)</span><br><span class="line">[2025-12-11 13:08:50,857] ERROR [RaftManager id=1] Unexpected error INCONSISTENT_CLUSTER_ID in VOTE response: InboundResponse(correlationId=771336820, data=VoteResponseData(errorCode=104, topics=[], nodeEndpoints=[]), source=bddwd-ps-beehive-agent188790.bddwd.baidu.com:9093 (id: 4 rack: null)) (org.apache.kafka.raft.KafkaRaftClient)</span><br><span class="line">[2025-12-11 13:08:50,878] INFO [RaftManager id=1] Node 3 disconnected. (org.apache.kafka.clients.NetworkClient)</span><br><span class="line">[2025-12-11 13:08:50,878] WARN [RaftManager id=1] Connection to node 3 (bddwd-ps-beehive-agent189478.bddwd.baidu.com/10.41.121.217:9093) could not be established. Node may not be available. (org.apache.kafka.clients.NetworkClient)</span><br><span class="line">[2025-12-11 13:08:50,878] ERROR [RaftManager id=1] Unexpected error INCONSISTENT_CLUSTER_ID in VOTE response: InboundResponse(correlationId=771336824, data=VoteResponseData(errorCode=104, topics=[], nodeEndpoints=[]), source=bddwd-ps-beehive-agent188790.bddwd.baidu.com:9093 (id: 4 rack: null)) (org.apache.kafka.raft.KafkaRaftClient)</span><br><span class="line">[2025-12-11 13:08:50,898] ERROR [RaftManager id=1] Unexpected error INCONSISTENT_CLUSTER_ID in VOTE response: InboundResponse(correlationId=771336828, data=VoteResponseData(errorCode=104, topics=[], nodeEndpoints=[]), source=bddwd-ps-beehive-agent188790.bddwd.baidu.com:9093 (id: 4 rack: null)) (org.apache.kafka.raft.KafkaRaftClient)</span><br><span class="line">[2025-12-11 13:08:50,919] INFO [RaftManager id=1] Node 0 disconnected. (org.apache.kafka.clients.NetworkClient)</span><br><span class="line">[2025-12-11 13:08:50,919] WARN [RaftManager id=1] Connection to node 0 (bddwd-ps-beehive-agent189477.bddwd.baidu.com/10.41.121.215:9093) could not be established. Node may not be available. (org.apache.kafka.clients.NetworkClient)</span><br><span class="line">[2025-12-11 13:08:50,919] ERROR [RaftManager id=1] Unexpected error INCONSISTENT_CLUSTER_ID in VOTE response: InboundResponse(correlationId=771336832, data=VoteResponseData(errorCode=104, topics=[], nodeEndpoints=[]), source=bddwd-ps-beehive-agent188790.bddwd.baidu.com:9093 (id: 4 rack: null)) (org.apache.kafka.raft.KafkaRaftClient)</span><br><span class="line">[2025-12-11 13:08:50,940] ERROR [RaftManager id=1] Unexpected error INCONSISTENT_CLUSTER_ID in VOTE response: InboundResponse(correlationId=771336836, data=VoteResponseData(errorCode=104, topics=[], nodeEndpoints=[]), source=bddwd-ps-beehive-agent188790.bddwd.baidu.com:9093 (id: 4 rack: null)) (org.apache.kafka.raft.KafkaRaftClient)</span><br><span class="line">[2025-12-11 13:08:50,959] INFO [RaftManager id=1] Node 2 disconnected. (org.apache.kafka.clients.NetworkClient)</span><br><span class="line">[2025-12-11 13:08:50,959] WARN [RaftManager id=1] Connection to node 2 (bddwd-ps-beehive-agent186248.bddwd.baidu.com/10.41.63.216:9093) could not be established. Node may not be available. (org.apache.kafka.clients.NetworkClient)</span><br><span class="line">[2025-12-11 13:08:50,995] ERROR [RaftManager id=1] Unexpected error INCONSISTENT_CLUSTER_ID in VOTE response: InboundResponse(correlationId=771336843, data=VoteResponseData(errorCode=104, topics=[], nodeEndpoints=[]), source=bddwd-ps-beehive-agent188790.bddwd.baidu.com:9093 (id: 4 rack: null)) (org.apache.kafka.raft.KafkaRaftClient)</span><br><span class="line">[2025-12-11 13:08:51,015] ERROR [RaftManager id=1] Unexpected error INCONSISTENT_CLUSTER_ID in VOTE response: InboundResponse(correlationId=771336847, data=VoteResponseData(errorCode=104, topics=[], nodeEndpoints=[]), source=bddwd-ps-beehive-agent188790.bddwd.baidu.com:9093 (id: 4 rack: null)) (org.apache.kafka.raft.KafkaRaftClient)</span><br><span class="line">[2025-12-11 13:08:51,036] ERROR [RaftManager id=1] Unexpected error INCONSISTENT_CLUSTER_ID in VOTE response: InboundResponse(correlationId=771336851, data=VoteResponseData(errorCode=104, topics=[], nodeEndpoints=[]), source=bddwd-ps-beehive-agent188790.bddwd.baidu.com:9093 (id: 4 rack: null)) (org.apache.kafka.raft.KafkaRaftClient)</span><br><span class="line">[2025-12-11 13:08:51,056] ERROR [RaftManager id=1] Unexpected error INCONSISTENT_CLUSTER_ID in VOTE response: InboundResponse(correlationId=771336855, data=VoteResponseData(errorCode=104, topics=[], nodeEndpoints=[]), source=bddwd-ps-beehive-agent188790.bddwd.baidu.com:9093 (id: 4 rack: null)) (org.apache.kafka.raft.KafkaRaftClient)</span><br><span class="line">[2025-12-11 13:08:51,077] ERROR [RaftManager id=1] Unexpected error INCONSISTENT_CLUSTER_ID in VOTE response: InboundResponse(correlationId=771336859, data=VoteResponseData(errorCode=104, topics=[], nodeEndpoints=[]), source=bddwd-ps-beehive-agent188790.bddwd.baidu.com:9093 (id: 4 rack: null)) (org.apache.kafka.raft.KafkaRaftClient)</span><br></pre></td></tr></table></figure>
<p>可以看到，主要报错为 bddwd-ps-beehive-agent188790.bddwd.baidu.com 的 cluster id 不正确，看 brokerid 1 中打印的信息，这个预期应该是 broker4，但是实际上 broker4 已经被迁移走了，目前是被其它集群的 kafka 占用。也就是说，broker 4 新实例在启动的时候，也存在 voter 信息修改失败的问题。另外根据日志中的报错信息，发现访问的 broker0 和 broker3 上的实例也存在问题，元信息有误。broker0 的问题上面已经排查过了，是已知的问题。broker3 估计也是类似的问题，有待后续排查。</p>
<p>这里我们再确认一下 broker1 的元信息情况：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># /home/disk3/nizhenyang/dev/kafka_new_ver_search/std_hbe_err/metadata_bak_20251211_broker_1/__cluster_metadata-0//00000000000024475200-0000012041.checkpoint</span><br><span class="line">export PATH=$(pwd)/java17/bin:$PATH</span><br><span class="line">export JAVA_HOME=$(pwd)/java17</span><br><span class="line"></span><br><span class="line">cp -r metadata metadata_bak_20251211</span><br><span class="line">rm metadata_bak_20251211/.lock</span><br><span class="line">../kafka/new_cluster_demo_v3//c0/bin/kafka-metadata-shell.sh --snapshot metadata_bak_20251211_broker_1/__cluster_metadata-0//00000000000024475200-0000012041.checkpoint</span><br></pre></td></tr></table></figure>
<p>选取最新的 checkpoint 加载，可以看到，相关的元信息都在</p>
<p><img src="Pasted image 20251220222903.png" alt=""></p>
<p>其中 controller 的信息如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">controllers:</span><br><span class="line">  0:</span><br><span class="line">    ControllerRegistration(id=0, incarnationId=Es2ouwWpQ1CwAP5aIr70iA, zkMigrationReady=false, listeners=[Endpoint(listenerName=&apos;CONTROLLER&apos;, securityProtocol=PLAINTEXT, host=&apos;bddwd-ps-beehive-agent189556.bddwd.baidu.com&apos;, port=9093)], supportedFeatures=&#123;kraft.version: 0-1, metadata.version: 1-21&#125;)</span><br><span class="line">  1:</span><br><span class="line">    ControllerRegistration(id=1, incarnationId=v_6Dqtc_TDeaPCQtDO05rw, zkMigrationReady=false, listeners=[Endpoint(listenerName=&apos;CONTROLLER&apos;, securityProtocol=PLAINTEXT, host=&apos;bddwd-ps-beehive-agent186208.bddwd.baidu.com&apos;, port=9093)], supportedFeatures=&#123;kraft.version: 0-1, metadata.version: 1-21&#125;)</span><br><span class="line">  2:</span><br><span class="line">    ControllerRegistration(id=2, incarnationId=Q-DrAW0CQ0adVzdjfQZWNA, zkMigrationReady=false, listeners=[Endpoint(listenerName=&apos;CONTROLLER&apos;, securityProtocol=PLAINTEXT, host=&apos;bddwd-ps-beehive-agent186248.bddwd.baidu.com&apos;, port=9093)], supportedFeatures=&#123;kraft.version: 0-1, metadata.version: 1-21&#125;)</span><br><span class="line">  3:</span><br><span class="line">    ControllerRegistration(id=3, incarnationId=GQSZLOqUR8enDsWCuTrN9g, zkMigrationReady=false, listeners=[Endpoint(listenerName=&apos;CONTROLLER&apos;, securityProtocol=PLAINTEXT, host=&apos;bddwd-ps-beehive-agent188990.bddwd.baidu.com&apos;, port=9093)], supportedFeatures=&#123;kraft.version: 0-1, metadata.version: 1-21&#125;)</span><br><span class="line">  4:</span><br><span class="line">    ControllerRegistration(id=4, incarnationId=exm0pjp8Tlqr_Egqw1vYZQ, zkMigrationReady=false, listeners=[Endpoint(listenerName=&apos;CONTROLLER&apos;, securityProtocol=PLAINTEXT, host=&apos;bddwd-ps-beehive-agent188790.bddwd.baidu.com&apos;, port=9093)], supportedFeatures=&#123;kraft.version: 0-1, metadata.version: 1-21&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="broker2-日志"><a href="#broker2-日志" class="headerlink" title="broker2 日志"></a>broker2 日志</h2><p>broker2 已经被 stop 了，最后的相关日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[2025-12-11 12:58:53,397] INFO [RaftManager id=2] Voter key for VOTE or BEGIN_QUORUM_EPOCH request didn&apos;t match the receiver&apos;s replica key: bddwd-ps-beehive-agent189477.bddwd.baidu.com:9093 (id: 0 rack: null) (org.apache.kafka.raft.KafkaRaftClient)</span><br><span class="line">[2025-12-11 12:58:53,397] INFO [RaftManager id=2] Voter key for VOTE or BEGIN_QUORUM_EPOCH request didn&apos;t match the receiver&apos;s replica key: bddwd-ps-beehive-agent189478.bddwd.baidu.com:9093 (id: 3 rack: null) (org.apache.kafka.raft.KafkaRaftClient)</span><br><span class="line">[2025-12-11 12:58:53,397] INFO [RaftManager id=2] Voter key for VOTE or BEGIN_QUORUM_EPOCH request didn&apos;t match the receiver&apos;s replica key: bddwd-ps-beehive-agent189477.bddwd.baidu.com:9093 (id: 0 rack: null) (org.apache.kafka.raft.KafkaRaftClient)</span><br><span class="line">[2025-12-11 12:58:53,397] INFO [RaftManager id=2] Voter key for VOTE or BEGIN_QUORUM_EPOCH request didn&apos;t match the receiver&apos;s replica key: bddwd-ps-beehive-agent189478.bddwd.baidu.com:9093 (id: 3 rack: null) (org.apache.kafka.raft.KafkaRaftClient)</span><br><span class="line">[2025-12-11 12:58:53,397] INFO [RaftManager id=2] Voter key for VOTE or BEGIN_QUORUM_EPOCH request didn&apos;t match the receiver&apos;s replica key: bddwd-ps-beehive-agent189477.bddwd.baidu.com:9093 (id: 0 rack: null) (org.apache.kafka.raft.KafkaRaftClient)</span><br><span class="line">[2025-12-11 12:58:53,397] INFO [RaftManager id=2] Voter key for VOTE or BEGIN_QUORUM_EPOCH request didn&apos;t match the receiver&apos;s replica key: bddwd-ps-beehive-agent189477.bddwd.baidu.com:9093 (id: 0 rack: null) (org.apache.kafka.raft.KafkaRaftClient)</span><br><span class="line">[2025-12-11 12:58:53,397] INFO [RaftManager id=2] Voter key for VOTE or BEGIN_QUORUM_EPOCH request didn&apos;t match the receiver&apos;s replica key: bddwd-ps-beehive-agent189478.bddwd.baidu.com:9093 (id: 3 rack: null) (org.apache.kafka.raft.KafkaRaftClient)</span><br><span class="line">[2025-12-11 12:58:53,398] INFO [RaftManager id=2] Voter key for VOTE or BEGIN_QUORUM_EPOCH request didn&apos;t match the receiver&apos;s replica key: bddwd-ps-beehive-agent189477.bddwd.baidu.com:9093 (id: 0 rack: null) (org.apache.kafka.raft.KafkaRaftClient)</span><br><span class="line">[2025-12-11 12:58:53,398] INFO [RaftManager id=2] Voter key for VOTE or BEGIN_QUORUM_EPOCH request didn&apos;t match the receiver&apos;s replica key: bddwd-ps-beehive-agent189478.bddwd.baidu.com:9093 (id: 3 rack: null) (org.apache.kafka.raft.KafkaRaftClient)</span><br><span class="line">[2025-12-11 12:58:53,398] INFO [RaftManager id=2] Voter key for VOTE or BEGIN_QUORUM_EPOCH request didn&apos;t match the receiver&apos;s replica key: bddwd-ps-beehive-agent189477.bddwd.baidu.com:9093 (id: 0 rack: null) (org.apache.kafka.raft.KafkaRaftClient)</span><br><span class="line">[2025-12-11 12:58:53,398] INFO [RaftManager id=2] Voter key for VOTE or BEGIN_QUORUM_EPOCH request didn&apos;t match the receiver&apos;s replica key: bddwd-ps-beehive-agent189477.bddwd.baidu.com:9093 (id: 0 rack: null) (org.apache.kafka.raft.KafkaRaftClient)</span><br><span class="line">[2025-12-11 12:58:53,398] INFO [RaftManager id=2] Voter key for VOTE or BEGIN_QUORUM_EPOCH request didn&apos;t match the receiver&apos;s replica key: bddwd-ps-beehive-agent189477.bddwd.baidu.com:9093 (id: 0 rack: null) (org.apache.kafka.raft.KafkaRaftClient)</span><br></pre></td></tr></table></figure>
<p>可以看到，也是连接 broker0 和 broker3 存在问题。接下来我们需要确认一下 broker2 的元数据。元数据备份地址位于 /home/disk3/nizhenyang/dev/kafka_new_ver_search/std_hbe_err/metadata_bak_20251211_broker_2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">controllers:</span><br><span class="line">  0:</span><br><span class="line">    ControllerRegistration(id=0, incarnationId=Es2ouwWpQ1CwAP5aIr70iA, zkMigrationReady=false, listeners=[Endpoint(listenerName=&apos;CONTROLLER&apos;, securityProtocol=PLAINTEXT, host=&apos;bddwd-ps-beehive-agent189556.bddwd.baidu.com&apos;, port=9093)], supportedFeatures=&#123;kraft.version: 0-1, metadata.version: 1-21&#125;)</span><br><span class="line">  1:</span><br><span class="line">    ControllerRegistration(id=1, incarnationId=v_6Dqtc_TDeaPCQtDO05rw, zkMigrationReady=false, listeners=[Endpoint(listenerName=&apos;CONTROLLER&apos;, securityProtocol=PLAINTEXT, host=&apos;bddwd-ps-beehive-agent186208.bddwd.baidu.com&apos;, port=9093)], supportedFeatures=&#123;kraft.version: 0-1, metadata.version: 1-21&#125;)</span><br><span class="line">  2:</span><br><span class="line">    ControllerRegistration(id=2, incarnationId=Q-DrAW0CQ0adVzdjfQZWNA, zkMigrationReady=false, listeners=[Endpoint(listenerName=&apos;CONTROLLER&apos;, securityProtocol=PLAINTEXT, host=&apos;bddwd-ps-beehive-agent186248.bddwd.baidu.com&apos;, port=9093)], supportedFeatures=&#123;kraft.version: 0-1, metadata.version: 1-21&#125;)</span><br><span class="line">  3:</span><br><span class="line">    ControllerRegistration(id=3, incarnationId=GQSZLOqUR8enDsWCuTrN9g, zkMigrationReady=false, listeners=[Endpoint(listenerName=&apos;CONTROLLER&apos;, securityProtocol=PLAINTEXT, host=&apos;bddwd-ps-beehive-agent188990.bddwd.baidu.com&apos;, port=9093)], supportedFeatures=&#123;kraft.version: 0-1, metadata.version: 1-21&#125;)</span><br><span class="line">  4:</span><br><span class="line">    ControllerRegistration(id=4, incarnationId=exm0pjp8Tlqr_Egqw1vYZQ, zkMigrationReady=false, listeners=[Endpoint(listenerName=&apos;CONTROLLER&apos;, securityProtocol=PLAINTEXT, host=&apos;bddwd-ps-beehive-agent188790.bddwd.baidu.com&apos;, port=9093)], supportedFeatures=&#123;kraft.version: 0-1, metadata.version: 1-21&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="broker3-日志"><a href="#broker3-日志" class="headerlink" title="broker3 日志"></a>broker3 日志</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[2025-12-11 13:57:09,187] ERROR [RaftManager id=3] Unexpected error INCONSISTENT_CLUSTER_ID in FETCH response: InboundResponse(correlationId=79250054, data=FetchResponseData(throttleTimeMs=0, errorCode=104, sessionId=0, responses=[], nodeEndpoints=[]), source=bddwd-ps-beehive-agent188790.bddwd.baidu.com:9093 (id: 4 rack: null)) (org.apache.kafka.raft.KafkaRaftClient)</span><br><span class="line">[2025-12-11 13:58:04,140] INFO [RaftManager id=3] Node 2 disconnected. (org.apache.kafka.clients.NetworkClient)</span><br><span class="line">[2025-12-11 13:58:04,140] WARN [RaftManager id=3] Connection to node 2 (bddwd-ps-beehive-agent186248.bddwd.baidu.com/10.41.63.216:9093) could not be established. Node may not be available. (org.apache.kafka.clients.NetworkClient)</span><br></pre></td></tr></table></figure>
<p>连接 broker4 的故障是已知问题，新的 broker4 启动时，移除信息失败了，然后原部署的机器上运行了其它 kafka 集群的实例。broker2 是 stop 的状态，所以连不上。估计是这些问题导致了 broker3 的 voter 启动失败，其它的 voter 连接存在问题。</p>
<h2 id="broker4-日志"><a href="#broker4-日志" class="headerlink" title="broker4 日志"></a>broker4 日志</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[2025-12-11 12:49:17,658] INFO Registered kafka:type=kafka.Log4jController MBean (kafka.utils.Log4jControllerRegistration$)</span><br><span class="line">[2025-12-11 12:49:17,839] INFO Setting -D jdk.tls.rejectClientInitiatedRenegotiation=true to disable client-initiated TLS renegotiation (org.apache.zookeeper.common.X509Util)</span><br><span class="line">[2025-12-11 12:49:17,885] ERROR Exiting Kafka due to fatal exception (kafka.Kafka$)</span><br><span class="line">java.lang.IllegalArgumentException: requirement failed: If process.roles contains the &apos;controller&apos; role, the node id 4 must be included in the set of voters controller.quorum.voters=Set(0, 1, 2, 3)</span><br><span class="line">    at scala.Predef$.require(Predef.scala:337)</span><br><span class="line">    at kafka.server.KafkaConfig.validateControllerQuorumVotersMustContainNodeIdForKRaftController$1(KafkaConfig.scala:936)</span><br><span class="line">    at kafka.server.KafkaConfig.validateValues(KafkaConfig.scala:993)</span><br><span class="line">    at kafka.server.KafkaConfig.&lt;init&gt;(KafkaConfig.scala:867)</span><br><span class="line">    at kafka.server.KafkaConfig.&lt;init&gt;(KafkaConfig.scala:185)</span><br><span class="line">    at kafka.Kafka$.buildServer(Kafka.scala:71)</span><br><span class="line">    at kafka.Kafka$.main(Kafka.scala:90)</span><br><span class="line">    at kafka.Kafka.main(Kafka.scala)</span><br></pre></td></tr></table></figure>
<p>在自动生成的配置文件中，不包含 broker4。后面排查的原因是这个 voter 列表是由启动 agent 生成的，当时想通过强制指定 voter 列表，逐步移除 controller 来尝试进行止损，但是忽略了把 process.roles 设置为 broker 。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># The role of this server. Setting this puts us in KRaft mode</span><br><span class="line">process.roles=broker,controller</span><br><span class="line"></span><br><span class="line"># The node id associated with this instance&apos;s roles</span><br><span class="line">node.id=4</span><br><span class="line"></span><br><span class="line"># The connect string for the controller quorum</span><br><span class="line">controller.quorum.voters=0@bddwd-ps-beehive-agent189556.bddwd.baidu.com:9093,1@bddwd-ps-beehive-agent186208.bddwd.baidu.com:9093,2@bddwd-ps-beehive-agent186248.bddwd.baidu.com:9093,3@bddwd-ps-beehive-agent188990.bddwd.baidu.com:9093</span><br></pre></td></tr></table></figure>
<h2 id="问题总结"><a href="#问题总结" class="headerlink" title="问题总结"></a>问题总结</h2><p>根据日志分析有如下结论：</p>
<ul>
<li><p>broker0 的问题是</p>
<ul>
<li><p>存在实例迁移，迁移后执行 <code>remove-controller</code>移除历史 0 的信息失败</p>
</li>
<li><p>本地的 dir id 和 metaadata 中的 dir id 对不上，dir id 是用于投票的，不一致会导致启动失败</p>
</li>
</ul>
</li>
<li><p>broker1 的问题是：</p>
<ul>
<li><p>连不上 broker 0 ，因为它的 ip 信息没有更新</p>
</li>
<li><p>连不上 broker 2，它已经被 stop 了</p>
</li>
<li><p>连 broker3 存在问题，我怀疑是因为 broker3 的 voter 状态存在问题，不过具体原因不太清楚</p>
</li>
<li><p>连不上 broker 4，因为它的 ip 信息没有更新，新实例都没启动</p>
</li>
</ul>
</li>
<li><p>broker2 的问题是：</p>
<ul>
<li><p>当前是 stop 的状态</p>
</li>
<li><p>连不上 broker0</p>
</li>
<li><p>连 broker3 存在问题</p>
</li>
</ul>
</li>
<li><p>broker3 的问题是</p>
<ul>
<li><p>连接 broker2 持续有问题</p>
</li>
<li><p>连不上 broker 4，因为它的 ip 信息没有更新，新实例都没启动</p>
</li>
</ul>
</li>
<li><p>broker4 的问题是</p>
<ul>
<li><p>存在实例迁移，迁移后执行 <code>remove-controller</code>移除历史 4 的信息失败</p>
</li>
<li><p>自动生成的配置文件中，没有 brokerid 4 的配置</p>
</li>
</ul>
</li>
</ul>
<p>总之 voter 的信息全乱了，当务之急是尽快通过某种方式修正 raft log 中的 voter 的相关信息，使其可以选出 leader。</p>
<h1 id="kafka-源码改造"><a href="#kafka-源码改造" class="headerlink" title="kafka 源码改造"></a>kafka 源码改造</h1><p>我是没能力直接改 kafka 的源码或者用 scala 写工具的，不过可以借助大模型的能力，由我这边提需求，然后让大模型来进行前期调研和代码编写。由于代码较为复杂，且这个模块非常重要，所以使用的是能力比较强的某c姓国外大模型。以下内容包含对模型提问的 prompt 以及模型的回答：</p>
<h2 id="想法1：编写-cli-工具修改落盘的-raft-日志"><a href="#想法1：编写-cli-工具修改落盘的-raft-日志" class="headerlink" title="想法1：编写 cli 工具修改落盘的 raft 日志"></a>想法1：编写 cli 工具修改落盘的 raft 日志</h2><h3 id="原理研究"><a href="#原理研究" class="headerlink" title="原理研究"></a>原理研究</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">当前 kraft kafka 集群存在由于 controller 元信息中 CurrentVoters 信息错误导致 raft 选主无法成功的问题。我们想设置一种机制，原地修改存储在本地的 metadata 信息，来校准其中的 voter 信息。首先，你需要结合源码分析当前通过脚本 kafka-metadata-quorum.sh 来进行 remove-controller 和 add-controller 的具体流程。</span><br></pre></td></tr></table></figure>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br></pre></td><td class="code"><pre><span class="line">基于源码分析，我现在可以提供完整的分析报告：</span><br><span class="line"></span><br><span class="line"><span class="section"># kafka-metadata-quorum.sh 脚本中 remove-controller 和 add-controller 流程分析</span></span><br><span class="line"></span><br><span class="line"><span class="section">## MetadataQuorumCommand 工具类</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**源码位置：**</span> <span class="code">`tools/src/main/java/org/apache/kafka/tools/MetadataQuorumCommand.java:1`</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 是什么</span></span><br><span class="line"></span><br><span class="line">MetadataQuorumCommand 是 Kafka KRaft 模式下用于管理 controller quorum 的命令行工具，通过 <span class="code">`kafka-metadata-quorum.sh`</span> 脚本调用。它提供了添加和移除 controller 节点的功能。</span><br><span class="line"></span><br><span class="line"><span class="section">### 为什么</span></span><br><span class="line"></span><br><span class="line">在 KRaft 集群中，controller 节点组成 Raft quorum 来管理集群元数据。当需要扩容或缩容 controller 节点时，需要动态修改 quorum 成员配置，确保集群的高可用性和一致性。</span><br><span class="line"></span><br><span class="line"><span class="section">### 怎么样</span></span><br><span class="line"></span><br><span class="line">工具通过 Admin 客户端与 KRaft controller 通信，执行 <span class="code">`addRaftVoter`</span> 和 <span class="code">`removeRaftVoter`</span> 操作：</span><br><span class="line"></span><br><span class="line">~~~java</span><br><span class="line">// add-controller 核心逻辑</span><br><span class="line">static void handleAddController(Admin admin, boolean dryRun, Properties props) throws Exception &#123;</span><br><span class="line"><span class="code">    int controllerId = getControllerId(props);</span></span><br><span class="line"><span class="code">    String metadataDirectory = getMetadataDirectory(props);</span></span><br><span class="line"><span class="code">    Uuid directoryId = getMetadataDirectoryId(metadataDirectory);</span></span><br><span class="line"><span class="code">    Set&lt;RaftVoterEndpoint&gt; endpoints = getControllerAdvertisedListeners(props);</span></span><br><span class="line"><span class="code">    if (!dryRun) &#123;</span></span><br><span class="line"><span class="code">        admin.addRaftVoter(controllerId, directoryId, endpoints).all().get();</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// remove-controller 核心逻辑  </span><br><span class="line">static void handleRemoveController(Admin admin, int controllerId, String controllerDirectoryIdString, boolean dryRun) &#123;</span><br><span class="line"><span class="code">    Uuid directoryId = Uuid.fromString(controllerDirectoryIdString);</span></span><br><span class="line"><span class="code">    if (!dryRun) &#123;</span></span><br><span class="line"><span class="code">        admin.removeRaftVoter(controllerId, directoryId).all().get();</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line">&#125;</span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="section">## AddVoterHandler 添加投票者处理器</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**源码位置：**</span> <span class="code">`raft/src/main/java/org/apache/kafka/raft/internals/AddVoterHandler.java:86`</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 是什么</span></span><br><span class="line"></span><br><span class="line">AddVoterHandler 实现了向 KRaft partition 添加 voter 的协议处理逻辑，确保新 voter 能够安全地加入到 Raft quorum 中。</span><br><span class="line"></span><br><span class="line"><span class="section">### 为什么</span></span><br><span class="line"></span><br><span class="line">添加 voter 是一个复杂的分布式操作，需要确保：</span><br><span class="line"></span><br><span class="line"><span class="bullet">1.  </span>集群支持动态重配置</span><br><span class="line"><span class="bullet">2.  </span>新 voter 已经追上日志进度</span><br><span class="line"><span class="bullet">3.  </span>没有并发的 voter 变更操作</span><br><span class="line"><span class="bullet">4.  </span>新配置能够成功提交</span><br><span class="line"></span><br><span class="line"><span class="section">### 怎么样</span></span><br><span class="line"></span><br><span class="line">实现了10步添加流程：</span><br><span class="line"></span><br><span class="line">~~~java</span><br><span class="line">public CompletableFuture<span class="xml"><span class="tag">&lt;<span class="name">AddRaftVoterResponseData</span>&gt;</span></span> handleAddVoterRequest(</span><br><span class="line"><span class="code">    LeaderState&lt;?&gt; leaderState, ReplicaKey voterKey, Endpoints voterEndpoints, long currentTimeMs) &#123;</span></span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="code">    // 1. 检查是否有待处理的 voter 变更请求</span></span><br><span class="line"><span class="code">    if (leaderState.isOperationPending(currentTimeMs)) &#123;</span></span><br><span class="line"><span class="code">        return CompletableFuture.completedFuture(RaftUtil.addVoterResponse(</span></span><br><span class="line"><span class="code">            Errors.REQUEST_TIMED_OUT, "Request timed out waiting for leader to handle previous voter change request"));</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="code">    // 2. 检查 leader 是否已建立 HWM</span></span><br><span class="line"><span class="code">    Optional&lt;Long&gt; highWatermark = leaderState.highWatermark().map(LogOffsetMetadata::offset);</span></span><br><span class="line"><span class="code">    if (!highWatermark.isPresent()) &#123;</span></span><br><span class="line"><span class="code">        return CompletableFuture.completedFuture(RaftUtil.addVoterResponse(</span></span><br><span class="line"><span class="code">            Errors.REQUEST_TIMED_OUT, "Request timed out waiting for leader to establish HWM"));</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="code">    // 3. 检查集群是否支持 kraft.version &gt;= 1</span></span><br><span class="line"><span class="code">    KRaftVersion kraftVersion = partitionState.lastKraftVersion();</span></span><br><span class="line"><span class="code">    if (!kraftVersion.isReconfigSupported()) &#123;</span></span><br><span class="line"><span class="code">        return CompletableFuture.completedFuture(RaftUtil.addVoterResponse(</span></span><br><span class="line"><span class="code">            Errors.UNSUPPORTED_VERSION, "Cluster doesn't support adding voter"));</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="code">    // 4-10. 其他验证和处理步骤...</span></span><br><span class="line">&#125;</span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="section">## RemoveVoterHandler 移除投票者处理器</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**源码位置：**</span> <span class="code">`raft/src/main/java/org/apache/kafka/raft/internals/RemoveVoterHandler.java:77`</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 是什么</span></span><br><span class="line"></span><br><span class="line">RemoveVoterHandler 实现了从 KRaft partition 移除 voter 的协议处理逻辑，确保 voter 能够安全地从 Raft quorum 中移除。</span><br><span class="line"></span><br><span class="line"><span class="section">### 为什么</span></span><br><span class="line"></span><br><span class="line">移除 voter 需要确保：</span><br><span class="line"></span><br><span class="line"><span class="bullet">1.  </span>移除操作不会破坏 quorum 的多数派</span><br><span class="line"><span class="bullet">2.  </span>如果被移除的是当前 leader，需要触发重新选举</span><br><span class="line"><span class="bullet">3.  </span>新的 voter 配置能够成功提交</span><br><span class="line"></span><br><span class="line"><span class="section">### 怎么样</span></span><br><span class="line"></span><br><span class="line">实现了7步移除流程：</span><br><span class="line"></span><br><span class="line">~~~java</span><br><span class="line">public CompletableFuture<span class="xml"><span class="tag">&lt;<span class="name">RemoveRaftVoterResponseData</span>&gt;</span></span> handleRemoveVoterRequest(</span><br><span class="line"><span class="code">    LeaderState&lt;?&gt; leaderState, ReplicaKey voterKey, long currentTimeMs) &#123;</span></span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="code">    // 移除 voter 并创建新的 VoterSet</span></span><br><span class="line"><span class="code">    Optional&lt;VoterSet&gt; newVoters = votersEntry.get().value().removeVoter(voterKey);</span></span><br><span class="line"><span class="code">    if (!newVoters.isPresent()) &#123;</span></span><br><span class="line"><span class="code">        return CompletableFuture.completedFuture(RaftUtil.removeVoterResponse(</span></span><br><span class="line"><span class="code">            Errors.VOTER_NOT_FOUND, "Cannot remove voter from the set of voters"));</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="code">    // 将新的 VotersRecord 追加到日志</span></span><br><span class="line"><span class="code">    RemoveVoterHandlerState state = new RemoveVoterHandlerState(</span></span><br><span class="line"><span class="code">        leaderState.appendVotersRecord(newVoters.get(), currentTimeMs),</span></span><br><span class="line"><span class="code">        time.timer(requestTimeoutMs)</span></span><br><span class="line"><span class="code">    );</span></span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="code">    return state.future();</span></span><br><span class="line">&#125;</span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="section">## VotersRecord 投票者记录</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**源码位置：**</span> <span class="code">`raft/src/main/java/org/apache/kafka/raft/VoterSet.java:245`</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 是什么</span></span><br><span class="line"></span><br><span class="line">VotersRecord 是存储在 KRaft 日志中的控制记录，包含了当前 quorum 中所有 voter 的信息，包括 ID、目录 ID、网络端点和支持的 KRaft 版本。</span><br><span class="line"></span><br><span class="line"><span class="section">### 为什么</span></span><br><span class="line"></span><br><span class="line">VotersRecord 作为 Raft 日志中的控制记录，确保 voter 配置变更的持久化和一致性。所有节点通过读取这些记录来了解当前的 quorum 配置。</span><br><span class="line"></span><br><span class="line"><span class="section">### 怎么样</span></span><br><span class="line"></span><br><span class="line">VoterSet 与 VotersRecord 之间可以相互转换：</span><br><span class="line"></span><br><span class="line">~~~java</span><br><span class="line">// VoterSet 转换为 VotersRecord</span><br><span class="line">public VotersRecord toVotersRecord(short version) &#123;</span><br><span class="line"><span class="code">    Function&lt;VoterNode, VotersRecord.Voter&gt; voterConvertor = voter -&gt; &#123;</span></span><br><span class="line"><span class="code">        return new VotersRecord.Voter()</span></span><br><span class="line"><span class="code">            .setVoterId(voter.voterKey().id())</span></span><br><span class="line"><span class="code">            .setVoterDirectoryId(voter.voterKey().directoryId().orElse(Uuid.ZERO_UUID))</span></span><br><span class="line"><span class="code">            .setEndpoints(new VotersRecord.EndpointCollection(endpoints))</span></span><br><span class="line"><span class="code">            .setKRaftVersionFeature(kraftVersionFeature);</span></span><br><span class="line"><span class="code">    &#125;;</span></span><br><span class="line"><span class="code">    return new VotersRecord().setVersion(version).setVoters(voterRecordVoters);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// VotersRecord 转换为 VoterSet</span><br><span class="line">public static VoterSet fromVotersRecord(VotersRecord voters) &#123;</span><br><span class="line"><span class="code">    HashMap&lt;Integer, VoterNode&gt; voterNodes = new HashMap&lt;&gt;(voters.voters().size());</span></span><br><span class="line"><span class="code">    for (VotersRecord.Voter voter: voters.voters()) &#123;</span></span><br><span class="line"><span class="code">        voterNodes.put(voter.voterId(), new VoterNode(</span></span><br><span class="line"><span class="code">            ReplicaKey.of(voter.voterId(), voter.voterDirectoryId()),</span></span><br><span class="line"><span class="code">            Endpoints.fromVotersRecordEndpoints(voter.endpoints()),</span></span><br><span class="line"><span class="code">            new SupportedVersionRange(...)</span></span><br><span class="line"><span class="code">        ));</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">    return new VoterSet(voterNodes);</span></span><br><span class="line">&#125;</span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="section">## 交互流程</span></span><br><span class="line"></span><br><span class="line"><span class="section">### add-controller 流程</span></span><br><span class="line"></span><br><span class="line">~~~mermaid</span><br><span class="line">sequenceDiagram</span><br><span class="line"><span class="code">    participant CLI as kafka-metadata-quorum.sh</span></span><br><span class="line"><span class="code">    participant MQC as MetadataQuorumCommand</span></span><br><span class="line"><span class="code">    participant Admin as KafkaAdminClient</span></span><br><span class="line"><span class="code">    participant Leader as KRaft Leader</span></span><br><span class="line"><span class="code">    participant AVH as AddVoterHandler</span></span><br><span class="line"><span class="code">    participant Log as KRaft Log</span></span><br><span class="line"></span><br><span class="line"><span class="code">    CLI-&gt;&gt;MQC: add-controller --command-config config.properties</span></span><br><span class="line"><span class="code">    MQC-&gt;&gt;MQC: 解析配置文件获取 controllerId, directoryId, endpoints</span></span><br><span class="line"><span class="code">    MQC-&gt;&gt;Admin: addRaftVoter(controllerId, directoryId, endpoints)</span></span><br><span class="line"><span class="code">    Admin-&gt;&gt;Leader: AddRaftVoterRequest</span></span><br><span class="line"><span class="code">    Leader-&gt;&gt;AVH: handleAddVoterRequest()</span></span><br><span class="line"><span class="code">    AVH-&gt;&gt;AVH: 验证前置条件(HWM, kraft.version, 无并发操作)</span></span><br><span class="line"><span class="code">    AVH-&gt;&gt;Leader: 发送 API_VERSIONS 请求验证新 voter</span></span><br><span class="line"><span class="code">    Leader--&gt;&gt;AVH: API_VERSIONS 响应</span></span><br><span class="line"><span class="code">    AVH-&gt;&gt;AVH: 验证新 voter 支持的 kraft.version</span></span><br><span class="line"><span class="code">    AVH-&gt;&gt;AVH: 检查新 voter 是否已追上日志</span></span><br><span class="line"><span class="code">    AVH-&gt;&gt;Log: appendVotersRecord(newVoterSet)</span></span><br><span class="line"><span class="code">    Log-&gt;&gt;Log: 等待 VotersRecord 提交</span></span><br><span class="line"><span class="code">    Log--&gt;&gt;AVH: 提交完成</span></span><br><span class="line"><span class="code">    AVH--&gt;&gt;Admin: AddRaftVoterResponse(SUCCESS)</span></span><br><span class="line"><span class="code">    Admin--&gt;&gt;MQC: 操作完成</span></span><br><span class="line"><span class="code">    MQC--&gt;&gt;CLI: 输出成功信息</span></span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="section">### remove-controller 流程</span></span><br><span class="line"></span><br><span class="line">~~~mermaid</span><br><span class="line">sequenceDiagram</span><br><span class="line"><span class="code">    participant CLI as kafka-metadata-quorum.sh</span></span><br><span class="line"><span class="code">    participant MQC as MetadataQuorumCommand</span></span><br><span class="line"><span class="code">    participant Admin as KafkaAdminClient</span></span><br><span class="line"><span class="code">    participant Leader as KRaft Leader</span></span><br><span class="line"><span class="code">    participant RVH as RemoveVoterHandler</span></span><br><span class="line"><span class="code">    participant Log as KRaft Log</span></span><br><span class="line"></span><br><span class="line"><span class="code">    CLI-&gt;&gt;MQC: remove-controller -i controllerId -d directoryId</span></span><br><span class="line"><span class="code">    MQC-&gt;&gt;Admin: removeRaftVoter(controllerId, directoryId)</span></span><br><span class="line"><span class="code">    Admin-&gt;&gt;Leader: RemoveRaftVoterRequest</span></span><br><span class="line"><span class="code">    Leader-&gt;&gt;RVH: handleRemoveVoterRequest()</span></span><br><span class="line"><span class="code">    RVH-&gt;&gt;RVH: 验证前置条件(HWM, kraft.version, 无并发操作)</span></span><br><span class="line"><span class="code">    RVH-&gt;&gt;RVH: 从当前 VoterSet 中移除指定 voter</span></span><br><span class="line"><span class="code">    RVH-&gt;&gt;Log: appendVotersRecord(newVoterSet)</span></span><br><span class="line"><span class="code">    Log-&gt;&gt;Log: 等待 VotersRecord 提交</span></span><br><span class="line"><span class="code">    Log--&gt;&gt;RVH: 提交完成</span></span><br><span class="line"><span class="code">    RVH-&gt;&gt;RVH: 检查当前 leader 是否被移除</span></span><br><span class="line"><span class="code">    alt 当前 leader 被移除</span></span><br><span class="line"><span class="code">        RVH-&gt;&gt;Leader: requestResign()</span></span><br><span class="line"><span class="code">    end</span></span><br><span class="line"><span class="code">    RVH--&gt;&gt;Admin: RemoveRaftVoterResponse(SUCCESS)</span></span><br><span class="line"><span class="code">    Admin--&gt;&gt;MQC: 操作完成</span></span><br><span class="line"><span class="code">    MQC--&gt;&gt;CLI: 输出成功信息</span></span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="strong">**关键步骤源码映射：**</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">1.  </span>脚本入口 → <span class="code">`bin/kafka-metadata-quorum.sh:17`</span> - 调用 MetadataQuorumCommand</span><br><span class="line"><span class="bullet">2.  </span>添加处理 → <span class="code">`tools/src/main/java/org/apache/kafka/tools/MetadataQuorumCommand.java:430`</span> - handleAddController</span><br><span class="line"><span class="bullet">3.  </span>移除处理 → <span class="code">`tools/src/main/java/org/apache/kafka/tools/MetadataQuorumCommand.java:4711`</span> - handleRemoveController</span><br><span class="line"><span class="bullet">4.  </span>Admin 添加 → <span class="code">`clients/src/main/java/org/apache/kafka/clients/admin/KafkaAdminClient.java:4657`</span> - addRaftVoter</span><br><span class="line"><span class="bullet">5.  </span>Admin 移除 → <span class="code">`clients/src/main/java/org/apache/kafka/clients/admin/KafkaAdminClient.java:4711`</span> - removeRaftVoter</span><br><span class="line"><span class="bullet">6.  </span>Raft 添加处理 → <span class="code">`raft/src/main/java/org/apache/kafka/raft/internals/AddVoterHandler.java:86`</span> - handleAddVoterRequest</span><br><span class="line"><span class="bullet">7.  </span>Raft 移除处理 → <span class="code">`raft/src/main/java/org/apache/kafka/raft/internals/RemoveVoterHandler.java:77`</span> - handleRemoveVoterRequest</span><br><span class="line"><span class="bullet">8.  </span>记录持久化 → <span class="code">`raft/src/main/java/org/apache/kafka/raft/VoterSet.java:245`</span> - toVotersRecord</span><br><span class="line"></span><br><span class="line">这个分析揭示了 KRaft 集群中 controller 动态重配置的完整机制，为实现原地修改本地 metadata 信息来校准 voter 信息提供了重要的技术基础。</span><br></pre></td></tr></table></figure>
<h3 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在一个 kafka 实例停机的场景下，通过外部 cli 工具强制写入干预的 metadata 是否可行？</span><br></pre></td></tr></table></figure>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line">基于深入的源码分析，我现在可以全面回答关于在 Kafka 实例停机场景下通过外部 CLI 工具强制写入干预 metadata 的可行性问题：</span><br><span class="line"></span><br><span class="line"><span class="section"># 停机场景下外部 CLI 工具强制写入 Metadata 的可行性分析</span></span><br><span class="line"></span><br><span class="line"><span class="section">## KRaft Metadata 存储机制</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**源码位置：**</span> <span class="code">`raft/src/main/java/org/apache/kafka/snapshot/Snapshots.java:48`</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 是什么</span></span><br><span class="line"></span><br><span class="line">KRaft 集群的 metadata 存储在 <span class="code">`__cluster_metadata-0`</span> 目录中，包含：</span><br><span class="line"></span><br><span class="line"><span class="bullet">1.  </span><span class="strong">**Snapshot 文件**</span> - 存储完整的集群状态快照</span><br><span class="line"><span class="bullet">2.  </span><span class="strong">**Log 文件**</span> - 存储增量的 Raft 日志记录</span><br><span class="line"><span class="bullet">3.  </span><span class="strong">**meta.properties**</span> - 存储节点基本信息（node.id, directory.id, cluster.id）</span><br><span class="line"></span><br><span class="line"><span class="section">### 为什么</span></span><br><span class="line"></span><br><span class="line">KRaft 使用 Raft 协议确保 metadata 的一致性，所有状态变更都必须通过 Raft 日志提交。这种设计保证了集群的强一致性，但也限制了直接修改本地文件的可能性。</span><br><span class="line"></span><br><span class="line"><span class="section">### 怎么样</span></span><br><span class="line"></span><br><span class="line">关键的存储组件：</span><br><span class="line"></span><br><span class="line">~~~java</span><br><span class="line">// Bootstrap Snapshot ID - 初始化时的特殊快照</span><br><span class="line">public static final OffsetAndEpoch BOOTSTRAP<span class="emphasis">_SNAPSHOT_</span>ID = new OffsetAndEpoch(0, 0);</span><br><span class="line"></span><br><span class="line">// VotersRecord 在 snapshot 中的存储格式</span><br><span class="line">public VotersRecord toVotersRecord(short version) &#123;</span><br><span class="line"><span class="code">    return new VotersRecord()</span></span><br><span class="line"><span class="code">        .setVersion(version)</span></span><br><span class="line"><span class="code">        .setVoters(voterRecordVoters);</span></span><br><span class="line">&#125;</span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="section">## Bootstrap Snapshot 机制</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**源码位置：**</span> <span class="code">`metadata/src/main/java/org/apache/kafka/metadata/storage/Formatter.java:508`</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 是什么</span></span><br><span class="line"></span><br><span class="line">Bootstrap Snapshot 是 KRaft 集群初始化时创建的特殊快照，包含初始的 voter 配置和集群基础信息。</span><br><span class="line"></span><br><span class="line"><span class="section">### 为什么</span></span><br><span class="line"></span><br><span class="line">Bootstrap Snapshot 为新集群提供初始状态，避免了从空日志开始的复杂性。它在集群格式化时创建，后续启动时会被加载。</span><br><span class="line"></span><br><span class="line"><span class="section">### 怎么样</span></span><br><span class="line"></span><br><span class="line">Formatter 创建 Bootstrap Snapshot 的过程：</span><br><span class="line"></span><br><span class="line">~~~java</span><br><span class="line">// 在格式化时创建 bootstrap snapshot</span><br><span class="line">setRawSnapshotWriter(FileRawSnapshotWriter.create(</span><br><span class="line"><span class="code">    clusterMetadataDirectory.toPath(),</span></span><br><span class="line"><span class="code">    Snapshots.BOOTSTRAP_SNAPSHOT_ID)).</span></span><br><span class="line">setKraftVersion(KRaftVersion.fromFeatureLevel(kraftVersion)).</span><br><span class="line">setVoterSet(Optional.of(voterSet));</span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="section">## Metadata 加载和恢复机制</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**源码位置：**</span> <span class="code">`raft/src/main/java/org/apache/kafka/raft/internals/KRaftControlRecordStateMachine.java:238`</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 是什么</span></span><br><span class="line"></span><br><span class="line">KRaft 启动时会自动加载最新的 snapshot 和后续的 log 记录来恢复集群状态。</span><br><span class="line"></span><br><span class="line"><span class="section">### 为什么</span></span><br><span class="line"></span><br><span class="line">这确保了节点重启后能够恢复到最新的一致状态，包括最新的 voter 配置信息。</span><br><span class="line"></span><br><span class="line"><span class="section">### 怎么样</span></span><br><span class="line"></span><br><span class="line">状态恢复的关键逻辑：</span><br><span class="line"></span><br><span class="line">~~~java</span><br><span class="line">private void maybeLoadSnapshot() &#123;</span><br><span class="line"><span class="code">    if ((nextOffset == STARTING_NEXT_OFFSET || nextOffset &lt; log.startOffset()) &amp;&amp; log.latestSnapshot().isPresent()) &#123;</span></span><br><span class="line"><span class="code">        RawSnapshotReader rawSnapshot = log.latestSnapshot().get();</span></span><br><span class="line"><span class="code">        </span></span><br><span class="line"><span class="code">        // 加载 snapshot 恢复状态</span></span><br><span class="line"><span class="code">        try (SnapshotReader&lt;?&gt; reader = RecordsSnapshotReader.of(</span></span><br><span class="line"><span class="code">            rawSnapshot, serde, BufferSupplier.create(), Integer.MAX_VALUE, true)) &#123;</span></span><br><span class="line"><span class="code">            </span></span><br><span class="line"><span class="code">            while (reader.hasNext()) &#123;</span></span><br><span class="line"><span class="code">                // 处理 snapshot 中的记录，包括 VotersRecord</span></span><br><span class="line"><span class="code">            &#125;</span></span><br><span class="line"><span class="code">        &#125;</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line">&#125;</span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="section">## 可行性分析</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 技术可行性：**部分可行**</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**可行的方案：**</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">1.  </span><span class="strong">**修改 Bootstrap Snapshot**</span></span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="code">    *   在集群完全停机的情况下，可以重新生成包含正确 voter 信息的 bootstrap snapshot</span></span><br><span class="line"><span class="code">    *   需要删除所有节点的现有 log 文件，只保留新的 bootstrap snapshot</span></span><br><span class="line"><span class="code">    *   适用于集群初始化阶段的 voter 信息错误</span></span><br><span class="line"><span class="bullet">2.  </span><span class="strong">**使用 Formatter 工具重新格式化**</span></span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="code">    *   利用现有的 `kafka-storage.sh format` 工具重新格式化集群</span></span><br><span class="line"><span class="code">    *   可以指定正确的 voter 配置</span></span><br><span class="line"><span class="code">    *   但会丢失所有现有的 metadata 信息</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**不可行的方案：**</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">1.  </span><span class="strong">**直接修改现有 Snapshot/Log 文件**</span></span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="code">    *   Raft 日志具有严格的顺序性和校验机制</span></span><br><span class="line"><span class="code">    *   直接修改会破坏日志的完整性，导致启动失败</span></span><br><span class="line"><span class="bullet">2.  </span><span class="strong">**仅修改部分节点**</span></span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="code">    *   Raft 协议要求多数派一致，单独修改部分节点无法形成有效的 quorum</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 实现流程</span></span><br><span class="line"></span><br><span class="line">~~~mermaid</span><br><span class="line">flowchart TD</span><br><span class="line"><span class="code">    A[集群完全停机] --&gt; B[备份现有 metadata]</span></span><br><span class="line"><span class="code">    B --&gt; C[清理所有节点的 __cluster_metadata 目录]</span></span><br><span class="line"><span class="code">    C --&gt; D[使用正确的 voter 配置重新格式化]</span></span><br><span class="line"><span class="code">    D --&gt; E[启动集群验证]</span></span><br><span class="line"><span class="code">    E --&gt; F&#123;验证成功?&#125;</span></span><br><span class="line"><span class="code">    F --&gt;|是| G[恢复其他 metadata 信息]</span></span><br><span class="line"><span class="code">    F --&gt;|否| H[回滚到备份状态]</span></span><br><span class="line"><span class="code">    G --&gt; I[集群正常运行]</span></span><br><span class="line"><span class="code">    H --&gt; J[问题排查]</span></span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="strong">**关键步骤源码映射：**</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">1.  </span>停机检查 → <span class="code">`raft/src/main/java/org/apache/kafka/raft/KafkaRaftClient.java:470`</span> - initialize 方法</span><br><span class="line"><span class="bullet">2.  </span>清理目录 → <span class="code">`metadata/src/main/java/org/apache/kafka/metadata/storage/Formatter.java:394`</span> - 格式化前检查</span><br><span class="line"><span class="bullet">3.  </span>重新格式化 → <span class="code">`metadata/src/main/java/org/apache/kafka/metadata/storage/Formatter.java:508`</span> - 创建 bootstrap snapshot</span><br><span class="line"><span class="bullet">4.  </span>状态恢复 → <span class="code">`raft/src/main/java/org/apache/kafka/raft/internals/KRaftControlRecordStateMachine.java:238`</span> - maybeLoadSnapshot</span><br><span class="line"></span><br><span class="line"><span class="section">### 风险和限制</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**高风险：**</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">*   </span><span class="strong">**数据丢失**</span>：重新格式化会丢失所有现有的 topic、partition、ACL 等 metadata</span><br><span class="line"><span class="bullet">*   </span><span class="strong">**不可逆性**</span>：一旦执行，无法简单回滚</span><br><span class="line"><span class="bullet">*   </span><span class="strong">**集群不一致**</span>：如果操作不当，可能导致集群永久性损坏</span><br><span class="line"></span><br><span class="line"><span class="strong">**技术限制：**</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">*   </span>必须在所有节点完全停机的情况下执行</span><br><span class="line"><span class="bullet">*   </span>需要手动重建所有 metadata 信息</span><br><span class="line"><span class="bullet">*   </span>无法保留历史的配置变更记录</span><br><span class="line"></span><br><span class="line"><span class="section">### 建议的替代方案</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">1.  </span><span class="strong">**使用正常的 remove/add-controller 流程**</span></span><br><span class="line"><span class="code">    *   如果集群仍能形成 quorum，优先使用标准的动态重配置</span></span><br><span class="line"><span class="bullet">2.  </span><span class="strong">**部分节点重建**</span></span><br><span class="line"><span class="code">    *   保留正确的节点，只重建有问题的节点</span></span><br><span class="line"><span class="bullet">3.  </span><span class="strong">**集群迁移**</span></span><br><span class="line"><span class="code">    *   创建新的正确配置的集群，迁移数据</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**结论：**</span> 在 Kafka 实例停机场景下通过外部 CLI 工具强制写入干预 metadata 在技术上是可行的，但风险极高且会导致数据丢失。只有在集群完全无法恢复且可以接受重建所有 metadata 的情况下才应考虑此方案。更安全的做法是使用标准的动态重配置流程或集群迁移方案。</span><br></pre></td></tr></table></figure>
<h3 id="remove-add-controller-流程确认"><a href="#remove-add-controller-流程确认" class="headerlink" title="remove/add-controller 流程确认"></a>remove/add-controller 流程确认</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">目前的问题是，raft 无法选主，导致无法使用  kafka-metadata-quorum.sh  来进行 add-controller 和 remove-controler 的操作</span><br></pre></td></tr></table></figure>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><span class="line">基于深入的源码分析，我现在可以提供针对 Raft 无法选主场景的完整解决方案：</span><br><span class="line"></span><br><span class="line"><span class="section"># Raft 无法选主场景下的离线修复方案</span></span><br><span class="line"></span><br><span class="line"><span class="section">## Raft 选主失败的根本原因</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**源码位置：**</span> <span class="code">`raft/src/main/java/org/apache/kafka/raft/CandidateState.java:98`</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 是什么</span></span><br><span class="line"></span><br><span class="line">Raft 选主需要获得 <span class="strong">**majority（多数派）**</span> 的投票才能成功。当 CurrentVoters 信息错误时，可能导致：</span><br><span class="line"></span><br><span class="line"><span class="bullet">1.  </span>实际存活的节点无法构成多数派</span><br><span class="line"><span class="bullet">2.  </span>节点无法找到其他 voter 进行通信</span><br><span class="line"><span class="bullet">3.  </span>VoterSet 不匹配导致选举失败</span><br><span class="line"></span><br><span class="line"><span class="section">### 为什么</span></span><br><span class="line"></span><br><span class="line">Raft 协议的安全性依赖于多数派原则，确保任何时刻最多只有一个 leader：</span><br><span class="line"></span><br><span class="line">~~~java</span><br><span class="line">public int majoritySize() &#123;</span><br><span class="line"><span class="code">    return voteStates.size() / 2 + 1;  // 需要超过一半的投票</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public boolean isVoteGranted() &#123;</span><br><span class="line"><span class="code">    return numGranted() &gt;= majoritySize();  // 检查是否获得多数派支持</span></span><br><span class="line">&#125;</span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="section">### 怎么样</span></span><br><span class="line"></span><br><span class="line">选主失败的典型场景：</span><br><span class="line"></span><br><span class="line"><span class="bullet">*   </span>3节点集群中2个节点的 CurrentVoters 信息错误</span><br><span class="line"><span class="bullet">*   </span>5节点集群中3个节点无法相互发现</span><br><span class="line"><span class="bullet">*   </span>VoterSet 配置与实际网络拓扑不匹配</span><br><span class="line"></span><br><span class="line"><span class="section">## VoterSet 重叠多数派检查</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**源码位置：**</span> <span class="code">`raft/src/main/java/org/apache/kafka/raft/VoterSet.java:285`</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 是什么</span></span><br><span class="line"></span><br><span class="line">VoterSet 的 <span class="code">`hasOverlappingMajority`</span> 方法确保新旧 voter 配置之间有足够的重叠，防止脑裂：</span><br><span class="line"></span><br><span class="line">~~~java</span><br><span class="line">public boolean hasOverlappingMajority(VoterSet that) &#123;</span><br><span class="line"><span class="code">    Set&lt;ReplicaKey&gt; thisReplicaKeys = voterKeys();</span></span><br><span class="line"><span class="code">    Set&lt;ReplicaKey&gt; thatReplicaKeys = that.voterKeys();</span></span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="code">    if (Utils.diff(HashSet::new, thisReplicaKeys, thatReplicaKeys).size() &gt; 1) return false;</span></span><br><span class="line"><span class="code">    return Utils.diff(HashSet::new, thatReplicaKeys, thisReplicaKeys).size() &lt;= 1;</span></span><br><span class="line">&#125;</span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="section">### 为什么</span></span><br><span class="line"></span><br><span class="line">这个检查确保在 voter 配置变更过程中，新旧配置之间最多只能有一个节点的差异，保证了配置变更的安全性。</span><br><span class="line"></span><br><span class="line"><span class="section">### 怎么样</span></span><br><span class="line"></span><br><span class="line">当 CurrentVoters 信息严重错误时，可能导致：</span><br><span class="line"></span><br><span class="line"><span class="bullet">*   </span>新配置与当前配置没有重叠多数派</span><br><span class="line"><span class="bullet">*   </span>无法通过正常的 add/remove-controller 流程修复</span><br><span class="line"><span class="bullet">*   </span>集群陷入无法选主的死锁状态</span><br><span class="line"></span><br><span class="line"><span class="section">## StorageTool 格式化工具</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**源码位置：**</span> <span class="code">`core/src/main/scala/kafka/tools/StorageTool.scala:105`</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 是什么</span></span><br><span class="line"></span><br><span class="line">StorageTool 是 KRaft 集群的格式化工具，可以重新初始化集群的 metadata 存储，包括正确的 voter 配置。</span><br><span class="line"></span><br><span class="line"><span class="section">### 为什么</span></span><br><span class="line"></span><br><span class="line">当集群的 voter 配置严重错误且无法通过动态重配置修复时，格式化工具提供了最后的修复手段。</span><br><span class="line"></span><br><span class="line"><span class="section">### 怎么样</span></span><br><span class="line"></span><br><span class="line">关键的格式化参数：</span><br><span class="line"></span><br><span class="line">~~~scala</span><br><span class="line">def runFormatCommand(namespace: Namespace, config: KafkaConfig, printStream: PrintStream): Unit = &#123;</span><br><span class="line"><span class="code">    val formatter = new Formatter().</span></span><br><span class="line"><span class="code">        setNodeId(config.nodeId).</span></span><br><span class="line"><span class="code">        setClusterId(namespace.getString("cluster_id")).</span></span><br><span class="line"><span class="code">        setControllerListenerName(config.controllerListenerNames.head).</span></span><br><span class="line"><span class="code">        setMetadataLogDirectory(config.metadataLogDir)</span></span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="code">    // 设置初始 controller 配置</span></span><br><span class="line"><span class="code">    Option(namespace.getString("initial_controllers")).</span></span><br><span class="line"><span class="code">        foreach(v =&gt; formatter.setInitialControllers(DynamicVoters.parse(v)))</span></span><br><span class="line">&#125;</span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="section">## 离线修复方案</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 方案一：完全重新格式化（推荐）</span></span><br><span class="line"></span><br><span class="line">~~~mermaid</span><br><span class="line">flowchart TD</span><br><span class="line"><span class="code">    A[确认集群完全停机] --&gt; B[备份重要数据]</span></span><br><span class="line"><span class="code">    B --&gt; C[清理所有节点的 __cluster_metadata 目录]</span></span><br><span class="line"><span class="code">    C --&gt; D[准备正确的 voter 配置]</span></span><br><span class="line"><span class="code">    D --&gt; E[使用 kafka-storage.sh format 重新格式化]</span></span><br><span class="line"><span class="code">    E --&gt; F[逐个启动节点]</span></span><br><span class="line"><span class="code">    F --&gt; G[验证选主成功]</span></span><br><span class="line"><span class="code">    G --&gt; H[重建 metadata 信息]</span></span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="strong">**具体操作步骤：**</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">1.  </span><span class="strong">**停机和备份**</span></span><br><span class="line"></span><br><span class="line">~~~bash</span><br><span class="line"><span class="section"># 停止所有 Kafka 节点</span></span><br><span class="line">systemctl stop kafka</span><br><span class="line"></span><br><span class="line"><span class="section"># 备份现有配置和重要数据</span></span><br><span class="line">cp -r /var/kafka-logs/<span class="emphasis">__cluster_</span>metadata-0 /backup/cluster<span class="emphasis">_metadata_</span>backup</span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="bullet">2.  </span><span class="strong">**清理和格式化**</span></span><br><span class="line"></span><br><span class="line">~~~bash</span><br><span class="line"><span class="section"># 在每个节点上清理 metadata 目录</span></span><br><span class="line">rm -rf /var/kafka-logs/<span class="emphasis">__cluster_</span>metadata-0/*</span><br><span class="line"></span><br><span class="line"><span class="section"># 使用正确的 voter 配置重新格式化</span></span><br><span class="line">kafka-storage.sh format \</span><br><span class="line"><span class="code">    --config /etc/kafka/server.properties \</span></span><br><span class="line"><span class="code">    --cluster-id $(kafka-storage.sh random-uuid) \</span></span><br><span class="line"><span class="code">    --initial-controllers "1@controller1:9093:uuid1,2@controller2:9093:uuid2,3@controller3:9093:uuid3"</span></span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="bullet">3.  </span><span class="strong">**启动和验证**</span></span><br><span class="line"></span><br><span class="line">~~~bash</span><br><span class="line"><span class="section"># 逐个启动节点</span></span><br><span class="line">systemctl start kafka</span><br><span class="line"></span><br><span class="line"><span class="section"># 验证选主状态</span></span><br><span class="line">kafka-metadata-quorum.sh --bootstrap-controller controller1:9093 describe --status</span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="section">### 方案二：部分节点重建（风险较高）</span></span><br><span class="line"></span><br><span class="line">适用于部分节点的 voter 信息正确的场景：</span><br><span class="line"></span><br><span class="line">~~~mermaid</span><br><span class="line">flowchart TD</span><br><span class="line"><span class="code">    A[识别正确配置的节点] --&gt; B[停止错误配置的节点]</span></span><br><span class="line"><span class="code">    B --&gt; C[清理错误节点的 metadata]</span></span><br><span class="line"><span class="code">    C --&gt; D[使用正确节点的配置重新格式化错误节点]</span></span><br><span class="line"><span class="code">    D --&gt; E[启动所有节点]</span></span><br><span class="line"><span class="code">    E --&gt; F[验证集群状态]</span></span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="section">### 方案三：手动修改 Bootstrap Snapshot（高风险）</span></span><br><span class="line"></span><br><span class="line">仅在特殊情况下考虑：</span><br><span class="line"></span><br><span class="line"><span class="bullet">1.  </span><span class="strong">**分析现有 snapshot**</span></span><br><span class="line"></span><br><span class="line">~~~bash</span><br><span class="line"><span class="section"># 使用 kafka-dump-log.sh 分析现有 snapshot</span></span><br><span class="line">kafka-dump-log.sh --files /var/kafka-logs/<span class="emphasis">__cluster_</span>metadata-0/00000000000000000000.log</span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="bullet">2.  </span><span class="strong">**创建新的 bootstrap snapshot**</span></span><br><span class="line"></span><br><span class="line">~~~java</span><br><span class="line">// 使用 Formatter 创建包含正确 voter 信息的 bootstrap snapshot</span><br><span class="line">VoterSet correctVoters = VoterSet.fromVotersRecord(correctVotersRecord);</span><br><span class="line">RecordsSnapshotWriter.Builder builder = new RecordsSnapshotWriter.Builder()</span><br><span class="line"><span class="code">    .setRawSnapshotWriter(FileRawSnapshotWriter.create(metadataDir, BOOTSTRAP_SNAPSHOT_ID))</span></span><br><span class="line"><span class="code">    .setVoterSet(Optional.of(correctVoters));</span></span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="section">## 风险评估和注意事项</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 高风险因素</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">1.  </span><span class="strong">**数据丢失**</span>：重新格式化会丢失所有 topic、partition、ACL 等 metadata</span><br><span class="line"><span class="bullet">2.  </span><span class="strong">**不可逆性**</span>：操作无法简单回滚</span><br><span class="line"><span class="bullet">3.  </span><span class="strong">**时间窗口**</span>：需要较长的停机时间</span><br><span class="line"></span><br><span class="line"><span class="section">### 降低风险的措施</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">1.  </span><span class="strong">**完整备份**</span>：备份所有配置文件和 metadata 目录</span><br><span class="line"><span class="bullet">2.  </span><span class="strong">**测试环境验证**</span>：在测试环境先验证修复流程</span><br><span class="line"><span class="bullet">3.  </span><span class="strong">**分步执行**</span>：逐步启动节点，及时发现问题</span><br><span class="line"><span class="bullet">4.  </span><span class="strong">**监控验证**</span>：密切监控选主过程和集群状态</span><br><span class="line"></span><br><span class="line"><span class="section">### 关键步骤源码映射</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">1.  </span>格式化工具 → <span class="code">`core/src/main/scala/kafka/tools/StorageTool.scala:105`</span> - runFormatCommand</span><br><span class="line"><span class="bullet">2.  </span>Bootstrap Snapshot 创建 → <span class="code">`metadata/src/main/java/org/apache/kafka/metadata/storage/Formatter.java:508`</span> - 创建初始快照</span><br><span class="line"><span class="bullet">3.  </span>VoterSet 验证 → <span class="code">`raft/src/main/java/org/apache/kafka/raft/VoterSet.java:285`</span> - hasOverlappingMajority</span><br><span class="line"><span class="bullet">4.  </span>选主逻辑 → <span class="code">`raft/src/main/java/org/apache/kafka/raft/CandidateState.java:127`</span> - isVoteGranted</span><br><span class="line"><span class="bullet">5.  </span>状态恢复 → <span class="code">`raft/src/main/java/org/apache/kafka/raft/internals/KRaftControlRecordStateMachine.java:238`</span> - maybeLoadSnapshot</span><br><span class="line"></span><br><span class="line"><span class="section">## 结论</span></span><br><span class="line"></span><br><span class="line">在 Raft 无法选主的场景下，<span class="strong">**完全重新格式化是最可靠的解决方案**</span>。虽然会导致 metadata 丢失，但能够彻底解决 CurrentVoters 信息错误的问题。关键是要：</span><br><span class="line"></span><br><span class="line"><span class="bullet">1.  </span>确保所有节点完全停机</span><br><span class="line"><span class="bullet">2.  </span>使用正确的 voter 配置进行格式化</span><br><span class="line"><span class="bullet">3.  </span>按顺序启动节点并验证选主成功</span><br><span class="line"><span class="bullet">4.  </span>重建必要的 metadata 信息</span><br><span class="line"></span><br><span class="line">这种方案虽然激进，但在集群完全不可用的情况下是最有效的恢复手段。</span><br></pre></td></tr></table></figure>
<h3 id="最终结论"><a href="#最终结论" class="headerlink" title="最终结论"></a>最终结论</h3><ul>
<li><p>首先，不可能完全格式化集群元信息，这个和重建集群没区别，会丢失存量的所有 topic 和 broker 信息，约等于丢失全部存量的数据，这是不可接受的。</p>
</li>
<li><p>其次，这要求所有节点完全停机，这也是不可能的，因为相关的 kafka 集群规模可能有上百个节点，全部停机，然后人工依次格式化集群信息的成本太高了。</p>
</li>
<li><p>综上，没法直接修改 metadata 的信息，所以没有实现相关写入工具的必要</p>
</li>
</ul>
<h2 id="想法2：干预-raft-voter-列表初始化"><a href="#想法2：干预-raft-voter-列表初始化" class="headerlink" title="想法2：干预 raft voter 列表初始化"></a>想法2：干预 raft voter 列表初始化</h2><p>也即在 voter 启动时，通过某种方式干预它获取到的 voter 列表，将问题 voter 移除，或者强制覆盖原有的 voter 信息。</p>
<h3 id="原理研究-1"><a href="#原理研究-1" class="headerlink" title="原理研究"></a>原理研究</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">当前 kraft kafka 集群存在由于 controller 元信息中 CurrentVoters 信息错误导致 raft 选主无法成功的问题。我们需要为 kafka 打一个 patch，支持从配置文件中加载干预的 voter 列表，用以覆盖从集群元信息中读取的列表。首先，你需要结合源码分析 kafka 的 kraft 是如何加载和维护 voter 列表信息的</span><br></pre></td></tr></table></figure>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line">现在让我基于源码分析来回答您的问题。根据我对 Kafka KRaft 源码的深入分析，我将按照 AGENTS.md 的规范来阐述 voter 列表的加载和维护机制。</span><br><span class="line"></span><br><span class="line"><span class="section">## QuorumConfig - Voter 配置解析器</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**源码位置：**</span> <span class="code">`raft/src/main/java/org/apache/kafka/raft/QuorumConfig.java:57`</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 是什么</span></span><br><span class="line"></span><br><span class="line">QuorumConfig 是 KRaft 模式下 voter 配置的核心解析器，负责将配置文件中的 <span class="code">`controller.quorum.voters`</span> 参数解析为可用的 voter 地址映射。</span><br><span class="line"></span><br><span class="line"><span class="section">### 为什么</span></span><br><span class="line"></span><br><span class="line">解决了 KRaft 集群启动时需要知道所有 voter 节点地址信息的问题。传统 Zookeeper 模式下，节点信息存储在 Zookeeper 中，而 KRaft 模式需要通过静态配置来初始化 voter 集合。</span><br><span class="line"></span><br><span class="line"><span class="section">### 怎么样</span></span><br><span class="line"></span><br><span class="line">~~~java</span><br><span class="line">public static final String QUORUM<span class="emphasis">_VOTERS_</span>CONFIG = QUORUM_PREFIX + "voters";</span><br><span class="line">public static final String QUORUM<span class="emphasis">_VOTERS_</span>DOC = "Map of id/endpoint information for " +</span><br><span class="line"><span class="code">    "the set of voters in a comma-separated list of &lt;code&gt;&#123;id&#125;@&#123;host&#125;:&#123;port&#125;&lt;/code&gt; entries.";</span></span><br><span class="line"></span><br><span class="line">public static Map<span class="xml"><span class="tag">&lt;<span class="name">Integer,</span> <span class="attr">InetSocketAddress</span>&gt;</span></span> parseVoterConnections(List<span class="xml"><span class="tag">&lt;<span class="name">String</span>&gt;</span></span> voterEntries) &#123;</span><br><span class="line"><span class="code">    Map&lt;Integer, InetSocketAddress&gt; voterMap = new HashMap&lt;&gt;(voterEntries.size());</span></span><br><span class="line"><span class="code">    for (String voterMapEntry : voterEntries) &#123;</span></span><br><span class="line"><span class="code">        String[] idAndAddress = voterMapEntry.split("@");</span></span><br><span class="line"><span class="code">        Integer voterId = parseVoterId(idAndAddress[0]);</span></span><br><span class="line"><span class="code">        String host = Utils.getHost(idAndAddress[1]);</span></span><br><span class="line"><span class="code">        Integer port = Utils.getPort(idAndAddress[1]);</span></span><br><span class="line"><span class="code">        InetSocketAddress address = new InetSocketAddress(host, port);</span></span><br><span class="line"><span class="code">        voterMap.put(voterId, address);</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">    return voterMap;</span></span><br><span class="line">&#125;</span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="section">## VoterSet - Voter 集合管理器</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**源码位置：**</span> <span class="code">`raft/src/main/java/org/apache/kafka/raft/VoterSet.java:45`</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 是什么</span></span><br><span class="line"></span><br><span class="line">VoterSet 是 voter 集合的不可变容器，封装了所有 voter 节点的静态信息（endpoint、directory ID、支持的 kraft 版本）和动态管理功能。</span><br><span class="line"></span><br><span class="line"><span class="section">### 为什么</span></span><br><span class="line"></span><br><span class="line">提供了 voter 集合的统一抽象，支持从静态配置创建、从 VotersRecord 恢复、以及动态的增删改操作，同时确保 voter 集合变更的原子性和一致性。</span><br><span class="line"></span><br><span class="line"><span class="section">### 怎么样</span></span><br><span class="line"></span><br><span class="line">~~~java</span><br><span class="line">public final class VoterSet &#123;</span><br><span class="line"><span class="code">    private final Map&lt;Integer, VoterNode&gt; voters;</span></span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="code">    public boolean isVoter(ReplicaKey replicaKey) &#123;</span></span><br><span class="line"><span class="code">        return Optional.ofNullable(voters.get(replicaKey.id()))</span></span><br><span class="line"><span class="code">            .map(node -&gt; node.isVoter(replicaKey))</span></span><br><span class="line"><span class="code">            .orElse(false);</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="code">    public static VoterSet fromInetSocketAddresses(ListenerName listener, Map&lt;Integer, InetSocketAddress&gt; voters) &#123;</span></span><br><span class="line"><span class="code">        Map&lt;Integer, VoterNode&gt; voterNodes = voters</span></span><br><span class="line"><span class="code">            .entrySet()</span></span><br><span class="line"><span class="code">            .stream()</span></span><br><span class="line"><span class="code">            .collect(Collectors.toMap(</span></span><br><span class="line"><span class="code">                Map.Entry::getKey,</span></span><br><span class="line"><span class="code">                entry -&gt; new VoterNode(</span></span><br><span class="line"><span class="code">                    ReplicaKey.of(entry.getKey(), Uuid.ZERO_UUID),</span></span><br><span class="line"><span class="code">                    Endpoints.fromInetSocketAddresses(Collections.singletonMap(listener, entry.getValue())),</span></span><br><span class="line"><span class="code">                    new SupportedVersionRange((short) 0, (short) 0)</span></span><br><span class="line"><span class="code">                )</span></span><br><span class="line"><span class="code">            ));</span></span><br><span class="line"><span class="code">        return new VoterSet(voterNodes);</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line">&#125;</span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="section">## KRaftControlRecordStateMachine - Voter 状态机</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**源码位置：**</span> <span class="code">`raft/src/main/java/org/apache/kafka/raft/internals/KRaftControlRecordStateMachine.java:139`</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 是什么</span></span><br><span class="line"></span><br><span class="line">KRaftControlRecordStateMachine 是管理 voter 集合历史变更的状态机，维护了 voter 集合在不同 offset 的历史版本。</span><br><span class="line"></span><br><span class="line"><span class="section">### 为什么</span></span><br><span class="line"></span><br><span class="line">KRaft 支持动态 voter 重配置，需要跟踪 voter 集合在日志中的变更历史，以便在不同的 offset 位置能够获取正确的 voter 集合信息。</span><br><span class="line"></span><br><span class="line"><span class="section">### 怎么样</span></span><br><span class="line"></span><br><span class="line">~~~java</span><br><span class="line">public VoterSet lastVoterSet() &#123;</span><br><span class="line"><span class="code">    synchronized (voterSetHistory) &#123;</span></span><br><span class="line"><span class="code">        return voterSetHistory.lastValue();</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public Optional<span class="xml"><span class="tag">&lt;<span class="name">LogHistory.Entry</span>&lt;<span class="attr">VoterSet</span>&gt;</span></span>&gt; lastVoterSetEntry() &#123;</span><br><span class="line"><span class="code">    synchronized (voterSetHistory) &#123;</span></span><br><span class="line"><span class="code">        return voterSetHistory.lastEntry();</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public OptionalLong lastVoterSetOffset() &#123;</span><br><span class="line"><span class="code">    synchronized (voterSetHistory) &#123;</span></span><br><span class="line"><span class="code">        return voterSetHistory.lastVoterSetOffset();</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line">&#125;</span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="section">## ElectionState - 选举状态持久化</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**源码位置：**</span> <span class="code">`raft/src/main/java/org/apache/kafka/raft/ElectionState.java:134`</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 是什么</span></span><br><span class="line"></span><br><span class="line">ElectionState 负责将选举相关状态（包括 CurrentVoters）持久化到磁盘，确保节点重启后能恢复选举状态。</span><br><span class="line"></span><br><span class="line"><span class="section">### 为什么</span></span><br><span class="line"></span><br><span class="line">Raft 协议要求节点在投票前必须持久化投票信息，防止重启后重复投票导致的脑裂问题。CurrentVoters 信息是选举合法性验证的基础。</span><br><span class="line"></span><br><span class="line"><span class="section">### 怎么样</span></span><br><span class="line"></span><br><span class="line">~~~java</span><br><span class="line">public QuorumStateData toQuorumStateData(short version) &#123;</span><br><span class="line"><span class="code">    QuorumStateData data = new QuorumStateData()</span></span><br><span class="line"><span class="code">        .setLeaderEpoch(epoch)</span></span><br><span class="line"><span class="code">        .setLeaderId(leaderIdOrSentinel())</span></span><br><span class="line"><span class="code">        .setVotedId(votedKey.map(ReplicaKey::id).orElse(NOT_VOTED));</span></span><br><span class="line"></span><br><span class="line"><span class="code">    if (version == 0) &#123;</span></span><br><span class="line"><span class="code">        List&lt;QuorumStateData.Voter&gt; dataVoters = voters</span></span><br><span class="line"><span class="code">            .stream()</span></span><br><span class="line"><span class="code">            .map(voterId -&gt; new QuorumStateData.Voter().setVoterId(voterId))</span></span><br><span class="line"><span class="code">            .collect(Collectors.toList());</span></span><br><span class="line"><span class="code">        data.setCurrentVoters(dataVoters);</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">    return data;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public static ElectionState fromQuorumStateData(QuorumStateData data) &#123;</span><br><span class="line"><span class="code">    return new ElectionState(</span></span><br><span class="line"><span class="code">        data.leaderEpoch(),</span></span><br><span class="line"><span class="code">        data.leaderId() == UNKNOWN_LEADER_ID ? OptionalInt.empty() : OptionalInt.of(data.leaderId()),</span></span><br><span class="line"><span class="code">        votedKey,</span></span><br><span class="line"><span class="code">        data.currentVoters().stream().map(QuorumStateData.Voter::voterId).collect(Collectors.toSet())</span></span><br><span class="line"><span class="code">    );</span></span><br><span class="line">&#125;</span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="section">## 交互流程</span></span><br><span class="line"></span><br><span class="line">Kafka KRaft 的 voter 列表加载和维护遵循以下流程：</span><br><span class="line"></span><br><span class="line">~~~mermaid</span><br><span class="line">graph TD</span><br><span class="line"><span class="code">    A[启动节点] --&gt; B[QuorumConfig.parseVoterConnections]</span></span><br><span class="line"><span class="code">    B --&gt; C[VoterSet.fromInetSocketAddresses]</span></span><br><span class="line"><span class="code">    C --&gt; D[KRaftControlRecordStateMachine 初始化]</span></span><br><span class="line"><span class="code">    D --&gt; E[读取日志和快照]</span></span><br><span class="line"><span class="code">    E --&gt; F[updateState 更新状态]</span></span><br><span class="line"><span class="code">    F --&gt; G[lastVoterSet 获取当前 voter 集合]</span></span><br><span class="line"><span class="code">    G --&gt; H[QuorumState 初始化]</span></span><br><span class="line"><span class="code">    H --&gt; I[FileQuorumStateStore 恢复选举状态]</span></span><br><span class="line"><span class="code">    I --&gt; J[ElectionState.fromQuorumStateData]</span></span><br><span class="line"><span class="code">    J --&gt; K[开始 Raft 协议]</span></span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="code">    K --&gt; L&#123;收到 VotersRecord?&#125;</span></span><br><span class="line"><span class="code">    L --&gt;|是| M[VoterSetHistory.addAt]</span></span><br><span class="line"><span class="code">    L --&gt;|否| N[使用当前 voter 集合]</span></span><br><span class="line"><span class="code">    M --&gt; O[更新 lastVoterSet]</span></span><br><span class="line"><span class="code">    O --&gt; P[持久化到 ElectionState]</span></span><br><span class="line"><span class="code">    P --&gt; N</span></span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="strong">**关键步骤源码映射：**</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">1.  </span>配置解析 → <span class="code">`QuorumConfig.java:193`</span> - parseVoterConnections</span><br><span class="line"><span class="bullet">2.  </span>静态 VoterSet 创建 → <span class="code">`VoterSet.java:478`</span> - fromInetSocketAddresses</span><br><span class="line"><span class="bullet">3.  </span>状态机初始化 → <span class="code">`KRaftControlRecordStateMachine.java:79`</span> - 构造函数</span><br><span class="line"><span class="bullet">4.  </span>状态更新 → <span class="code">`KRaftControlRecordStateMachine.java:489`</span> - updateState</span><br><span class="line"><span class="bullet">5.  </span>获取当前 voter 集合 → <span class="code">`KRaftControlRecordStateMachine.java:139`</span> - lastVoterSet</span><br><span class="line"><span class="bullet">6.  </span>选举状态恢复 → <span class="code">`ElectionState.java:209`</span> - fromQuorumStateData</span><br><span class="line"></span><br><span class="line"><span class="strong">**问题根源分析：**</span> 当前 KRaft 实现中，CurrentVoters 信息来源于持久化的 ElectionState，如果该信息损坏或不正确，会导致选举失败。您提到的 patch 需求是在 <span class="code">`QuorumConfig`</span> 或 <span class="code">`VoterSet`</span> 层面增加配置覆盖机制，让管理员能够通过配置文件强制指定正确的 voter 列表来覆盖损坏的元信息。</span><br></pre></td></tr></table></figure>
<h3 id="机制设计"><a href="#机制设计" class="headerlink" title="机制设计"></a>机制设计</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">如果想新增一个机制，支持在配置文件中强制配置 voter 列表的信息，用以覆盖 ElectionState 中的信息，包含 id、directoryId 和 endpoints 信息，应该如何进行设计？</span><br></pre></td></tr></table></figure>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br></pre></td><td class="code"><pre><span class="line">基于对源码的深入分析，我将设计一个完整的配置覆盖机制来解决 CurrentVoters 信息错误的问题。</span><br><span class="line"></span><br><span class="line"><span class="section">## 设计方案概述</span></span><br><span class="line"></span><br><span class="line">新增一个 <span class="code">`controller.quorum.voters.override`</span> 配置项，支持完整的 voter 信息覆盖，包括 id、directoryId 和 endpoints。当该配置存在时，优先使用配置的 voter 信息，而不是从 ElectionState 中读取的 CurrentVoters。</span><br><span class="line"></span><br><span class="line"><span class="section">## 核心设计组件</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 1\. QuorumConfig 扩展 - 配置解析层</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**源码位置：**</span> <span class="code">`raft/src/main/java/org/apache/kafka/raft/QuorumConfig.java:57`</span></span><br><span class="line"></span><br><span class="line">~~~java</span><br><span class="line">// 新增配置项</span><br><span class="line">public static final String QUORUM<span class="emphasis">_VOTERS_</span>OVERRIDE<span class="emphasis">_CONFIG = QUORUM_</span>PREFIX + "voters.override";</span><br><span class="line">public static final String QUORUM<span class="emphasis">_VOTERS_</span>OVERRIDE_DOC = "Override voter set configuration for emergency recovery. " +</span><br><span class="line"><span class="code">    "Format: &#123;id&#125;@&#123;host&#125;:&#123;port&#125;:&#123;directoryId&#125;[,&#123;id&#125;@&#123;host&#125;:&#123;port&#125;:&#123;directoryId&#125;...]. " +</span></span><br><span class="line"><span class="code">    "When specified, this overrides any voter information from persisted election state. " +</span></span><br><span class="line"><span class="code">    "Example: 1@localhost:9092:J8aAPcfLQt2bqs1JT_rMgQ,2@localhost:9093:b-DwmhtOheTqZzPoh52kfA";</span></span><br><span class="line">public static final List<span class="xml"><span class="tag">&lt;<span class="name">String</span>&gt;</span></span> DEFAULT<span class="emphasis">_QUORUM_</span>VOTERS_OVERRIDE = Collections.emptyList();</span><br><span class="line"></span><br><span class="line">// 扩展 ConfigDef</span><br><span class="line">public static final ConfigDef CONFIG_DEF = new ConfigDef()</span><br><span class="line"><span class="code">    .define(QUORUM_VOTERS_CONFIG, LIST, DEFAULT_QUORUM_VOTERS, new ControllerQuorumVotersValidator(), HIGH, QUORUM_VOTERS_DOC)</span></span><br><span class="line"><span class="code">    .define(QUORUM_VOTERS_OVERRIDE_CONFIG, LIST, DEFAULT_QUORUM_VOTERS_OVERRIDE, new ControllerQuorumVotersOverrideValidator(), HIGH, QUORUM_VOTERS_OVERRIDE_DOC)</span></span><br><span class="line"><span class="code">    // ... 其他配置项</span></span><br><span class="line"></span><br><span class="line">// 新增解析方法</span><br><span class="line">public static VoterSet parseVoterSetOverride(List<span class="xml"><span class="tag">&lt;<span class="name">String</span>&gt;</span></span> voterEntries, ListenerName listenerName) &#123;</span><br><span class="line"><span class="code">    if (voterEntries.isEmpty()) &#123;</span></span><br><span class="line"><span class="code">        return null; // 表示没有覆盖配置</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="code">    Map&lt;Integer, VoterSet.VoterNode&gt; voterNodes = new HashMap&lt;&gt;();</span></span><br><span class="line"><span class="code">    for (String voterEntry : voterEntries) &#123;</span></span><br><span class="line"><span class="code">        String[] parts = voterEntry.split("@");</span></span><br><span class="line"><span class="code">        if (parts.length != 2) &#123;</span></span><br><span class="line"><span class="code">            throw new ConfigException("Invalid voter override format: " + voterEntry);</span></span><br><span class="line"><span class="code">        &#125;</span></span><br><span class="line"><span class="code">        </span></span><br><span class="line"><span class="code">        Integer voterId = parseVoterId(parts[0]);</span></span><br><span class="line"><span class="code">        String[] addressAndDirectoryId = parts[1].split(":");</span></span><br><span class="line"><span class="code">        if (addressAndDirectoryId.length != 3) &#123;</span></span><br><span class="line"><span class="code">            throw new ConfigException("Invalid address:directoryId format: " + parts[1]);</span></span><br><span class="line"><span class="code">        &#125;</span></span><br><span class="line"><span class="code">        </span></span><br><span class="line"><span class="code">        String host = addressAndDirectoryId[0];</span></span><br><span class="line"><span class="code">        Integer port = Integer.parseInt(addressAndDirectoryId[1]);</span></span><br><span class="line"><span class="code">        Uuid directoryId = Uuid.fromString(addressAndDirectoryId[2]);</span></span><br><span class="line"><span class="code">        </span></span><br><span class="line"><span class="code">        InetSocketAddress address = new InetSocketAddress(host, port);</span></span><br><span class="line"><span class="code">        Endpoints endpoints = Endpoints.fromInetSocketAddresses(</span></span><br><span class="line"><span class="code">            Collections.singletonMap(listenerName, address)</span></span><br><span class="line"><span class="code">        );</span></span><br><span class="line"><span class="code">        </span></span><br><span class="line"><span class="code">        VoterSet.VoterNode voterNode = VoterSet.VoterNode.of(</span></span><br><span class="line"><span class="code">            ReplicaKey.of(voterId, directoryId),</span></span><br><span class="line"><span class="code">            endpoints,</span></span><br><span class="line"><span class="code">            new SupportedVersionRange((short) 0, (short) 1) // 支持当前版本范围</span></span><br><span class="line"><span class="code">        );</span></span><br><span class="line"><span class="code">        </span></span><br><span class="line"><span class="code">        voterNodes.put(voterId, voterNode);</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="code">    return VoterSet.fromMap(voterNodes);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 新增验证器</span><br><span class="line">public static class ControllerQuorumVotersOverrideValidator implements ConfigDef.Validator &#123;</span><br><span class="line"><span class="code">    @Override</span></span><br><span class="line"><span class="code">    public void ensureValid(String name, Object value) &#123;</span></span><br><span class="line"><span class="code">        if (value == null) return;</span></span><br><span class="line"><span class="code">        </span></span><br><span class="line"><span class="code">        @SuppressWarnings("unchecked")</span></span><br><span class="line"><span class="code">        List&lt;String&gt; voterStrings = (List&lt;String&gt;) value;</span></span><br><span class="line"><span class="code">        </span></span><br><span class="line"><span class="code">        // 验证格式正确性</span></span><br><span class="line"><span class="code">        for (String voterEntry : voterStrings) &#123;</span></span><br><span class="line"><span class="code">            String[] parts = voterEntry.split("@");</span></span><br><span class="line"><span class="code">            if (parts.length != 2) &#123;</span></span><br><span class="line"><span class="code">                throw new ConfigException("Invalid voter override format: " + voterEntry);</span></span><br><span class="line"><span class="code">            &#125;</span></span><br><span class="line"><span class="code">            </span></span><br><span class="line"><span class="code">            parseVoterId(parts[0]); // 验证 ID</span></span><br><span class="line"><span class="code">            </span></span><br><span class="line"><span class="code">            String[] addressAndDirectoryId = parts[1].split(":");</span></span><br><span class="line"><span class="code">            if (addressAndDirectoryId.length != 3) &#123;</span></span><br><span class="line"><span class="code">                throw new ConfigException("Invalid address:directoryId format: " + parts[1]);</span></span><br><span class="line"><span class="code">            &#125;</span></span><br><span class="line"><span class="code">            </span></span><br><span class="line"><span class="code">            // 验证 host:port</span></span><br><span class="line"><span class="code">            if (!Utils.validHostPattern(addressAndDirectoryId[0])) &#123;</span></span><br><span class="line"><span class="code">                throw new ConfigException("Invalid host: " + addressAndDirectoryId[0]);</span></span><br><span class="line"><span class="code">            &#125;</span></span><br><span class="line"><span class="code">            </span></span><br><span class="line"><span class="code">            try &#123;</span></span><br><span class="line"><span class="code">                Integer.parseInt(addressAndDirectoryId[1]);</span></span><br><span class="line"><span class="code">            &#125; catch (NumberFormatException e) &#123;</span></span><br><span class="line"><span class="code">                throw new ConfigException("Invalid port: " + addressAndDirectoryId[1]);</span></span><br><span class="line"><span class="code">            &#125;</span></span><br><span class="line"><span class="code">            </span></span><br><span class="line"><span class="code">            // 验证 UUID 格式</span></span><br><span class="line"><span class="code">            try &#123;</span></span><br><span class="line"><span class="code">                Uuid.fromString(addressAndDirectoryId[2]);</span></span><br><span class="line"><span class="code">            &#125; catch (Exception e) &#123;</span></span><br><span class="line"><span class="code">                throw new ConfigException("Invalid directory ID: " + addressAndDirectoryId[2]);</span></span><br><span class="line"><span class="code">            &#125;</span></span><br><span class="line"><span class="code">        &#125;</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line">&#125;</span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="section">### 2\. KafkaRaftClient 初始化逻辑修改</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**源码位置：**</span> <span class="code">`raft/src/main/java/org/apache/kafka/raft/KafkaRaftClient.java:470`</span></span><br><span class="line"></span><br><span class="line">~~~java</span><br><span class="line">public void initialize(</span><br><span class="line"><span class="code">    Map&lt;Integer, InetSocketAddress&gt; voterAddresses,</span></span><br><span class="line"><span class="code">    QuorumStateStore quorumStateStore,</span></span><br><span class="line"><span class="code">    Metrics metrics</span></span><br><span class="line">) &#123;</span><br><span class="line"><span class="code">    // 检查是否有 voter 覆盖配置</span></span><br><span class="line"><span class="code">    List&lt;String&gt; voterOverrideConfig = // 从配置中获取</span></span><br><span class="line"><span class="code">    VoterSet overrideVoterSet = null;</span></span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="code">    if (!voterOverrideConfig.isEmpty()) &#123;</span></span><br><span class="line"><span class="code">        logger.warn("Using voter override configuration: &#123;&#125;", voterOverrideConfig);</span></span><br><span class="line"><span class="code">        overrideVoterSet = QuorumConfig.parseVoterSetOverride(</span></span><br><span class="line"><span class="code">            voterOverrideConfig, </span></span><br><span class="line"><span class="code">            channel.listenerName()</span></span><br><span class="line"><span class="code">        );</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="code">    VoterSet staticVoters = voterAddresses.isEmpty() ?</span></span><br><span class="line"><span class="code">        VoterSet.empty() :</span></span><br><span class="line"><span class="code">        VoterSet.fromInetSocketAddresses(channel.listenerName(), voterAddresses);</span></span><br><span class="line"></span><br><span class="line"><span class="code">    partitionState = new KRaftControlRecordStateMachine(</span></span><br><span class="line"><span class="code">        staticVoters,</span></span><br><span class="line"><span class="code">        log,</span></span><br><span class="line"><span class="code">        serde,</span></span><br><span class="line"><span class="code">        BufferSupplier.create(),</span></span><br><span class="line"><span class="code">        MAX_BATCH_SIZE_BYTES,</span></span><br><span class="line"><span class="code">        logContext,</span></span><br><span class="line"><span class="code">        overrideVoterSet  // 传递覆盖配置</span></span><br><span class="line"><span class="code">    );</span></span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="code">    // ... 其余初始化逻辑</span></span><br><span class="line">&#125;</span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="section">### 3\. KRaftControlRecordStateMachine 覆盖逻辑</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**源码位置：**</span> <span class="code">`raft/src/main/java/org/apache/kafka/raft/internals/KRaftControlRecordStateMachine.java:76`</span></span><br><span class="line"></span><br><span class="line">~~~java</span><br><span class="line">public class KRaftControlRecordStateMachine implements RaftClient.Listener<span class="xml"><span class="tag">&lt;<span class="name">ApiMessage</span>&gt;</span></span> &#123;</span><br><span class="line"><span class="code">    private final VoterSet overrideVoterSet; // 新增字段</span></span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="code">    public KRaftControlRecordStateMachine(</span></span><br><span class="line"><span class="code">        VoterSet staticVoterSet,</span></span><br><span class="line"><span class="code">        ReplicatedLog log,</span></span><br><span class="line"><span class="code">        RecordSerde&lt;ApiMessage&gt; serde,</span></span><br><span class="line"><span class="code">        BufferSupplier bufferSupplier,</span></span><br><span class="line"><span class="code">        int maxBatchSizeBytes,</span></span><br><span class="line"><span class="code">        LogContext logContext,</span></span><br><span class="line"><span class="code">        VoterSet overrideVoterSet  // 新增参数</span></span><br><span class="line"><span class="code">    ) &#123;</span></span><br><span class="line"><span class="code">        // ... 现有初始化逻辑</span></span><br><span class="line"><span class="code">        this.overrideVoterSet = overrideVoterSet;</span></span><br><span class="line"><span class="code">        </span></span><br><span class="line"><span class="code">        // 如果有覆盖配置，使用覆盖的 voter 集合</span></span><br><span class="line"><span class="code">        if (overrideVoterSet != null) &#123;</span></span><br><span class="line"><span class="code">            logger.warn("Initializing with override voter set: &#123;&#125;", overrideVoterSet);</span></span><br><span class="line"><span class="code">            this.voterSetHistory = new VoterSetHistory(Optional.of(overrideVoterSet));</span></span><br><span class="line"><span class="code">        &#125; else &#123;</span></span><br><span class="line"><span class="code">            this.voterSetHistory = new VoterSetHistory(Optional.of(staticVoterSet));</span></span><br><span class="line"><span class="code">        &#125;</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="code">    /**</span></span><br><span class="line"><span class="code">     * 覆盖 lastVoterSet 方法，优先返回覆盖配置</span></span><br><span class="line"><span class="code">     */</span></span><br><span class="line"><span class="code">    @Override</span></span><br><span class="line"><span class="code">    public VoterSet lastVoterSet() &#123;</span></span><br><span class="line"><span class="code">        if (overrideVoterSet != null) &#123;</span></span><br><span class="line"><span class="code">            return overrideVoterSet;</span></span><br><span class="line"><span class="code">        &#125;</span></span><br><span class="line"><span class="code">        </span></span><br><span class="line"><span class="code">        synchronized (voterSetHistory) &#123;</span></span><br><span class="line"><span class="code">            return voterSetHistory.lastValue();</span></span><br><span class="line"><span class="code">        &#125;</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="code">    /**</span></span><br><span class="line"><span class="code">     * 新增方法：检查是否使用了覆盖配置</span></span><br><span class="line"><span class="code">     */</span></span><br><span class="line"><span class="code">    public boolean isUsingVoterOverride() &#123;</span></span><br><span class="line"><span class="code">        return overrideVoterSet != null;</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line">&#125;</span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="section">### 4\. ElectionState 覆盖机制</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**源码位置：**</span> <span class="code">`raft/src/main/java/org/apache/kafka/raft/ElectionState.java:209`</span></span><br><span class="line"></span><br><span class="line">~~~java</span><br><span class="line">public static ElectionState fromQuorumStateData(QuorumStateData data, VoterSet overrideVoterSet) &#123;</span><br><span class="line"><span class="code">    Optional&lt;ReplicaKey&gt; votedKey = data.votedId() == NOT_VOTED ?</span></span><br><span class="line"><span class="code">        Optional.empty() :</span></span><br><span class="line"><span class="code">        Optional.of(ReplicaKey.of(data.votedId(), data.votedDirectoryId()));</span></span><br><span class="line"></span><br><span class="line"><span class="code">    // 如果有覆盖配置，使用覆盖的 voter 集合而不是持久化的 CurrentVoters</span></span><br><span class="line"><span class="code">    Set&lt;Integer&gt; voters;</span></span><br><span class="line"><span class="code">    if (overrideVoterSet != null) &#123;</span></span><br><span class="line"><span class="code">        voters = overrideVoterSet.voterIds();</span></span><br><span class="line"><span class="code">        // 记录覆盖行为</span></span><br><span class="line"><span class="code">        log.warn("Overriding persisted CurrentVoters &#123;&#125; with configured voters &#123;&#125;", </span></span><br><span class="line"><span class="code">                data.currentVoters().stream().map(QuorumStateData.Voter::voterId).collect(Collectors.toSet()),</span></span><br><span class="line"><span class="code">                voters);</span></span><br><span class="line"><span class="code">    &#125; else &#123;</span></span><br><span class="line"><span class="code">        voters = data.currentVoters().stream().map(QuorumStateData.Voter::voterId).collect(Collectors.toSet());</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="code">    return new ElectionState(</span></span><br><span class="line"><span class="code">        data.leaderEpoch(),</span></span><br><span class="line"><span class="code">        data.leaderId() == UNKNOWN_LEADER_ID ? OptionalInt.empty() : OptionalInt.of(data.leaderId()),</span></span><br><span class="line"><span class="code">        votedKey,</span></span><br><span class="line"><span class="code">        voters</span></span><br><span class="line"><span class="code">    );</span></span><br><span class="line">&#125;</span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="section">### 5\. QuorumState 集成覆盖逻辑</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**源码位置：**</span> <span class="code">`raft/src/main/java/org/apache/kafka/raft/QuorumState.java`</span></span><br><span class="line"></span><br><span class="line">~~~java</span><br><span class="line">public QuorumState(</span><br><span class="line"><span class="code">    OptionalInt localId,</span></span><br><span class="line"><span class="code">    Uuid localDirectoryId,</span></span><br><span class="line"><span class="code">    KRaftControlRecordStateMachine partitionState,</span></span><br><span class="line"><span class="code">    Endpoints localListeners,</span></span><br><span class="line"><span class="code">    SupportedVersionRange localSupportedKRaftVersion,</span></span><br><span class="line"><span class="code">    int electionTimeoutMs,</span></span><br><span class="line"><span class="code">    int fetchTimeoutMs,</span></span><br><span class="line"><span class="code">    QuorumStateStore store,</span></span><br><span class="line"><span class="code">    Time time,</span></span><br><span class="line"><span class="code">    LogContext logContext,</span></span><br><span class="line"><span class="code">    Random random,</span></span><br><span class="line"><span class="code">    VoterSet overrideVoterSet  // 新增参数</span></span><br><span class="line">) &#123;</span><br><span class="line"><span class="code">    // ... 现有初始化逻辑</span></span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="code">    // 从存储中恢复状态时考虑覆盖配置</span></span><br><span class="line"><span class="code">    Optional&lt;ElectionState&gt; maybeElectionState = store.readElectionState();</span></span><br><span class="line"><span class="code">    if (maybeElectionState.isPresent()) &#123;</span></span><br><span class="line"><span class="code">        ElectionState electionState = maybeElectionState.get();</span></span><br><span class="line"><span class="code">        // 如果有覆盖配置，重新构造 ElectionState</span></span><br><span class="line"><span class="code">        if (overrideVoterSet != null) &#123;</span></span><br><span class="line"><span class="code">            electionState = new ElectionState(</span></span><br><span class="line"><span class="code">                electionState.epoch(),</span></span><br><span class="line"><span class="code">                electionState.optionalLeaderId(),</span></span><br><span class="line"><span class="code">                electionState.optionalVotedKey(),</span></span><br><span class="line"><span class="code">                overrideVoterSet.voterIds()  // 使用覆盖的 voter IDs</span></span><br><span class="line"><span class="code">            );</span></span><br><span class="line"><span class="code">        &#125;</span></span><br><span class="line"><span class="code">        this.state = electionState;</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line">&#125;</span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="section">## 使用示例</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 配置文件示例</span></span><br><span class="line"></span><br><span class="line">~~~properties</span><br><span class="line"><span class="section"># 正常的 voter 配置</span></span><br><span class="line">controller.quorum.voters=1@localhost:9092,2@localhost:9093,3@localhost:9094</span><br><span class="line"></span><br><span class="line"><span class="section"># 紧急覆盖配置（包含完整的 directoryId 信息）</span></span><br><span class="line">controller.quorum.voters.override=1@localhost:9092:J8aAPcfLQt2bqs1JT_rMgQ,2@localhost:9093:b-DwmhtOheTqZzPoh52kfA,3@localhost:9094:g42deArWBTRM5A1yuVpMCg</span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="section">### 日志输出示例</span></span><br><span class="line"></span><br><span class="line">~~~</span><br><span class="line">[2024-12-10 10:30:15,123] WARN Using voter override configuration: [1@localhost:9092:J8aAPcfLQt2bqs1JT_rMgQ, 2@localhost:9093:b-DwmhtOheTqZzPoh52kfA] (org.apache.kafka.raft.KafkaRaftClient)</span><br><span class="line">[2024-12-10 10:30:15,124] WARN Overriding persisted CurrentVoters [1, 2, 4] with configured voters [1, 2, 3] (org.apache.kafka.raft.ElectionState)</span><br><span class="line">[2024-12-10 10:30:15,125] WARN Initializing with override voter set: VoterSet(voters=&#123;1=VoterNode(...), 2=VoterNode(...), 3=VoterNode(...)&#125;) (org.apache.kafka.raft.internals.KRaftControlRecordStateMachine)</span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="section">## 设计优势</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">1.  </span><span class="strong">**非侵入性**</span>：不破坏现有的 voter 管理逻辑，只在需要时进行覆盖</span><br><span class="line"><span class="bullet">2.  </span><span class="strong">**完整性**</span>：支持覆盖完整的 voter 信息（id、directoryId、endpoints）</span><br><span class="line"><span class="bullet">3.  </span><span class="strong">**安全性**</span>：通过详细的配置验证确保格式正确</span><br><span class="line"><span class="bullet">4.  </span><span class="strong">**可观测性**</span>：提供详细的日志记录覆盖行为</span><br><span class="line"><span class="bullet">5.  </span><span class="strong">**向后兼容**</span>：不影响现有集群的正常运行</span><br><span class="line"></span><br><span class="line">这个设计可以有效解决 CurrentVoters 信息错误导致的选举失败问题，为集群恢复提供了一个可靠的机制。</span><br></pre></td></tr></table></figure>
<h3 id="初次源码修改"><a href="#初次源码修改" class="headerlink" title="初次源码修改"></a>初次源码修改</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">根据你设计的方案，对相关的文件进行修改</span><br></pre></td></tr></table></figure>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">## 修改总结</span></span><br><span class="line"></span><br><span class="line">我已经完成了 KRaft voter 覆盖机制的完整实现。以下是修改的核心组件和交互流程：</span><br><span class="line"></span><br><span class="line"><span class="section">### 修改的文件和关键变更</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">1.  </span><span class="strong">**QuorumConfig.java**</span> - 配置解析层</span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="code">    *   新增 `QUORUM_VOTERS_OVERRIDE_CONFIG` 配置项</span></span><br><span class="line"><span class="code">    *   添加 `parseVoterSetOverride()` 方法解析覆盖配置</span></span><br><span class="line"><span class="code">    *   新增 `ControllerQuorumVotersOverrideValidator` 验证器</span></span><br><span class="line"><span class="bullet">2.  </span><span class="strong">**ElectionState.java**</span> - 选举状态管理</span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="code">    *   重载 `fromQuorumStateData()` 方法支持覆盖参数</span></span><br><span class="line"><span class="code">    *   在恢复选举状态时优先使用覆盖的 voter 信息</span></span><br><span class="line"><span class="bullet">3.  </span><span class="strong">**KRaftControlRecordStateMachine.java**</span> - 状态机</span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="code">    *   添加 `overrideVoterSet` 字段和构造函数重载</span></span><br><span class="line"><span class="code">    *   修改 `lastVoterSet()` 方法优先返回覆盖配置</span></span><br><span class="line"><span class="code">    *   新增 `isUsingVoterOverride()` 检查方法</span></span><br><span class="line"><span class="bullet">4.  </span><span class="strong">**KafkaRaftClient.java**</span> - 客户端集成</span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="code">    *   重载 `initialize()` 方法支持覆盖参数</span></span><br><span class="line"><span class="code">    *   传递覆盖配置到状态机和 QuorumState</span></span><br><span class="line"><span class="bullet">5.  </span><span class="strong">**QuorumState.java**</span> - 仲裁状态</span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="code">    *   添加覆盖支持的构造函数</span></span><br><span class="line"><span class="code">    *   修改 `readElectionState()` 使用覆盖配置重构选举状态</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 核心交互流程</span></span><br><span class="line"></span><br><span class="line">~~~mermaid</span><br><span class="line">graph TD</span><br><span class="line"><span class="code">    A[节点启动] --&gt; B[QuorumConfig 解析覆盖配置]</span></span><br><span class="line"><span class="code">    B --&gt; C&#123;存在覆盖配置?&#125;</span></span><br><span class="line"><span class="code">    C --&gt;|是| D[parseVoterSetOverride 创建 VoterSet]</span></span><br><span class="line"><span class="code">    C --&gt;|否| E[使用静态配置]</span></span><br><span class="line"><span class="code">    D --&gt; F[KafkaRaftClient.initialize 传递覆盖配置]</span></span><br><span class="line"><span class="code">    E --&gt; F</span></span><br><span class="line"><span class="code">    F --&gt; G[KRaftControlRecordStateMachine 初始化]</span></span><br><span class="line"><span class="code">    G --&gt; H[QuorumState 初始化]</span></span><br><span class="line"><span class="code">    H --&gt; I[readElectionState 恢复状态]</span></span><br><span class="line"><span class="code">    I --&gt; J&#123;使用覆盖配置?&#125;</span></span><br><span class="line"><span class="code">    J --&gt;|是| K[重构 ElectionState 使用覆盖 voters]</span></span><br><span class="line"><span class="code">    J --&gt;|否| L[使用持久化 CurrentVoters]</span></span><br><span class="line"><span class="code">    K --&gt; M[开始 Raft 协议]</span></span><br><span class="line"><span class="code">    L --&gt; M</span></span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="section">### 使用示例</span></span><br><span class="line"></span><br><span class="line">~~~properties</span><br><span class="line"><span class="section"># 紧急覆盖配置</span></span><br><span class="line">controller.quorum.voters.override=1@localhost:9092:J8aAPcfLQt2bqs1JT_rMgQ,2@localhost:9093:b-DwmhtOheTqZzPoh52kfA,3@localhost:9094:g42deArWBTRM5A1yuVpMCg</span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line">这个实现提供了一个完整的解决方案来处理 CurrentVoters 信息错误导致的选举失败问题，同时保持了向后兼容性和系统的安全性。</span><br></pre></td></tr></table></figure>
<h3 id="迭代与提问"><a href="#迭代与提问" class="headerlink" title="迭代与提问"></a>迭代与提问</h3><p>内容较多，省略模型输出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">这里确认一下，在完成修改后，当调用 kafka-metadata-quorum.sh 的  describe --status 时，获取到的 voter 列表是被覆盖后的 voter 列表，还是原始的列表？</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">那么此时调用 kafka-metadata-quorum.sh 的 remove-controller 和 add-controller ，可以对持久化状态中可能损坏的 CurrentVoters 进行操作吗？</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">对于  AddVoterHandler 和 RemoveVoterHandler 中的一致性问题的问题可能存在问题。我这里添加干预 voter 列表的能力，是希望可以在持久化状态 CurrentVoters 损坏的情况下，让 raft 选出 leader，然后再执行 remove-controller 和 add-controller 对损坏的 CurrentVoters 进行修复。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">额外新增日志，当使用配置干预的 voters 时，也同时打印持久化状态的 CurrentVoters 的信息到日志中，输出的信息和 ./bin/kafka-metadata-quorum.sh  describe --status 输出的 CurrentVoters 信息保持一致</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">按照当前变更运行时，发现 controller.quorum.voters.override 的配置没有实际生效，确认一下当前配置加载的流程是否有误</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在实际测试时，发现使用 controller.quorum.voters.override=2@10.144.79.15:8121:JdGYVjmQfoKkt2uw6J-OIw 启动后，通过脚本 ./bin/kafka-metadata-quorum.sh describe --status 拿到的信息中，CurrentVoters 只有 id 为 2 的节点了，这个符合预期吗？</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在增加节点 0 后（未配置 controller.quorum.voters.override，但是清理了__cluster_metadata-0 ），执行./bin/kafka-metadata-quorum.sh add-controller  ，然后再通过 ./bin/kafka-metadata-quorum.sh  describe ，发现其没有被提升为 voter</span><br></pre></td></tr></table></figure>
<h3 id="add-controller-的问题"><a href="#add-controller-的问题" class="headerlink" title="add-controller 的问题"></a>add-controller 的问题</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">还是存在问题，执行 add-controller 后相关节点并没有被加入到 voter 中，确认一下在代码中，在开启 controller.quorum.voters.override 时， kafka server 端 add-controller  相关逻辑是否有生效。相关日志如下：</span><br></pre></td></tr></table></figure>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line">现在我发现了关键问题！让我分析日志中的异常情况：</span><br><span class="line"></span><br><span class="line"><span class="section">## 关键问题分析</span></span><br><span class="line"></span><br><span class="line"><span class="section">### Override 配置与 Add Controller 的冲突</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**源码位置：**</span> <span class="code">`raft/src/main/java/org/apache/kafka/raft/internals/AddVoterHandler.java:130-140`</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 是什么</span></span><br><span class="line"></span><br><span class="line">从日志可以看出，add-controller 操作实际上<span class="strong">**成功了**</span>，但存在一个严重的逻辑冲突：</span><br><span class="line"></span><br><span class="line">~~~</span><br><span class="line">Latest set of voters is VoterSet(voters=&#123;0=..., 2=...&#125;) at offset 5947</span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line">这说明节点0已经被添加到 VoterSet 中，但由于 override 配置的存在，实际生效的 VoterSet 仍然只有节点2。</span><br><span class="line"></span><br><span class="line"><span class="section">### 为什么会出现这种情况</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">1.  </span><span class="strong">**持久化状态 vs 运行时状态**</span>：add-controller 修改了持久化的 VoterSet</span><br><span class="line"><span class="bullet">2.  </span><span class="strong">**Override 配置覆盖**</span>：但运行时仍使用 override 配置的 VoterSet</span><br><span class="line"><span class="bullet">3.  </span><span class="strong">**状态不一致**</span>：导致持久化状态与运行时状态不一致</span><br><span class="line"></span><br><span class="line"><span class="section">### 怎么样修复</span></span><br><span class="line"></span><br><span class="line">需要在使用 override 配置时禁用 add-controller 操作，或者修改逻辑使其与 override 配置兼容。</span><br><span class="line"></span><br><span class="line">让我查看当前的验证逻辑：</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="section">## 问题确认：Override 配置与 Add Controller 冲突</span></span><br><span class="line"></span><br><span class="line">通过分析日志和源码，我发现了关键问题：</span><br><span class="line"></span><br><span class="line"><span class="section">### 核心冲突分析</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**源码位置：**</span> <span class="code">`raft/src/main/java/org/apache/kafka/raft/internals/AddVoterHandler.java:130-150`</span></span><br><span class="line"></span><br><span class="line"><span class="section">#### 是什么</span></span><br><span class="line"></span><br><span class="line">AddVoterHandler <span class="strong">**没有检查 override 配置**</span>，导致状态分离：</span><br><span class="line"></span><br><span class="line"><span class="bullet">*   </span><span class="strong">**持久化状态**</span>：add-controller 成功写入了包含节点0和2的 VoterSet</span><br><span class="line"><span class="bullet">*   </span><span class="strong">**运行时状态**</span>：但实际使用的仍是 override 配置（只有节点2）</span><br><span class="line"></span><br><span class="line"><span class="section">#### 为什么会发生</span></span><br><span class="line"></span><br><span class="line">~~~java</span><br><span class="line">// AddVoterHandler 的验证逻辑</span><br><span class="line">VoterSet voters = votersEntry.get().value();  // 从持久化日志获取</span><br><span class="line">// 但运行时 QuorumState 使用的是 override 配置，两者不一致</span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="section">#### 怎么样表现</span></span><br><span class="line"></span><br><span class="line">从你的日志可以看出：</span><br><span class="line"></span><br><span class="line">~~~</span><br><span class="line">[INFO] Latest set of voters is VoterSet(voters=&#123;0=..., 2=...&#125;) at offset 5947</span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="bullet">*   </span>✅ <span class="strong">**持久化成功**</span>：VoterSet 已包含节点0和2</span><br><span class="line"><span class="bullet">*   </span>❌ <span class="strong">**运行时失效**</span>：describe --status 仍只显示节点2</span><br><span class="line"><span class="bullet">*   </span>❌ <span class="strong">**功能异常**</span>：节点0没有实际参与 Raft 协议</span><br><span class="line"></span><br><span class="line"><span class="section">## 交互流程分析</span></span><br><span class="line"></span><br><span class="line">~~~mermaid</span><br><span class="line">graph TD</span><br><span class="line"><span class="code">    A[执行 add-controller] --&gt; B[AddVoterHandler.handleAddVoterRequest]</span></span><br><span class="line"><span class="code">    B --&gt; C[验证：使用持久化 VoterSet]</span></span><br><span class="line"><span class="code">    C --&gt; D[✅ 验证通过：节点0不在持久化 VoterSet 中]</span></span><br><span class="line"><span class="code">    D --&gt; E[写入新的 VotersRecord]</span></span><br><span class="line"><span class="code">    E --&gt; F[✅ 持久化成功：VoterSet&#123;0,2&#125;]</span></span><br><span class="line"><span class="code">    F --&gt; G[QuorumState 读取 VoterSet]</span></span><br><span class="line"><span class="code">    G --&gt; H[❌ Override 配置覆盖：只使用节点2]</span></span><br><span class="line"><span class="code">    H --&gt; I[❌ 运行时状态：VoterSet&#123;2&#125;]</span></span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="code">    style D fill:#ccffcc</span></span><br><span class="line"><span class="code">    style F fill:#ccffcc</span></span><br><span class="line"><span class="code">    style H fill:#ffcccc</span></span><br><span class="line"><span class="code">    style I fill:#ffcccc</span></span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="strong">**关键步骤源码映射：**</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">1.  </span>验证逻辑 → <span class="code">`AddVoterHandler.java:140-150`</span> - 检查重复 voter</span><br><span class="line"><span class="bullet">2.  </span>持久化写入 → <span class="code">`KRaftControlRecordStateMachine.java`</span> - 处理 VotersRecord</span><br><span class="line"><span class="bullet">3.  </span>Override 覆盖 → <span class="code">`QuorumState.java:150-160`</span> - readElectionState 方法</span><br><span class="line"><span class="bullet">4.  </span>运行时状态 → <span class="code">`QuorumState.java`</span> - 实际使用的 VoterSet</span><br><span class="line"></span><br><span class="line"><span class="section">## 立即解决方案</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 方案：移除 Override 配置</span></span><br><span class="line"></span><br><span class="line">~~~bash</span><br><span class="line"><span class="section"># 1. 编辑节点2配置文件</span></span><br><span class="line">vim /path/to/server-2.properties</span><br><span class="line"></span><br><span class="line"><span class="section"># 2. 注释掉 override 配置</span></span><br><span class="line"><span class="section"># controller.quorum.voters.override=2@10.144.79.15:8121:JdGYVjmQfoKkt2uw6J-OIw</span></span><br><span class="line"></span><br><span class="line"><span class="section"># 3. 重启节点2</span></span><br><span class="line">sudo systemctl restart kafka</span><br><span class="line"></span><br><span class="line"><span class="section"># 4. 验证状态恢复</span></span><br><span class="line">./bin/kafka-metadata-quorum.sh describe --status --bootstrap-server 10.144.79.15:8121</span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="strong">**预期结果**</span>：</span><br><span class="line"></span><br><span class="line"><span class="bullet">*   </span>CurrentVoters 应该显示 <span class="code">`&#123;0, 2&#125;`</span>（从持久化状态恢复）</span><br><span class="line"><span class="bullet">*   </span>节点0应该开始参与 Raft 协议</span><br><span class="line"><span class="bullet">*   </span>集群恢复为正常的2节点配置</span><br><span class="line"></span><br><span class="line"><span class="section">## 根本原因和改进建议</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 代码层面改进</span></span><br><span class="line"></span><br><span class="line">需要在 AddVoterHandler 中添加 override 检查：</span><br><span class="line"></span><br><span class="line">~~~java</span><br><span class="line">// 建议的修改</span><br><span class="line">public CompletableFuture<span class="xml"><span class="tag">&lt;<span class="name">AddRaftVoterResponseData</span>&gt;</span></span> handleAddVoterRequest(...) &#123;</span><br><span class="line"><span class="code">    // 检查是否使用了 override 配置</span></span><br><span class="line"><span class="code">    if (partitionState.isUsingOverrideVoterSet()) &#123;</span></span><br><span class="line"><span class="code">        return CompletableFuture.completedFuture(</span></span><br><span class="line"><span class="code">            RaftUtil.addVoterResponse(</span></span><br><span class="line"><span class="code">                Errors.INVALID_REQUEST,</span></span><br><span class="line"><span class="code">                "Cannot add voter while using override configuration"</span></span><br><span class="line"><span class="code">            )</span></span><br><span class="line"><span class="code">        );</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">    // 原有逻辑...</span></span><br><span class="line">&#125;</span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="section">### 运维流程改进</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">1.  </span><span class="strong">**Override 配置仅用于紧急恢复**</span></span><br><span class="line"><span class="bullet">2.  </span><span class="strong">**恢复完成后立即移除 override 配置**</span></span><br><span class="line"><span class="bullet">3.  </span><span class="strong">**使用标准 add/remove-controller 进行后续管理**</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**总结**</span>：当前问题是设计上的冲突，override 配置与 add-controller 不兼容。解决方案是移除 override 配置，让系统从持久化状态恢复正常的多节点配置。</span><br></pre></td></tr></table></figure>
<h3 id="add-controller-问题修复"><a href="#add-controller-问题修复" class="headerlink" title="add-controller 问题修复"></a>add-controller 问题修复</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">我们希望仅在服务启动时使用 controller.quorum.voters.override  将 voter 信息，对于后续 add-controller、remove-controller 和 describe ，不受这个影响。因为我们的主要目标是校准历史问题的 voter 信息</span><br></pre></td></tr></table></figure>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">## 启动时生效实现完成</span></span><br><span class="line"></span><br><span class="line">我已经成功实现了"启动时生效一次"的设计方案。这个实现完美解决了你们的需求：</span><br><span class="line"></span><br><span class="line"><span class="section">### 核心设计原理</span></span><br><span class="line"></span><br><span class="line"><span class="section">## Override 启动时转换机制</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**源码位置：**</span> <span class="code">`raft/src/main/java/org/apache/kafka/raft/internals/KRaftControlRecordStateMachine.java:190-220`</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 是什么</span></span><br><span class="line"></span><br><span class="line">Override 配置在节点成为 Leader 时立即写入持久化状态，然后清除 override 标记。</span><br><span class="line"></span><br><span class="line"><span class="section">### 为什么</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">1.  </span><span class="strong">**一次性校准**</span>：仅用于修复损坏的 voter 信息</span><br><span class="line"><span class="bullet">2.  </span><span class="strong">**避免冲突**</span>：转换后消除与动态操作的冲突</span><br><span class="line"><span class="bullet">3.  </span><span class="strong">**恢复正常**</span>：后续操作完全基于持久化状态</span><br><span class="line"></span><br><span class="line"><span class="section">### 怎么样</span></span><br><span class="line"></span><br><span class="line">~~~java</span><br><span class="line">public void applyOverrideVoterSet(LeaderState<span class="xml">&lt;?&gt;</span> leaderState, long currentTimeMs) &#123;</span><br><span class="line"><span class="code">    if (overrideVoterSet != null &amp;&amp; !overrideApplied) &#123;</span></span><br><span class="line"><span class="code">        // 写入 override VoterSet 到日志，成为新的持久化状态</span></span><br><span class="line"><span class="code">        leaderState.appendVotersRecord(overrideVoterSet, currentTimeMs);</span></span><br><span class="line"><span class="code">        </span></span><br><span class="line"><span class="code">        // 标记已应用并清除 override</span></span><br><span class="line"><span class="code">        overrideApplied = true;</span></span><br><span class="line"><span class="code">        overrideVoterSet = null;  // 清除 override 配置</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line">&#125;</span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="section">## 交互流程分析</span></span><br><span class="line"></span><br><span class="line">~~~mermaid</span><br><span class="line">graph TD</span><br><span class="line"><span class="code">    A[启动时 Override 配置] --&gt; B[节点参与选举]</span></span><br><span class="line"><span class="code">    B --&gt; C[成为 Leader]</span></span><br><span class="line"><span class="code">    C --&gt; D[onBecomeLeader: 应用 Override]</span></span><br><span class="line"><span class="code">    D --&gt; E[写入 VotersRecord 到日志]</span></span><br><span class="line"><span class="code">    E --&gt; F[清除 Override 标记]</span></span><br><span class="line"><span class="code">    F --&gt; G[后续基于持久化状态]</span></span><br><span class="line"><span class="code">    G --&gt; H[Add/Remove Controller 正常工作]</span></span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="code">    style D fill:#4caf50</span></span><br><span class="line"><span class="code">    style F fill:#2196f3</span></span><br><span class="line"><span class="code">    style H fill:#4caf50</span></span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="strong">**关键步骤源码映射：**</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">1.  </span>Override 应用 → <span class="code">`KafkaRaftClient.java:670-675`</span> - onBecomeLeader 方法</span><br><span class="line"><span class="bullet">2.  </span>持久化写入 → <span class="code">`KRaftControlRecordStateMachine.java:205`</span> - appendVotersRecord</span><br><span class="line"><span class="bullet">3.  </span>标记清除 → <span class="code">`KRaftControlRecordStateMachine.java:210-215`</span> - 清除 override</span><br><span class="line"><span class="bullet">4.  </span>动态操作 → <span class="code">`AddVoterHandler.java`</span> - 基于持久化状态验证</span><br><span class="line"></span><br><span class="line"><span class="section">## 实现效果</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 1\. 启动时校准</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">*   </span>✅ Override 配置在成为 Leader 时立即应用</span><br><span class="line"><span class="bullet">*   </span>✅ 自动写入持久化状态，成为新的 CurrentVoters</span><br><span class="line"><span class="bullet">*   </span>✅ 应用后自动清除 override 标记</span><br><span class="line"></span><br><span class="line"><span class="section">### 2\. 后续正常操作</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">*   </span>✅ Add-controller 操作完全基于持久化状态</span><br><span class="line"><span class="bullet">*   </span>✅ Remove-controller 操作正常工作</span><br><span class="line"><span class="bullet">*   </span>✅ Describe 显示正确的 CurrentVoters（持久化状态）</span><br><span class="line"></span><br><span class="line"><span class="section">### 3\. 无冲突设计</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">*   </span>✅ 消除了 override 与动态操作的冲突</span><br><span class="line"><span class="bullet">*   </span>✅ 简化了状态管理逻辑</span><br><span class="line"><span class="bullet">*   </span>✅ 保持了系统的一致性</span><br><span class="line"></span><br><span class="line">现在你可以使用这个实现来：</span><br><span class="line"></span><br><span class="line"><span class="bullet">1.  </span><span class="strong">**紧急恢复**</span>：使用 override 配置校准损坏的 voter 信息</span><br><span class="line"><span class="bullet">2.  </span><span class="strong">**正常管理**</span>：启动后使用标准的 add/remove-controller 命令</span><br><span class="line"><span class="bullet">3.  </span><span class="strong">**无缝切换**</span>：从紧急模式自动切换到正常模式</span><br><span class="line"></span><br><span class="line">这个设计完美满足了你们"仅在启动时校准历史问题"的需求！</span><br></pre></td></tr></table></figure>
<h3 id="实际请求-voter-列表的问题"><a href="#实际请求-voter-列表的问题" class="headerlink" title="实际请求 voter 列表的问题"></a>实际请求 voter 列表的问题</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在 id=2 的服务设置为 controller.quorum.voters.override=2@10.144.79.15:8121:UnB5WuzilhDgzMvw3IyZsQ 启动后，虽然有 Override CurrentVoters 的日志输出，但是看日志，kafka 依旧在尝试连接其他的节点，在多次连接失败后，id=2 的服务就退出了。</span><br></pre></td></tr></table></figure>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">## 选举阶段问题修复完成</span></span><br><span class="line"></span><br><span class="line">我已经修复了最关键的问题：选举阶段 VoterSet 不匹配。</span><br><span class="line"></span><br><span class="line"><span class="section">### 问题根因分析</span></span><br><span class="line"></span><br><span class="line"><span class="section">## 选举阶段 VoterSet 不匹配</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**源码位置：**</span> <span class="code">`raft/src/main/java/org/apache/kafka/raft/internals/KRaftControlRecordStateMachine.java:179-190`</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 是什么</span></span><br><span class="line"></span><br><span class="line">选举时使用的 VoterSet 来自历史日志恢复（包含节点0,1,2），而不是 override 配置（只有节点2）。</span><br><span class="line"></span><br><span class="line"><span class="section">### 为什么会发生</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**逻辑缺陷**</span>：</span><br><span class="line"></span><br><span class="line"><span class="bullet">1.  </span>Override 配置只在成为 Leader 后应用</span><br><span class="line"><span class="bullet">2.  </span>但要成为 Leader 需要获得多数票</span><br><span class="line"><span class="bullet">3.  </span>选举时仍使用历史 VoterSet，需要获得节点0,1的选票</span><br><span class="line"><span class="bullet">4.  </span>但节点0,1不存在，无法获得选票，无法成为 Leader</span><br><span class="line"></span><br><span class="line"><span class="section">### 怎么样修复</span></span><br><span class="line"></span><br><span class="line">~~~java</span><br><span class="line">public VoterSet lastVoterSet() &#123;</span><br><span class="line"><span class="code">    // 在选举阶段使用 override 配置（如果存在且未应用）</span></span><br><span class="line"><span class="code">    if (overrideVoterSet != null &amp;&amp; !overrideApplied) &#123;</span></span><br><span class="line"><span class="code">        return overrideVoterSet;  // 返回 override 配置 &#123;2&#125;</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="code">    // 否则返回持久化状态</span></span><br><span class="line"><span class="code">    synchronized (voterSetHistory) &#123;</span></span><br><span class="line"><span class="code">        return voterSetHistory.lastValue();</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line">&#125;</span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="section">## 修复效果对比</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 修复前的问题流程</span></span><br><span class="line"></span><br><span class="line">~~~mermaid</span><br><span class="line">graph TD</span><br><span class="line"><span class="code">    A[Override: 只有节点2] --&gt; B[从日志恢复: &#123;0,1,2&#125;]</span></span><br><span class="line"><span class="code">    B --&gt; C[选举需要节点0,1,2的选票]</span></span><br><span class="line"><span class="code">    C --&gt; D[❌ 节点0,1不存在]</span></span><br><span class="line"><span class="code">    D --&gt; E[❌ 无法获得多数票]</span></span><br><span class="line"><span class="code">    E --&gt; F[❌ 无法成为 Leader]</span></span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="code">    style C fill:#ffcccc</span></span><br><span class="line"><span class="code">    style E fill:#ffcccc</span></span><br><span class="line"><span class="code">    style F fill:#ffcccc</span></span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="section">### 修复后的正确流程</span></span><br><span class="line"></span><br><span class="line">~~~mermaid</span><br><span class="line">graph TD</span><br><span class="line"><span class="code">    A[Override: 只有节点2] --&gt; B[选举使用 Override: &#123;2&#125;]</span></span><br><span class="line"><span class="code">    B --&gt; C[只需要节点2的选票]</span></span><br><span class="line"><span class="code">    C --&gt; D[✅ 节点2给自己投票]</span></span><br><span class="line"><span class="code">    D --&gt; E[✅ 获得多数票]</span></span><br><span class="line"><span class="code">    E --&gt; F[✅ 成为 Leader]</span></span><br><span class="line"><span class="code">    F --&gt; G[✅ 应用 Override 到持久化状态]</span></span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="code">    style B fill:#ccffcc</span></span><br><span class="line"><span class="code">    style D fill:#ccffcc</span></span><br><span class="line"><span class="code">    style F fill:#ccffcc</span></span><br><span class="line"><span class="code">    style G fill:#ccffcc</span></span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="strong">**关键步骤源码映射：**</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">1.  </span>VoterSet 选择 → <span class="code">`KRaftControlRecordStateMachine.java:182-186`</span> - override 检查逻辑</span><br><span class="line"><span class="bullet">2.  </span>单节点选举 → <span class="code">`QuorumState.java`</span> - 使用正确的 VoterSet</span><br><span class="line"><span class="bullet">3.  </span>成为 Leader → <span class="code">`KafkaRaftClient.java:670-675`</span> - onBecomeLeader 方法</span><br><span class="line"><span class="bullet">4.  </span>Override 应用 → <span class="code">`KRaftControlRecordStateMachine.java:195-220`</span> - applyOverrideVoterSet</span><br><span class="line"></span><br><span class="line"><span class="section">## 完整修复链条</span></span><br><span class="line"></span><br><span class="line">现在 override 功能的完整链条都已修复：</span><br><span class="line"></span><br><span class="line"><span class="section">### 1\. 配置加载 ✅</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">*   </span>KafkaConfig 正确读取 override 配置</span><br><span class="line"><span class="bullet">*   </span>RaftManager 正确传递 override 配置</span><br><span class="line"></span><br><span class="line"><span class="section">### 2\. 网络连接 ✅</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">*   </span>RequestManager 使用 override 配置创建网络连接</span><br><span class="line"><span class="bullet">*   </span>只连接 override 配置中的节点</span><br><span class="line"></span><br><span class="line"><span class="section">### 3\. 选举逻辑 ✅</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">*   </span>lastVoterSet 在选举阶段返回 override 配置</span><br><span class="line"><span class="bullet">*   </span>选举时只需要 override 配置中节点的选票</span><br><span class="line"></span><br><span class="line"><span class="section">### 4\. Override 应用 ✅</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">*   </span>成为 Leader 后立即应用 override 配置</span><br><span class="line"><span class="bullet">*   </span>转换为持久化状态并清除 override 标记</span><br><span class="line"></span><br><span class="line"><span class="section">## 预期效果</span></span><br><span class="line"></span><br><span class="line">现在使用 <span class="code">`controller.quorum.voters.override=2@10.144.79.15:8121:UnB5WuzilhDgzMvw3IyZsQ`</span> 启动时：</span><br><span class="line"></span><br><span class="line"><span class="section">### 1\. 快速选举成功</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">*   </span>✅ <span class="strong">**单节点选举**</span>：只需要节点2的选票</span><br><span class="line"><span class="bullet">*   </span>✅ <span class="strong">**快速成为 Leader**</span>：节点2给自己投票即可</span><br><span class="line"><span class="bullet">*   </span>✅ <span class="strong">**无连接错误**</span>：不再尝试连接不存在的节点</span><br><span class="line"></span><br><span class="line"><span class="section">### 2\. Override 正确应用</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">*   </span>✅ <span class="strong">**成为 Leader**</span>：单节点选举成功</span><br><span class="line"><span class="bullet">*   </span>✅ <span class="strong">**应用 Override**</span>：立即将 override 配置写入持久化状态</span><br><span class="line"><span class="bullet">*   </span>✅ <span class="strong">**清除标记**</span>：应用后自动清除 override 标记</span><br><span class="line"></span><br><span class="line"><span class="section">### 3\. 后续操作正常</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">*   </span>✅ <span class="strong">**Add Controller**</span>：可以正常添加其他节点</span><br><span class="line"><span class="bullet">*   </span>✅ <span class="strong">**Describe Status**</span>：显示正确的 CurrentVoters</span><br><span class="line"><span class="bullet">*   </span>✅ <span class="strong">**动态管理**</span>：恢复正常的集群管理功能</span><br><span class="line"></span><br><span class="line">现在你可以重新测试，应该能看到节点2快速成为 Leader 并成功应用 override 配置了！</span><br></pre></td></tr></table></figure>
<h3 id="并发访问确认"><a href="#并发访问确认" class="headerlink" title="并发访问确认"></a>并发访问确认</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">确认一下当前新增配置项 controller.quorum.voters.override 涉及的代码是否考虑了并发场景的问题，例如是否有变量会被多个线程修改或者一个线程修改一个线程读取</span><br></pre></td></tr></table></figure>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">## 并发安全性分析与修复完成</span></span><br><span class="line"></span><br><span class="line">我已经全面分析并修复了 <span class="code">`controller.quorum.voters.override`</span> 相关代码的并发安全性问题。</span><br><span class="line"></span><br><span class="line"><span class="section">### 发现的并发问题</span></span><br><span class="line"></span><br><span class="line"><span class="section">## 原始并发安全问题</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**源码位置：**</span> <span class="code">`raft/src/main/java/org/apache/kafka/raft/internals/KRaftControlRecordStateMachine.java:61-64`</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 是什么</span></span><br><span class="line"></span><br><span class="line"><span class="code">`overrideVoterSet`</span> 和 <span class="code">`overrideApplied`</span> 字段缺乏适当的并发控制，存在严重的竞态条件。</span><br><span class="line"></span><br><span class="line"><span class="section">### 为什么会有问题</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">1.  </span><span class="strong">**TOCTOU 问题**</span>：Time-of-Check-Time-of-Use 竞态条件</span><br><span class="line"><span class="bullet">2.  </span><span class="strong">**非原子操作**</span>：检查和修改操作不是原子的</span><br><span class="line"><span class="bullet">3.  </span><span class="strong">**双重应用风险**</span>：可能导致 override 配置被应用多次</span><br><span class="line"><span class="bullet">4.  </span><span class="strong">**NPE 风险**</span>：并发访问可能导致空指针异常</span><br><span class="line"></span><br><span class="line"><span class="section">### 怎么样修复</span></span><br><span class="line"></span><br><span class="line">~~~java</span><br><span class="line">// 修复前：无并发保护</span><br><span class="line">private VoterSet overrideVoterSet;</span><br><span class="line">private boolean overrideApplied = false;</span><br><span class="line"></span><br><span class="line">// 修复后：完整的并发保护</span><br><span class="line">private volatile VoterSet overrideVoterSet;</span><br><span class="line">private volatile boolean overrideApplied = false;</span><br><span class="line">private final Object overrideLock = new Object();  // 专用同步锁</span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="section">## 关键修复点</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 1\. 线程安全的状态检查</span></span><br><span class="line"></span><br><span class="line">~~~java</span><br><span class="line">public VoterSet lastVoterSet() &#123;</span><br><span class="line"><span class="code">    // 原子检查 override 状态</span></span><br><span class="line"><span class="code">    synchronized (overrideLock) &#123;</span></span><br><span class="line"><span class="code">        if (overrideVoterSet != null &amp;&amp; !overrideApplied) &#123;</span></span><br><span class="line"><span class="code">            return overrideVoterSet;</span></span><br><span class="line"><span class="code">        &#125;</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">    // 使用现有的同步机制访问持久化状态</span></span><br><span class="line"><span class="code">    synchronized (voterSetHistory) &#123;</span></span><br><span class="line"><span class="code">        return voterSetHistory.lastValue();</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line">&#125;</span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="section">### 2\. 防重复应用机制</span></span><br><span class="line"></span><br><span class="line">~~~java</span><br><span class="line">public void applyOverrideVoterSet(LeaderState<span class="xml">&lt;?&gt;</span> leaderState, long currentTimeMs) &#123;</span><br><span class="line"><span class="code">    VoterSet voterSetToApply;</span></span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="code">    // 原子检查并立即标记，防止重复应用</span></span><br><span class="line"><span class="code">    synchronized (overrideLock) &#123;</span></span><br><span class="line"><span class="code">        if (overrideVoterSet == null || overrideApplied) &#123;</span></span><br><span class="line"><span class="code">            return; // 已应用或无配置</span></span><br><span class="line"><span class="code">        &#125;</span></span><br><span class="line"><span class="code">        </span></span><br><span class="line"><span class="code">        // 立即标记为已应用，防止并发应用</span></span><br><span class="line"><span class="code">        overrideApplied = true;</span></span><br><span class="line"><span class="code">        voterSetToApply = overrideVoterSet;</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="code">    // I/O 操作在锁外执行，避免长时间持锁</span></span><br><span class="line"><span class="code">    // ... 执行实际的应用逻辑</span></span><br><span class="line">&#125;</span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="section">### 3\. 原子状态查询</span></span><br><span class="line"></span><br><span class="line">~~~java</span><br><span class="line">public boolean shouldApplyOverrideVoterSet() &#123;</span><br><span class="line"><span class="code">    synchronized (overrideLock) &#123;</span></span><br><span class="line"><span class="code">        return overrideVoterSet != null &amp;&amp; !overrideApplied;</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line">&#125;</span><br><span class="line">~~~</span><br><span class="line"></span><br><span class="line"><span class="section">## 并发安全保证</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 1\. 消除竞态条件</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">*   </span>✅ <span class="strong">**原子操作**</span>：检查和修改在同一同步块内</span><br><span class="line"><span class="bullet">*   </span>✅ <span class="strong">**一致性读取**</span>：避免读取到不一致的状态</span><br><span class="line"><span class="bullet">*   </span>✅ <span class="strong">**防重复执行**</span>：通过立即标记防止重复应用</span><br><span class="line"></span><br><span class="line"><span class="section">### 2\. 性能优化</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">*   </span>✅ <span class="strong">**细粒度锁**</span>：使用专门的 <span class="code">`overrideLock`</span>，不影响其他操作</span><br><span class="line"><span class="bullet">*   </span>✅ <span class="strong">**短暂持锁**</span>：同步块内只做必要的检查和标记</span><br><span class="line"><span class="bullet">*   </span>✅ <span class="strong">**I/O 分离**</span>：耗时操作在锁外执行</span><br><span class="line"></span><br><span class="line"><span class="section">### 3\. 内存可见性</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">*   </span>✅ <span class="strong">**volatile 字段**</span>：确保字段修改对所有线程可见</span><br><span class="line"><span class="bullet">*   </span>✅ <span class="strong">**happens-before**</span>：同步块保证内存操作的顺序性</span><br><span class="line"></span><br><span class="line"><span class="section">## 潜在并发场景</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 场景1：选举期间并发读取</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">*   </span><span class="strong">**线程A**</span>：选举线程调用 <span class="code">`lastVoterSet()`</span></span><br><span class="line"><span class="bullet">*   </span><span class="strong">**线程B**</span>：Leader 线程调用 <span class="code">`applyOverrideVoterSet()`</span></span><br><span class="line"><span class="bullet">*   </span><span class="strong">**保护**</span>：原子检查确保一致性</span><br><span class="line"></span><br><span class="line"><span class="section">### 场景2：防重复应用</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">*   </span><span class="strong">**多个线程**</span>：同时尝试应用 override 配置</span><br><span class="line"><span class="bullet">*   </span><span class="strong">**保护**</span>：立即标记 <span class="code">`overrideApplied = true`</span> 防止重复</span><br><span class="line"></span><br><span class="line"><span class="section">### 场景3：状态查询一致性</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">*   </span><span class="strong">**线程A**</span>：调用 <span class="code">`shouldApplyOverrideVoterSet()`</span></span><br><span class="line"><span class="bullet">*   </span><span class="strong">**线程B**</span>：修改 override 状态</span><br><span class="line"><span class="bullet">*   </span><span class="strong">**保护**</span>：同步块确保查询结果的一致性</span><br><span class="line"></span><br><span class="line">现在 <span class="code">`controller.quorum.voters.override`</span> 功能在多线程环境下是完全安全的，不会出现竞态条件、重复应用或状态不一致的问题。</span><br></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>至此，根据想法 2 实现了人工干预的配置项 <code>controller.quorum.voters.override</code>用于强制指定 voter 列表，以重新选出 leader 后，通过 <code>add-controller</code>校准 voter 列表信息。代码全部是 ai 写的。</p>
<h1 id="实现细节总结-summary-by-ai"><a href="#实现细节总结-summary-by-ai" class="headerlink" title="实现细节总结 - summary by ai"></a>实现细节总结 - summary by ai</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">当前已经完成了对于强制指定 voter 的功能添加。现在你需要基于之前的工作进行梳理，在这个功能关闭和开启时，voter 参与选举 leader 的流程</span><br></pre></td></tr></table></figure>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>本文档详细分析在 <code>controller.quorum.voters.override</code> 功能关闭和开启时，voter 参与选举 leader 的完整流程。</p>
<hr>
<h2 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h2><h3 id="VoterSet-来源"><a href="#VoterSet-来源" class="headerlink" title="VoterSet 来源"></a>VoterSet 来源</h3><blockquote>
<p><strong>源码位置：</strong> <code>raft/src/main/java/org/apache/kafka/raft/internals/KRaftControlRecordStateMachine.java:183-195</code></p>
</blockquote>
<h4 id="是什么"><a href="#是什么" class="headerlink" title="是什么"></a>是什么</h4><p>VoterSet 是选举的核心数据结构，决定了哪些节点参与选举。</p>
<h4 id="为什么"><a href="#为什么" class="headerlink" title="为什么"></a>为什么</h4><p>选举需要知道哪些节点是合法的 voter，以便：</p>
<ol>
<li><p>确定选票请求的目标节点</p>
</li>
<li><p>计算多数票阈值</p>
</li>
<li><p>验证选举结果的合法性</p>
</li>
</ol>
<h4 id="怎么样"><a href="#怎么样" class="headerlink" title="怎么样"></a>怎么样</h4><p>VoterSet 的来源有两种：</p>
<ol>
<li><p><strong>持久化状态</strong>：从 Raft 日志中恢复的历史 VoterSet</p>
</li>
<li><p><strong>Override 配置</strong>：通过 <code>controller.quorum.voters.override</code> 配置强制指定</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public VoterSet lastVoterSet() &#123;</span><br><span class="line">    // 如果 override 配置存在且未应用，使用 override 配置</span><br><span class="line">    synchronized (overrideLock) &#123;</span><br><span class="line">        if (overrideVoterSet != null &amp;&amp; !overrideApplied) &#123;</span><br><span class="line">            return overrideVoterSet;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 否则使用持久化状态</span><br><span class="line">    synchronized (voterSetHistory) &#123;</span><br><span class="line">        return voterSetHistory.lastValue();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="场景一：Override-功能关闭（正常模式）"><a href="#场景一：Override-功能关闭（正常模式）" class="headerlink" title="场景一：Override 功能关闭（正常模式）"></a>场景一：Override 功能关闭（正常模式）</h2><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 不配置 override，或配置为空</span><br><span class="line">controller.quorum.voters=0@host0:9092,1@host1:9092,2@host2:9092</span><br></pre></td></tr></table></figure>
<h3 id="选举流程"><a href="#选举流程" class="headerlink" title="选举流程"></a>选举流程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">    participant Startup as 服务启动</span><br><span class="line">    participant RaftMgr as RaftManager</span><br><span class="line">    participant KRaftClient as KafkaRaftClient</span><br><span class="line">    participant StateMachine as KRaftControlRecordStateMachine</span><br><span class="line">    participant QuorumState as QuorumState</span><br><span class="line">    participant Network as 网络层</span><br><span class="line"></span><br><span class="line">    Startup-&gt;&gt;RaftMgr: startup()</span><br><span class="line">    RaftMgr-&gt;&gt;KRaftClient: initialize(voterAddresses, null)</span><br><span class="line">    Note over KRaftClient: overrideVoterSet = null</span><br><span class="line">    </span><br><span class="line">    KRaftClient-&gt;&gt;StateMachine: new KRaftControlRecordStateMachine(staticVoters, null)</span><br><span class="line">    StateMachine-&gt;&gt;StateMachine: updateState() 从日志恢复</span><br><span class="line">    StateMachine--&gt;&gt;KRaftClient: VoterSet &#123;0, 1, 2&#125;</span><br><span class="line">    </span><br><span class="line">    KRaftClient-&gt;&gt;Network: 创建到所有 voter 的连接</span><br><span class="line">    Note over Network: bootstrapNodes = [Node(0), Node(1), Node(2)]</span><br><span class="line">    </span><br><span class="line">    KRaftClient-&gt;&gt;QuorumState: initialize()</span><br><span class="line">    QuorumState-&gt;&gt;StateMachine: lastVoterSet()</span><br><span class="line">    StateMachine--&gt;&gt;QuorumState: &#123;0, 1, 2&#125; (持久化状态)</span><br><span class="line">    </span><br><span class="line">    QuorumState-&gt;&gt;QuorumState: readElectionState()</span><br><span class="line">    QuorumState-&gt;&gt;QuorumState: 创建初始状态 (Unattached/Follower)</span><br><span class="line">    </span><br><span class="line">    alt 选举超时</span><br><span class="line">        QuorumState-&gt;&gt;QuorumState: transitionToCandidate()</span><br><span class="line">        Note over QuorumState: 使用 VoterSet &#123;0, 1, 2&#125;</span><br><span class="line">        QuorumState-&gt;&gt;Network: 向节点 0, 1, 2 发送 Vote 请求</span><br><span class="line">        Network--&gt;&gt;QuorumState: 收集选票</span><br><span class="line">        </span><br><span class="line">        alt 获得多数票 (≥2票)</span><br><span class="line">            QuorumState-&gt;&gt;QuorumState: transitionToLeader()</span><br><span class="line">            Note over QuorumState: 成为 Leader</span><br><span class="line">        else 未获得多数票</span><br><span class="line">            QuorumState-&gt;&gt;QuorumState: 等待超时重试</span><br><span class="line">        end</span><br><span class="line">    end</span><br></pre></td></tr></table></figure>
<h3 id="详细步骤"><a href="#详细步骤" class="headerlink" title="详细步骤"></a>详细步骤</h3><h4 id="步骤1：初始化阶段"><a href="#步骤1：初始化阶段" class="headerlink" title="步骤1：初始化阶段"></a>步骤1：初始化阶段</h4><blockquote>
<p><strong>源码位置：</strong> <code>raft/src/main/java/org/apache/kafka/raft/KafkaRaftClient.java:478-510</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public void initialize(..., VoterSet overrideVoterSet) &#123;</span><br><span class="line">    // overrideVoterSet = null（未配置）</span><br><span class="line">    </span><br><span class="line">    partitionState = new KRaftControlRecordStateMachine(</span><br><span class="line">        staticVoters, log, serde, bufferSupplier,</span><br><span class="line">        maxBatchSizeBytes, logContext,</span><br><span class="line">        null  // overrideVoterSet 为 null</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    // 从日志恢复状态</span><br><span class="line">    partitionState.updateState();</span><br><span class="line">    </span><br><span class="line">    // 获取持久化的 VoterSet</span><br><span class="line">    logger.info(&quot;Starting voters are &#123;&#125;&quot;, partitionState.lastVoterSet());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="步骤2：VoterSet-获取"><a href="#步骤2：VoterSet-获取" class="headerlink" title="步骤2：VoterSet 获取"></a>步骤2：VoterSet 获取</h4><blockquote>
<p><strong>源码位置：</strong> <code>raft/src/main/java/org/apache/kafka/raft/internals/KRaftControlRecordStateMachine.java:183-195</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public VoterSet lastVoterSet() &#123;</span><br><span class="line">    // overrideVoterSet == null，跳过 override 检查</span><br><span class="line">    synchronized (overrideLock) &#123;</span><br><span class="line">        if (overrideVoterSet != null &amp;&amp; !overrideApplied) &#123;</span><br><span class="line">            return overrideVoterSet;  // 不会执行</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 返回持久化状态</span><br><span class="line">    synchronized (voterSetHistory) &#123;</span><br><span class="line">        return voterSetHistory.lastValue();  // 返回 &#123;0, 1, 2&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="步骤3：选举状态初始化"><a href="#步骤3：选举状态初始化" class="headerlink" title="步骤3：选举状态初始化"></a>步骤3：选举状态初始化</h4><blockquote>
<p><strong>源码位置：</strong> <code>raft/src/main/java/org/apache/kafka/raft/QuorumState.java:147-153</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">private ElectionState readElectionState() &#123;</span><br><span class="line">    Optional&lt;ElectionState&gt; maybeElectionState = store.readElectionState();</span><br><span class="line">    </span><br><span class="line">    if (maybeElectionState.isPresent()) &#123;</span><br><span class="line">        return maybeElectionState.get();  // 返回持久化的选举状态</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        // 使用持久化的 VoterSet</span><br><span class="line">        return ElectionState.withUnknownLeader(0, partitionState.lastVoterSet().voterIds());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="步骤4：网络连接初始化"><a href="#步骤4：网络连接初始化" class="headerlink" title="步骤4：网络连接初始化"></a>步骤4：网络连接初始化</h4><blockquote>
<p><strong>源码位置：</strong> <code>raft/src/main/java/org/apache/kafka/raft/KafkaRaftClient.java:521-545</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// overrideVoterSet == null，使用静态配置</span><br><span class="line">VoterSet effectiveVoterSet = overrideVoterSet != null ? overrideVoterSet : </span><br><span class="line">    VoterSet.fromInetSocketAddresses(channel.listenerName(), voterAddresses);</span><br><span class="line"></span><br><span class="line">// 创建到所有 voter 的网络连接</span><br><span class="line">List&lt;Node&gt; bootstrapNodes = effectiveVoterSet.voterNodes()...;</span><br><span class="line">// bootstrapNodes = [Node(0), Node(1), Node(2)]</span><br><span class="line"></span><br><span class="line">logger.info(&quot;Starting request manager with static voters: &#123;&#125;&quot;, bootstrapNodes);</span><br></pre></td></tr></table></figure>
<h4 id="步骤5：选举执行"><a href="#步骤5：选举执行" class="headerlink" title="步骤5：选举执行"></a>步骤5：选举执行</h4><blockquote>
<p><strong>源码位置：</strong> <code>raft/src/main/java/org/apache/kafka/raft/KafkaRaftClient.java:711-715</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">private void transitionToCandidate(long currentTimeMs) &#123;</span><br><span class="line">    quorum.transitionToCandidate();  // 使用持久化的 VoterSet</span><br><span class="line">    maybeFireLeaderChange();</span><br><span class="line">    onBecomeCandidate(currentTimeMs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>源码位置：</strong> <code>raft/src/main/java/org/apache/kafka/raft/QuorumState.java:598-615</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public void transitionToCandidate() &#123;</span><br><span class="line">    // ...</span><br><span class="line">    durableTransitionTo(new CandidateState(</span><br><span class="line">        time,</span><br><span class="line">        localIdOrThrow(),</span><br><span class="line">        localDirectoryId,</span><br><span class="line">        newEpoch,</span><br><span class="line">        partitionState.lastVoterSet(),  // 使用持久化的 VoterSet &#123;0, 1, 2&#125;</span><br><span class="line">        state.highWatermark(),</span><br><span class="line">        retries,</span><br><span class="line">        electionTimeoutMs,</span><br><span class="line">        logContext</span><br><span class="line">    ));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="选举结果"><a href="#选举结果" class="headerlink" title="选举结果"></a>选举结果</h3><ul>
<li><p><strong>需要获得的选票</strong>：多数票（3节点需要2票）</p>
</li>
<li><p><strong>网络连接</strong>：连接到所有 voter（节点0, 1, 2）</p>
</li>
<li><p><strong>选举成功条件</strong>：获得至少2个节点的选票</p>
</li>
</ul>
<hr>
<h2 id="场景二：Override-功能开启（紧急恢复模式）"><a href="#场景二：Override-功能开启（紧急恢复模式）" class="headerlink" title="场景二：Override 功能开启（紧急恢复模式）"></a>场景二：Override 功能开启（紧急恢复模式）</h2><h3 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 配置 override，强制指定单节点</span><br><span class="line">controller.quorum.voters.override=2@host2:9092:JdGYVjmQfoKkt2uw6J-OIw</span><br><span class="line">controller.quorum.voters=0@host0:9092,1@host1:9092,2@host2:9092</span><br></pre></td></tr></table></figure>
<h3 id="选举流程-1"><a href="#选举流程-1" class="headerlink" title="选举流程"></a>选举流程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">    participant Startup as 服务启动</span><br><span class="line">    participant RaftMgr as RaftManager</span><br><span class="line">    participant KRaftClient as KafkaRaftClient</span><br><span class="line">    participant StateMachine as KRaftControlRecordStateMachine</span><br><span class="line">    participant QuorumState as QuorumState</span><br><span class="line">    participant Network as 网络层</span><br><span class="line"></span><br><span class="line">    Startup-&gt;&gt;RaftMgr: startup()</span><br><span class="line">    RaftMgr-&gt;&gt;RaftMgr: parseVoterSetOverride()</span><br><span class="line">    Note over RaftMgr: 解析 override 配置 → VoterSet &#123;2&#125;</span><br><span class="line">    </span><br><span class="line">    RaftMgr-&gt;&gt;KRaftClient: initialize(voterAddresses, overrideVoterSet)</span><br><span class="line">    Note over KRaftClient: overrideVoterSet = &#123;2&#125;</span><br><span class="line">    </span><br><span class="line">    KRaftClient-&gt;&gt;StateMachine: new KRaftControlRecordStateMachine(staticVoters, overrideVoterSet)</span><br><span class="line">    Note over StateMachine: overrideVoterSet = &#123;2&#125;, overrideApplied = false</span><br><span class="line">    StateMachine-&gt;&gt;StateMachine: updateState() 从日志恢复</span><br><span class="line">    Note over StateMachine: voterSetHistory = &#123;0, 1, 2&#125;</span><br><span class="line">    </span><br><span class="line">    KRaftClient-&gt;&gt;Network: 创建到 override 节点的连接</span><br><span class="line">    Note over Network: bootstrapNodes = [Node(2)] (只有节点2)</span><br><span class="line">    </span><br><span class="line">    KRaftClient-&gt;&gt;QuorumState: initialize()</span><br><span class="line">    QuorumState-&gt;&gt;StateMachine: lastVoterSet()</span><br><span class="line">    Note over StateMachine: overrideVoterSet != null &amp;&amp; !overrideApplied</span><br><span class="line">    StateMachine--&gt;&gt;QuorumState: &#123;2&#125; (override 配置)</span><br><span class="line">    </span><br><span class="line">    QuorumState-&gt;&gt;QuorumState: readElectionState()</span><br><span class="line">    QuorumState-&gt;&gt;QuorumState: 创建初始状态 (Unattached)</span><br><span class="line">    </span><br><span class="line">    Note over QuorumState: 单节点选举</span><br><span class="line">    QuorumState-&gt;&gt;QuorumState: transitionToCandidate()</span><br><span class="line">    Note over QuorumState: 使用 VoterSet &#123;2&#125;</span><br><span class="line">    QuorumState-&gt;&gt;QuorumState: 节点2给自己投票</span><br><span class="line">    Note over QuorumState: 获得 1/1 多数票</span><br><span class="line">    </span><br><span class="line">    QuorumState-&gt;&gt;QuorumState: transitionToLeader()</span><br><span class="line">    KRaftClient-&gt;&gt;KRaftClient: onBecomeLeader()</span><br><span class="line">    </span><br><span class="line">    KRaftClient-&gt;&gt;StateMachine: shouldApplyOverrideVoterSet()</span><br><span class="line">    StateMachine--&gt;&gt;KRaftClient: true</span><br><span class="line">    </span><br><span class="line">    KRaftClient-&gt;&gt;StateMachine: applyOverrideVoterSet(leaderState, currentTimeMs)</span><br><span class="line">    Note over StateMachine: 1. overrideApplied = true</span><br><span class="line">    Note over StateMachine: 2. 写入 VotersRecord 到日志</span><br><span class="line">    Note over StateMachine: 3. overrideVoterSet = null</span><br><span class="line">    </span><br><span class="line">    Note over StateMachine: 后续 lastVoterSet() 返回持久化状态</span><br></pre></td></tr></table></figure>
<h3 id="详细步骤-1"><a href="#详细步骤-1" class="headerlink" title="详细步骤"></a>详细步骤</h3><h4 id="步骤1：配置解析"><a href="#步骤1：配置解析" class="headerlink" title="步骤1：配置解析"></a>步骤1：配置解析</h4><blockquote>
<p><strong>源码位置：</strong> <code>core/src/main/scala/kafka/raft/RaftManager.scala</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">def startup(): Unit = &#123;</span><br><span class="line">    // 解析 override 配置</span><br><span class="line">    val overrideVoterSet = QuorumConfig.parseVoterSetOverride(</span><br><span class="line">        config.quorumVotersOverride,</span><br><span class="line">        channel.listenerName()</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    // 传递给 KafkaRaftClient</span><br><span class="line">    raftClient.initialize(voterAddresses, quorumStateStore, metrics, overrideVoterSet)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="步骤2：初始化阶段"><a href="#步骤2：初始化阶段" class="headerlink" title="步骤2：初始化阶段"></a>步骤2：初始化阶段</h4><blockquote>
<p><strong>源码位置：</strong> <code>raft/src/main/java/org/apache/kafka/raft/KafkaRaftClient.java:478-510</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public void initialize(..., VoterSet overrideVoterSet) &#123;</span><br><span class="line">    // overrideVoterSet = &#123;2&#125;（从配置解析）</span><br><span class="line">    </span><br><span class="line">    if (overrideVoterSet != null) &#123;</span><br><span class="line">        logger.warn(&quot;Using voter override configuration&quot;);</span><br><span class="line">        logger.warn(&quot;Static CurrentVoters:     &#123;&#125;&quot;, staticVotersInfo);   // &#123;0, 1, 2&#125;</span><br><span class="line">        logger.warn(&quot;Override CurrentVoters:   &#123;&#125;&quot;, overrideVotersInfo); // &#123;2&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    partitionState = new KRaftControlRecordStateMachine(</span><br><span class="line">        staticVoters, log, serde, bufferSupplier,</span><br><span class="line">        maxBatchSizeBytes, logContext,</span><br><span class="line">        overrideVoterSet  // 传递 override 配置</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="步骤3：VoterSet-获取（选举阶段）"><a href="#步骤3：VoterSet-获取（选举阶段）" class="headerlink" title="步骤3：VoterSet 获取（选举阶段）"></a>步骤3：VoterSet 获取（选举阶段）</h4><blockquote>
<p><strong>源码位置：</strong> <code>raft/src/main/java/org/apache/kafka/raft/internals/KRaftControlRecordStateMachine.java:183-195</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public VoterSet lastVoterSet() &#123;</span><br><span class="line">    // overrideVoterSet != null &amp;&amp; !overrideApplied</span><br><span class="line">    synchronized (overrideLock) &#123;</span><br><span class="line">        if (overrideVoterSet != null &amp;&amp; !overrideApplied) &#123;</span><br><span class="line">            return overrideVoterSet;  // 返回 &#123;2&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 不会执行到这里</span><br><span class="line">    synchronized (voterSetHistory) &#123;</span><br><span class="line">        return voterSetHistory.lastValue();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="步骤4：网络连接初始化-1"><a href="#步骤4：网络连接初始化-1" class="headerlink" title="步骤4：网络连接初始化"></a>步骤4：网络连接初始化</h4><blockquote>
<p><strong>源码位置：</strong> <code>raft/src/main/java/org/apache/kafka/raft/KafkaRaftClient.java:521-545</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// overrideVoterSet != null，使用 override 配置</span><br><span class="line">VoterSet effectiveVoterSet = overrideVoterSet != null ? overrideVoterSet : </span><br><span class="line">    VoterSet.fromInetSocketAddresses(channel.listenerName(), voterAddresses);</span><br><span class="line"></span><br><span class="line">// 只创建到 override 节点的网络连接</span><br><span class="line">List&lt;Node&gt; bootstrapNodes = effectiveVoterSet.voterNodes()...;</span><br><span class="line">// bootstrapNodes = [Node(2)]  // 只有节点2</span><br><span class="line"></span><br><span class="line">logger.info(&quot;Starting request manager with override voters: &#123;&#125;&quot;, bootstrapNodes);</span><br></pre></td></tr></table></figure>
<h4 id="步骤5：单节点选举"><a href="#步骤5：单节点选举" class="headerlink" title="步骤5：单节点选举"></a>步骤5：单节点选举</h4><blockquote>
<p><strong>源码位置：</strong> <code>raft/src/main/java/org/apache/kafka/raft/KafkaRaftClient.java:583-586</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// When there is only a single voter, become candidate immediately</span><br><span class="line">if (quorum.isOnlyVoter() &amp;&amp; !quorum.isCandidate()) &#123;</span><br><span class="line">    transitionToCandidate(currentTimeMs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>源码位置：</strong> <code>raft/src/main/java/org/apache/kafka/raft/QuorumState.java:330-337</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public boolean isOnlyVoter() &#123;</span><br><span class="line">    return localId.isPresent() &amp;&amp;</span><br><span class="line">        partitionState</span><br><span class="line">            .lastVoterSet()  // 返回 override VoterSet &#123;2&#125;</span><br><span class="line">            .isOnlyVoter(ReplicaKey.of(localId.getAsInt(), localDirectoryId));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="步骤6：成为-Leader-并应用-Override"><a href="#步骤6：成为-Leader-并应用-Override" class="headerlink" title="步骤6：成为 Leader 并应用 Override"></a>步骤6：成为 Leader 并应用 Override</h4><blockquote>
<p><strong>源码位置：</strong> <code>raft/src/main/java/org/apache/kafka/raft/KafkaRaftClient.java:655-686</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">private void onBecomeLeader(long currentTimeMs) &#123;</span><br><span class="line">    long endOffset = log.endOffset().offset();</span><br><span class="line"></span><br><span class="line">    BatchAccumulator&lt;T&gt; accumulator = new BatchAccumulator&lt;&gt;(...);</span><br><span class="line">    LeaderState&lt;T&gt; state = quorum.transitionToLeader(endOffset, accumulator);</span><br><span class="line"></span><br><span class="line">    log.initializeLeaderEpoch(quorum.epoch());</span><br><span class="line">    state.appendStartOfEpochControlRecords(quorum.localVoterNodeOrThrow(), currentTimeMs);</span><br><span class="line"></span><br><span class="line">    // 应用 override 配置到持久化状态</span><br><span class="line">    if (partitionState.shouldApplyOverrideVoterSet()) &#123;</span><br><span class="line">        partitionState.applyOverrideVoterSet(state, currentTimeMs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    resetConnections();</span><br><span class="line">    kafkaRaftMetrics.maybeUpdateElectionLatency(currentTimeMs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="步骤7：Override-应用"><a href="#步骤7：Override-应用" class="headerlink" title="步骤7：Override 应用"></a>步骤7：Override 应用</h4><blockquote>
<p><strong>源码位置：</strong> <code>raft/src/main/java/org/apache/kafka/raft/internals/KRaftControlRecordStateMachine.java:207-245</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">public void applyOverrideVoterSet(LeaderState&lt;?&gt; leaderState, long currentTimeMs) &#123;</span><br><span class="line">    VoterSet voterSetToApply;</span><br><span class="line">    </span><br><span class="line">    // 原子性检查并标记已应用</span><br><span class="line">    synchronized (overrideLock) &#123;</span><br><span class="line">        if (overrideVoterSet == null || overrideApplied) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        overrideApplied = true;  // 标记已应用</span><br><span class="line">        voterSetToApply = overrideVoterSet;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    logger.warn(&quot;Applying override voter set to persistent state&quot;);</span><br><span class="line">    </span><br><span class="line">    // 写入 VotersRecord 到 Raft 日志</span><br><span class="line">    leaderState.appendVotersRecord(voterSetToApply, currentTimeMs);</span><br><span class="line">    </span><br><span class="line">    // 清除 override 配置</span><br><span class="line">    synchronized (overrideLock) &#123;</span><br><span class="line">        overrideVoterSet = null;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    logger.warn(&quot;Override voter set applied to persistent state and cleared&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="选举结果-1"><a href="#选举结果-1" class="headerlink" title="选举结果"></a>选举结果</h3><ul>
<li><p><strong>需要获得的选票</strong>：多数票（1节点需要1票）</p>
</li>
<li><p><strong>网络连接</strong>：只连接到 override 配置的节点（节点2）</p>
</li>
<li><p><strong>选举成功条件</strong>：节点2给自己投票即可</p>
</li>
<li><p><strong>后续状态</strong>：Override 配置转换为持久化状态，后续操作基于持久化状态</p>
</li>
</ul>
<hr>
<h2 id="流程对比"><a href="#流程对比" class="headerlink" title="流程对比"></a>流程对比</h2><h3 id="关键差异对比表"><a href="#关键差异对比表" class="headerlink" title="关键差异对比表"></a>关键差异对比表</h3><p>|阶段|Override 关闭|Override 开启|</p>
<p>|-|-|-|</p>
<p>|<strong>VoterSet 来源</strong>|持久化状态|Override 配置|</p>
<p>|<strong>网络连接</strong>|连接所有 voter|只连接 override 节点|</p>
<p>|<strong>选举参与者</strong>|所有持久化 voter|只有 override 节点|</p>
<p>|<strong>多数票计算</strong>|基于持久化 VoterSet|基于 override VoterSet|</p>
<p>|<strong>成为 Leader 后</strong>|无额外操作|应用 override 到持久化状态|</p>
<p>|<strong>后续操作</strong>|基于持久化状态|基于新的持久化状态|</p>
<h3 id="状态转换对比"><a href="#状态转换对比" class="headerlink" title="状态转换对比"></a>状态转换对比</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    subgraph Override关闭</span><br><span class="line">        A1[启动] --&gt; B1[读取持久化 VoterSet]</span><br><span class="line">        B1 --&gt; C1[&quot;&#123;0,1,2&#125;&quot;]</span><br><span class="line">        C1 --&gt; D1[选举需要2票]</span><br><span class="line">        D1 --&gt; E1[成为 Leader]</span><br><span class="line">        E1 --&gt; F1[正常运行]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph Override开启</span><br><span class="line">        A2[启动] --&gt; B2[使用 Override VoterSet]</span><br><span class="line">        B2 --&gt; C2[&quot;&#123;2&#125;&quot;]</span><br><span class="line">        C2 --&gt; D2[选举需要1票]</span><br><span class="line">        D2 --&gt; E2[成为 Leader]</span><br><span class="line">        E2 --&gt; F2[应用 Override]</span><br><span class="line">        F2 --&gt; G2[清除 Override]</span><br><span class="line">        G2 --&gt; H2[正常运行]</span><br><span class="line">    end</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="交互流程"><a href="#交互流程" class="headerlink" title="交互流程"></a>交互流程</h2><h3 id="Override-关闭时的关键路径"><a href="#Override-关闭时的关键路径" class="headerlink" title="Override 关闭时的关键路径"></a>Override 关闭时的关键路径</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">flowchart TD</span><br><span class="line">    A[RaftManager.startup] --&gt; B[KafkaRaftClient.initialize]</span><br><span class="line">    B --&gt; C[KRaftControlRecordStateMachine 构造]</span><br><span class="line">    C --&gt; D[overrideVoterSet = null]</span><br><span class="line">    D --&gt; E[updateState 从日志恢复]</span><br><span class="line">    E --&gt; F[lastVoterSet 返回持久化状态]</span><br><span class="line">    F --&gt; G[QuorumState.initialize]</span><br><span class="line">    G --&gt; H[transitionToCandidate]</span><br><span class="line">    H --&gt; I[向所有 voter 请求选票]</span><br><span class="line">    I --&gt; J&#123;获得多数票?&#125;</span><br><span class="line">    J --&gt;|是| K[onBecomeLeader]</span><br><span class="line">    J --&gt;|否| L[等待超时重试]</span><br><span class="line">    L --&gt; H</span><br><span class="line">    K --&gt; M[正常运行]</span><br><span class="line">    </span><br><span class="line">    style D fill:#e0e0e0</span><br><span class="line">    style F fill:#4caf50</span><br><span class="line">    style K fill:#2196f3</span><br></pre></td></tr></table></figure>
<p><strong>关键步骤源码映射：</strong></p>
<ol>
<li><p>步骤1 → <code>RaftManager.scala:206</code> - startup()</p>
</li>
<li><p>步骤2 → <code>KafkaRaftClient.java:478</code> - initialize()</p>
</li>
<li><p>步骤3 → <code>KRaftControlRecordStateMachine.java:87</code> - 构造函数</p>
</li>
<li><p>步骤4 → <code>KRaftControlRecordStateMachine.java:183</code> - lastVoterSet()</p>
</li>
<li><p>步骤5 → <code>QuorumState.java:240</code> - initialize()</p>
</li>
<li><p>步骤6 → <code>KafkaRaftClient.java:711</code> - transitionToCandidate()</p>
</li>
<li><p>步骤7 → <code>KafkaRaftClient.java:655</code> - onBecomeLeader()</p>
</li>
</ol>
<h3 id="Override-开启时的关键路径"><a href="#Override-开启时的关键路径" class="headerlink" title="Override 开启时的关键路径"></a>Override 开启时的关键路径</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">flowchart TD</span><br><span class="line">    A[RaftManager.startup] --&gt; B[parseVoterSetOverride]</span><br><span class="line">    B --&gt; C[KafkaRaftClient.initialize with override]</span><br><span class="line">    C --&gt; D[KRaftControlRecordStateMachine 构造]</span><br><span class="line">    D --&gt; E[overrideVoterSet = 配置值]</span><br><span class="line">    E --&gt; F[updateState 从日志恢复]</span><br><span class="line">    F --&gt; G[lastVoterSet 返回 override 配置]</span><br><span class="line">    G --&gt; H[QuorumState.initialize]</span><br><span class="line">    H --&gt; I[isOnlyVoter 检查]</span><br><span class="line">    I --&gt; J[transitionToCandidate]</span><br><span class="line">    J --&gt; K[单节点自选举]</span><br><span class="line">    K --&gt; L[onBecomeLeader]</span><br><span class="line">    L --&gt; M&#123;shouldApplyOverrideVoterSet?&#125;</span><br><span class="line">    M --&gt;|是| N[applyOverrideVoterSet]</span><br><span class="line">    N --&gt; O[写入 VotersRecord]</span><br><span class="line">    O --&gt; P[overrideApplied = true]</span><br><span class="line">    P --&gt; Q[overrideVoterSet = null]</span><br><span class="line">    Q --&gt; R[正常运行]</span><br><span class="line">    </span><br><span class="line">    style E fill:#ffeb3b</span><br><span class="line">    style G fill:#ffeb3b</span><br><span class="line">    style N fill:#4caf50</span><br><span class="line">    style Q fill:#4caf50</span><br></pre></td></tr></table></figure>
<p><strong>关键步骤源码映射：</strong></p>
<ol>
<li><p>步骤1 → <code>RaftManager.scala:206</code> - startup()</p>
</li>
<li><p>步骤2 → <code>QuorumConfig.java</code> - parseVoterSetOverride()</p>
</li>
<li><p>步骤3 → <code>KafkaRaftClient.java:478</code> - initialize()</p>
</li>
<li><p>步骤4 → <code>KRaftControlRecordStateMachine.java:100</code> - 构造函数(带override)</p>
</li>
<li><p>步骤5 → <code>KRaftControlRecordStateMachine.java:183</code> - lastVoterSet()</p>
</li>
<li><p>步骤6 → <code>QuorumState.java:330</code> - isOnlyVoter()</p>
</li>
<li><p>步骤7 → <code>KafkaRaftClient.java:583</code> - 单节点立即选举</p>
</li>
<li><p>步骤8 → <code>KafkaRaftClient.java:655</code> - onBecomeLeader()</p>
</li>
<li><p>步骤9 → <code>KRaftControlRecordStateMachine.java:197</code> - shouldApplyOverrideVoterSet()</p>
</li>
<li><p>步骤10 → <code>KRaftControlRecordStateMachine.java:207</code> - applyOverrideVoterSet()</p>
</li>
</ol>
<hr>
<h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><h3 id="Override-功能的核心作用"><a href="#Override-功能的核心作用" class="headerlink" title="Override 功能的核心作用"></a>Override 功能的核心作用</h3><ol>
<li><p><strong>紧急恢复</strong>：在 CurrentVoters 损坏时，允许单节点启动并成为 Leader</p>
</li>
<li><p><strong>一次性校准</strong>：Override 配置在成为 Leader 后立即转换为持久化状态</p>
</li>
<li><p><strong>恢复正常</strong>：应用后自动清除 override，后续操作基于持久化状态</p>
</li>
</ol>
<h3 id="设计优势"><a href="#设计优势" class="headerlink" title="设计优势"></a>设计优势</h3><ol>
<li><p><strong>最小侵入</strong>：只在选举阶段使用 override，不影响正常运行</p>
</li>
<li><p><strong>自动转换</strong>：成为 Leader 后自动将 override 转换为持久化状态</p>
</li>
<li><p><strong>兼容性好</strong>：后续的 add/remove-controller 操作完全正常工作</p>
</li>
</ol>
<h3 id="使用建议"><a href="#使用建议" class="headerlink" title="使用建议"></a>使用建议</h3><ol>
<li><p><strong>仅用于紧急恢复</strong>：Override 配置应仅在 CurrentVoters 损坏时使用</p>
</li>
<li><p><strong>恢复后移除配置</strong>：成功恢复后应从配置文件中移除 override 配置</p>
</li>
<li><p><strong>逐步重建</strong>：使用 add-controller 命令逐步添加其他节点</p>
</li>
</ol>
<h1 id="本地测试"><a href="#本地测试" class="headerlink" title="本地测试"></a>本地测试</h1><p>为了校验代码的正确性，在对线上集群进行止损前，搭建了一个线下集群用于测试。环境位于 44 机器上，路径为  /home/disk0/nizhenhyang/kafka-kraft-voter-fix-test</p>
<h2 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a>测试环境</h2><ul>
<li><p>c0 8100</p>
</li>
<li><p>c1 8110</p>
</li>
<li><p>c2 8120</p>
</li>
<li><p>b3 8140</p>
</li>
</ul>
<p>包含三个 controller （voter）节点和一个普通（broker）节点</p>
<h2 id="服务启动"><a href="#服务启动" class="headerlink" title="服务启动"></a>服务启动</h2><p>cluster id SBYtyuhkTNGeZco8wQg5hw</p>
<h3 id="c0"><a href="#c0" class="headerlink" title="c0"></a>c0</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">export JAVA_HOME=$(pwd)/java17</span><br><span class="line">export PATH=$(pwd)/java17/bin:$PATH</span><br><span class="line">export KAFKA_PORT=8100</span><br><span class="line"></span><br><span class="line">./bin/kafka-storage.sh format --cluster-id SBYtyuhkTNGeZco8wQg5hw --standalone --config server.env_0.properties</span><br><span class="line">./bin/kafka-server-start.sh -daemon server.env_0.properties</span><br><span class="line"></span><br><span class="line">./bin/kafka-metadata-quorum.sh --bootstrap-controller $(hostname -i):8101 --command-config server.env_0.properties add-controller</span><br><span class="line"></span><br><span class="line">./bin/kafka-metadata-quorum.sh --bootstrap-controller $(hostname -i):8101 describe --status</span><br></pre></td></tr></table></figure>
<h3 id="c1"><a href="#c1" class="headerlink" title="c1"></a>c1</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">export JAVA_HOME=$(pwd)/java17</span><br><span class="line">export PATH=$(pwd)/java17/bin:$PATH</span><br><span class="line">export KAFKA_PORT=8110</span><br><span class="line"></span><br><span class="line">./bin/kafka-storage.sh format --cluster-id SBYtyuhkTNGeZco8wQg5hw --no-initial-controllers --config server.env_1.properties</span><br><span class="line">./bin/kafka-server-start.sh -daemon server.env_1.properties</span><br><span class="line"></span><br><span class="line">./bin/kafka-metadata-quorum.sh --bootstrap-controller $(hostname -i):8101 --command-config server.env_1.properties add-controller</span><br></pre></td></tr></table></figure>
<h3 id="c2"><a href="#c2" class="headerlink" title="c2"></a>c2</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">export JAVA_HOME=$(pwd)/java17</span><br><span class="line">export PATH=$(pwd)/java17/bin:$PATH</span><br><span class="line">export KAFKA_PORT=8120</span><br><span class="line"></span><br><span class="line">./bin/kafka-storage.sh format --cluster-id SBYtyuhkTNGeZco8wQg5hw --no-initial-controllers --config server.env_2.properties</span><br><span class="line">./bin/kafka-server-start.sh -daemon server.env_2.properties</span><br><span class="line"></span><br><span class="line">./bin/kafka-metadata-quorum.sh --bootstrap-controller $(hostname -i):8101 --command-config server.env_2.properties add-controller</span><br></pre></td></tr></table></figure>
<h3 id="b3"><a href="#b3" class="headerlink" title="b3"></a>b3</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">export JAVA_HOME=$(pwd)/java17</span><br><span class="line">export PATH=$(pwd)/java17/bin:$PATH</span><br><span class="line">export KAFKA_PORT=8140</span><br><span class="line"></span><br><span class="line">./bin/kafka-storage.sh format --cluster-id SBYtyuhkTNGeZco8wQg5hw --no-initial-controllers --config server.env_3.properties</span><br><span class="line">./bin/kafka-server-start.sh -daemon server.env_3.properties</span><br></pre></td></tr></table></figure>
<h2 id="读写数据"><a href="#读写数据" class="headerlink" title="读写数据"></a>读写数据</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kaf  -b $(hostname -i):8100 topic create test_nzy --partitions 3 --replicas 3</span><br><span class="line"></span><br><span class="line">kaf  -b $(hostname -i):8100 produce test_nzy</span><br><span class="line">kaf  -b $(hostname -i):8100 produce test_nzy --partition 1</span><br><span class="line">kaf  -b $(hostname -i):8100 produce test_nzy --partition 2</span><br><span class="line"></span><br><span class="line">kaf  -b $(hostname -i):8100  consume test_nzy</span><br></pre></td></tr></table></figure>
<h2 id="破坏环境"><a href="#破坏环境" class="headerlink" title="破坏环境"></a>破坏环境</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/kafka-metadata-quorum.sh --bootstrap-controller $(hostname -i):8101  describe --status</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ClusterId:              SBYtyuhkTNGeZco8wQg5hw</span><br><span class="line">LeaderId:               0</span><br><span class="line">LeaderEpoch:            1</span><br><span class="line">HighWatermark:          584</span><br><span class="line">MaxFollowerLag:         0</span><br><span class="line">MaxFollowerLagTimeMs:   0</span><br><span class="line">CurrentVoters:          [&#123;&quot;id&quot;: 0, &quot;directoryId&quot;: &quot;7O6kd02kQCGdZ4mw8BZSKQ&quot;, &quot;endpoints&quot;: [&quot;CONTROLLER://10.144.79.15:8101&quot;]&#125;, &#123;&quot;id&quot;: 1, &quot;directoryId&quot;: &quot;u-IcQ0UoP7wPHs5S0JKXlQ&quot;, &quot;endpoints&quot;: [&quot;CONTROLLER://10.144.79.15:8111&quot;]&#125;, &#123;&quot;id&quot;: 2, &quot;directoryId&quot;: &quot;8YTCnijW9E49vJRze4z5HA&quot;, &quot;endpoints&quot;: [&quot;CONTROLLER://10.144.79.15:8121&quot;]&#125;]</span><br><span class="line">CurrentObservers:       [&#123;&quot;id&quot;: 3, &quot;directoryId&quot;: &quot;BpTuX0zkGVyVa846980_Xw&quot;&#125;]</span><br></pre></td></tr></table></figure>
<h3 id="1-切换-c1-的-dir-id"><a href="#1-切换-c1-的-dir-id" class="headerlink" title="1. 切换 c1 的 dir id"></a>1. 切换 c1 的 dir id</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mv metadata/ metadata_right_bak/</span><br><span class="line">cp -r metadata_right_bak metadata/</span><br><span class="line"># 然后修改 meta.properties 中的 dir id</span><br></pre></td></tr></table></figure>
<p>然后启动服务, 日志输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[2025-12-11 15:28:33,297] INFO [RaftManager id=1] Leader sent a voter key (Optional[ReplicaKey(id=1, directoryId=Optional[u-IcQ0UoP7wPHs5S0JKXlQ])]) in the BEGIN_QUORUM_EPOCH request that doesn&apos;t match the local key (OptionalInt[1], u-IcQ0UoP7wPHs5S0JKXlw); returning INVALID_VOTER_KEY (org.apache.kafka.raft.KafkaRaftClient)</span><br></pre></td></tr></table></figure>
<p>此时 c0 的日志：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[2025-12-11 15:28:58,298] INFO [RaftManager id=0] Voter key for VOTE or BEGIN_QUORUM_EPOCH request didn&apos;t match the receiver&apos;s replica key: 10.144.79.15:8111 (id: 1 rack: null) (org.apache.kafka.raft.KafkaRaftClient)</span><br></pre></td></tr></table></figure>
<p>现在的情况是，leader 依旧存在，但是其中存储的 c1 meta 信息是错误的。由于当前有两个 voter 存活，所以集群依然可以运行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">./bin/kafka-metadata-quorum.sh --bootstrap-controller $(hostname -i):8101  describe --status</span><br><span class="line">ClusterId:              SBYtyuhkTNGeZco8wQg5hw</span><br><span class="line">LeaderId:               0</span><br><span class="line">LeaderEpoch:            1</span><br><span class="line">HighWatermark:          1459</span><br><span class="line">MaxFollowerLag:         376</span><br><span class="line">MaxFollowerLagTimeMs:   185845</span><br><span class="line">CurrentVoters:          [&#123;&quot;id&quot;: 0, &quot;directoryId&quot;: &quot;7O6kd02kQCGdZ4mw8BZSKQ&quot;, &quot;endpoints&quot;: [&quot;CONTROLLER://10.144.79.15:8101&quot;]&#125;, &#123;&quot;id&quot;: 1, &quot;directoryId&quot;: &quot;u-IcQ0UoP7wPHs5S0JKXlQ&quot;, &quot;endpoints&quot;: [&quot;CONTROLLER://10.144.79.15:8111&quot;]&#125;, &#123;&quot;id&quot;: 2, &quot;directoryId&quot;: &quot;8YTCnijW9E49vJRze4z5HA&quot;, &quot;endpoints&quot;: [&quot;CONTROLLER://10.144.79.15:8121&quot;]&#125;]</span><br><span class="line">CurrentObservers:       [&#123;&quot;id&quot;: 3, &quot;directoryId&quot;: &quot;BpTuX0zkGVyVa846980_Xw&quot;&#125;]</span><br></pre></td></tr></table></figure>
<p>此时集群的 leader 还是有的，可以读取到数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ kaf  -b $(hostname -i):8100 topic describe test_nzy</span><br><span class="line">Name:        test_nzy   </span><br><span class="line">Internal:    false      </span><br><span class="line">Compacted:   false      </span><br><span class="line">Partitions:</span><br><span class="line">  Partition  High Watermark  Leader  Replicas  ISR      </span><br><span class="line">  ---------  --------------  ------  --------  ---      </span><br><span class="line">  0          8               0       [0 1 2]   [0 1 2]  </span><br><span class="line">  1          12              2       [1 2 3]   [1 2 3]  </span><br><span class="line">  2          12              2       [0 2 3]   [0 2 3]  </span><br><span class="line">Summed HighWatermark:  32</span><br><span class="line">Config:</span><br><span class="line">  Name               Value       ReadOnly  Sensitive  </span><br><span class="line">  ----               -----       --------  ---------  </span><br><span class="line">  cleanup.policy     delete      false     false      </span><br><span class="line">  segment.bytes      1073741824  false     false      </span><br><span class="line">  max.message.bytes  67108864    false     false</span><br></pre></td></tr></table></figure>
<h3 id="2-stop-c0"><a href="#2-stop-c0" class="headerlink" title="2. stop c0"></a>2. stop c0</h3><p>stop c0 ，模拟切主的情况，此时没有 leader 了, 因为当前集群元信息中有三个节点，一个节点挂了，一个节点的信息有误</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># c1 丢主</span><br><span class="line">curl 10.144.79.15:8114/metrics | grep &apos;kafka_server_raftmetrics_current_leader&apos;</span><br><span class="line">kafka_server_raftmetrics_current_leader -1.0</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># c2 丢主</span><br><span class="line">curl 10.144.79.15:8124/metrics | grep &apos;kafka_server_raftmetrics_current_leader&apos;</span><br><span class="line">kafka_server_raftmetrics_current_leader -1.0</span><br></pre></td></tr></table></figure>
<h2 id="新机制是否有效"><a href="#新机制是否有效" class="headerlink" title="新机制是否有效"></a>新机制是否有效</h2><p>选用 c2 测试，替换其使用的 jar 包，然后在配置文件中添加配置 <a href="mailto:`controller.quorum.voters.override=2@10.144.79.15" target="_blank" rel="noopener">`controller.quorum.voters.override=2@10.144.79.15</a>:8121:8YTCnijW9E49vJRze4z5HA` 后重启服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/kafka-metadata-quorum.sh --bootstrap-controller $(hostname -i):8121  describe --status</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># work @ bjyz-201605-m32-wise044 in /home/disk0/nizhenhyang/kafka-kraft-voter-fix-test/exec_env/c2 [16:36:44] </span><br><span class="line">$ ./bin/kafka-metadata-quorum.sh --bootstrap-controller $(hostname -i):8121  describe --status</span><br><span class="line">ClusterId:              SBYtyuhkTNGeZco8wQg5hw</span><br><span class="line">LeaderId:               2</span><br><span class="line">LeaderEpoch:            107</span><br><span class="line">HighWatermark:          2619</span><br><span class="line">MaxFollowerLag:         0</span><br><span class="line">MaxFollowerLagTimeMs:   0</span><br><span class="line">CurrentVoters:          [&#123;&quot;id&quot;: 2, &quot;directoryId&quot;: &quot;8YTCnijW9E49vJRze4z5HA&quot;, &quot;endpoints&quot;: [&quot;CONTROLLER://10.144.79.15:8121&quot;]&#125;]</span><br><span class="line">CurrentObservers:       [&#123;&quot;id&quot;: 3, &quot;directoryId&quot;: &quot;BpTuX0zkGVyVa846980_Xw&quot;&#125;]</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kaf nodes -b $(hostname -i):8120</span><br><span class="line">ID    ADDRESS             CONTROLLER   </span><br><span class="line">2     10.144.79.15:8120   true         </span><br><span class="line">3     10.144.79.15:8140   false</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ kaf  -b $(hostname -i):8120 topic describe test_nzy</span><br><span class="line">Name:        test_nzy   </span><br><span class="line">Internal:    false      </span><br><span class="line">Compacted:   false      </span><br><span class="line">Partitions:</span><br><span class="line">  Partition  High Watermark  Leader  Replicas  ISR    </span><br><span class="line">  ---------  --------------  ------  --------  ---    </span><br><span class="line">  0          8               2       [0 1 2]   [2]    </span><br><span class="line">  1          12              3       [1 2 3]   [2 3]  </span><br><span class="line">  2          12              3       [0 2 3]   [2 3]  </span><br><span class="line">Summed HighWatermark:  32</span><br><span class="line">Config:</span><br><span class="line">  Name               Value       ReadOnly  Sensitive  </span><br><span class="line">  ----               -----       --------  ---------  </span><br><span class="line">  cleanup.policy     delete      false     false      </span><br><span class="line">  segment.bytes      1073741824  false     false      </span><br><span class="line">  max.message.bytes  67108864    false     false</span><br></pre></td></tr></table></figure>
<p>可以看到，当前 voter 为 2，集群元信息均存在，且普通的 broker 自动加入进来了，之后清空 c0 和 c1 的 <code>__cluster_metadata-0</code> 后重启，并执行 <code>add-controller</code>命令，集群恢复正常</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># work @ bjyz-201605-m32-wise044 in /home/disk0/nizhenhyang/kafka-kraft-voter-fix-test/exec_env/c2 [19:25:57] </span><br><span class="line">$  ./bin/kafka-metadata-quorum.sh --bootstrap-controller $(hostname -i):8121  describe --status</span><br><span class="line">ClusterId:              SBYtyuhkTNGeZco8wQg5hw</span><br><span class="line">LeaderId:               0</span><br><span class="line">LeaderEpoch:            8</span><br><span class="line">HighWatermark:          177370</span><br><span class="line">MaxFollowerLag:         1</span><br><span class="line">MaxFollowerLagTimeMs:   443</span><br><span class="line">CurrentVoters:          [&#123;&quot;id&quot;: 0, &quot;directoryId&quot;: &quot;7O6kd02kQCGdZ4mw8BZSKQ&quot;, &quot;endpoints&quot;: [&quot;CONTROLLER://10.144.79.15:8101&quot;]&#125;, &#123;&quot;id&quot;: 1, &quot;directoryId&quot;: &quot;u-IcQ0UoP7wPHs5S0JKXlw&quot;, &quot;endpoints&quot;: [&quot;CONTROLLER://10.144.79.15:8111&quot;]&#125;, &#123;&quot;id&quot;: 2, &quot;directoryId&quot;: &quot;8YTCnijW9E49vJRze4z5HA&quot;, &quot;endpoints&quot;: [&quot;CONTROLLER://10.144.79.15:8121&quot;]&#125;]</span><br><span class="line">CurrentObservers:       [&#123;&quot;id&quot;: 3, &quot;directoryId&quot;: &quot;BpTuX0zkGVyVa846980_Xw&quot;&#125;]</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kaf nodes -b $(hostname -i):8120</span><br><span class="line">ID    ADDRESS             CONTROLLER   </span><br><span class="line">0     10.144.79.15:8100   true         </span><br><span class="line">1     10.144.79.15:8110   false        </span><br><span class="line">2     10.144.79.15:8120   false        </span><br><span class="line">3     10.144.79.15:8140   false</span><br></pre></td></tr></table></figure>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>新机制是有效的，但需要注意，必要条件为，至少需要有一个正常的 voter 实例。大致的执行流程为:</p>
<ol>
<li><p>找到一个运行时间最长的 voter，替换其 jar 包并添加 <code>controller.quorum.voters.override=[broker_id]@[hostname]:[meta dir_id]</code> 配置后重启。启动时直接用 <code>./bin/kafka-server-start.sh -daemon xxxx</code>启动。这一步重置了 voter 列表，仅保留当前的 voter。</p>
</li>
<li><p>对于其他 voter，依次清空 <code>__cluster_metadata-0</code> 后重启，并人工执行 <code>add-controller</code> 命令，加入 voter 。启动命令同上。</p>
</li>
<li><p>对于一个启动的 voter ，将使用的 jar 包换回并移除配置 <code>controller.quorum.voters.override</code> 后重启。</p>
</li>
<li><p>根据观察，在 leader 恢复后，各 broker 节点也会自动恢复。</p>
</li>
</ol>
<h1 id="线上服务修复效果"><a href="#线上服务修复效果" class="headerlink" title="线上服务修复效果"></a>线上服务修复效果</h1><p><img src="Pasted image 20251220224932.png" alt=""></p>
<p>相关 topic 的信息未丢失:</p>
<p><img src="Pasted image 20251220224918.png" alt=""></p>
<h1 id="主要变跟"><a href="#主要变跟" class="headerlink" title="主要变跟"></a>主要变跟</h1><p><a href="https://github.com/schwarzeni/kafka-hack-voterset-3.9.1/commit/225b4058daa366a2b272be6de3fc3050ca98458a#diff-cbe6a8b71b05ed22cf09d97591225b588e9fca6caaf95d3b34a43262cfd23aa6" target="_blank" rel="noopener">https://github.com/schwarzeni/kafka-hack-voterset-3.9.1/commit/225b4058daa366a2b272be6de3fc3050ca98458a#diff-cbe6a8b71b05ed22cf09d97591225b588e9fca6caaf95d3b34a43262cfd23aa6</a></p>
<h1 id="后续-TODO"><a href="#后续-TODO" class="headerlink" title="后续 TODO"></a>后续 TODO</h1><p>其实感觉这种修复方式还是存在风险，因为没有在高流量的集群验证过。后续必须添加上对于 raft voter 状态的监控，具体怎么添加这个还需再想想。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.schwarzeni.com/2025/12/20/kafka-raft-模式无法选主问题介绍及止损方式研究/" data-id="cmm23xrx200suvrjgcmu90jge" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kafka/">kafka</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2026/01/01/三十岁以前的往事（十五）：2025-年终总结/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          三十岁以前的往事（十五）：2025 年终总结
        
      </div>
    </a>
  
  
    <a href="/2025/12/20/kafka-raft-模式下普通-broker-无法自动更新-voter-列表问题修复/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">kafka raft 模式下普通 broker 无法自动更新 voter 列表问题修复</div>
    </a>
  
</nav>

  
  
    
    <script src="/third-party/gittalk/gittalk.min.js"></script>
    <script src="/third-party/gittalk/md5.min.js"></script>
    <div id="gitalk-container"></div>
    <script>
    var gitalk = new Gitalk({
      clientID: '18bc624fc12c1f06fdd3',
      clientSecret: '3f7d7806ef813726f3f930b554f3ed5a12af9a25',
      repo: 'schwarzeni.comment.github.io',
      owner: 'schwarzeni',
      admin: ['schwarzeni'],
      id: md5(location.pathname),      // Ensure uniqueness and length less than 50
      distractionFreeMode: false  // Facebook-like distraction free mode
    })

    gitalk.render('gitalk-container')
    </script>
    
</article>


</section>
        
          <aside id="sidebar">
  
    <div class="widget-wrap">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <h1 class="blog-title">Schwarzeni&#39;s blog</h1>
    <h2 class="blog-subtitle">Welcome to my secret garden</h2>
    <ul class="blog-link">
     
          <a href="/" title="Home">
            <li>主页</li>
          </a>
        
          <a href="/archives" title="Archives">
            <li>归档</li>
          </a>
        
          <a href="/categories" title="Categories">
            <li>分类</li>
          </a>
        
          <a href="/tags" title="Tags">
            <li>标签</li>
          </a>
        
          <a href="/plans" title="足迹">
            <li>足迹</li>
          </a>
        
          <a href="/about" title="About">
            <li>关于</li>
          </a>
        
          <a href="/works/leetcode-binarytree-edit/" title="LC 二叉树">
            <li>LC 二叉树</li>
          </a>
        
    </ul>
  </div>
</div>

  
    <div class="widget-wrap">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <img class="avatar" src="/images/avatar.png">
    <h2 class="author">Schwarzeni</h2>
    <h3 class="description"></h3>
    <div class="count-box">
      <a href="/archives"><div><strong>213</strong><br>文章</div></a>
      <a href="/categories"><div><strong>7</strong><br>分类</div></a>
      <a href="/tags"><div><strong>72</strong><br>标签</div></a>
    </div>



    <div class="social-link">
      
        <a class="hvr-bounce-in" href="http://github.com/schwarzeni" target="_blank" title="Github">
          Github
        </a>
      
        <a class="hvr-bounce-in" href="https://space.bilibili.com/21884414" target="_blank" title="Bilibili">
          Bilibili
        </a>
      
        <a class="hvr-bounce-in" href="https://music.163.com/#/user/home?id=259848766" target="_blank" title="网易云音乐">
          网易云音乐
        </a>
      
        <a class="hvr-bounce-in" href="https://bangumi.tv/user/547268" target="_blank" title="Bangumi">
          Bangumi
        </a>
      
    </div>

    <div class="friend-link">
      <h2>友情链接</h2>
      
        <a class="hvr-bounce-in" href="https://blog.csdn.net/nzyalj" target="_blank" title="旧博客">
          旧博客
        </a>
      
        <a class="hvr-bounce-in" href="https://qwqaq.com/" target="_blank" title="QWQAQ">
          QWQAQ
        </a>
      
        <a class="hvr-bounce-in" href="https://geektutu.com/" target="_blank" title="极客兔兔">
          极客兔兔
        </a>
      
        <a class="hvr-bounce-in" href="https://hj24.life/" target="_blank" title="hj24">
          hj24
        </a>
      
    </div>
  </div>
</div>

  
</aside>

        
      </div>
      
    </div>
    

<script src="/third-party/wow/jquery.min.js"></script>
<script src="/third-party/wow/wow.min.js"></script>
<script>
new WOW().init();
</script>
<!-- 修改浮动小按钮 -->
<script src="/third-party/powerful-sidebar-util/lib/axios.min.js"></script>
<script src="/third-party/powerful-sidebar-util/powerful-sidebar-util.js"></script>


  <link rel="stylesheet" href="/plugin/fancybox/jquery.fancybox.css">
  <script src="/plugin/fancybox/jquery.fancybox.pack.js"></script>



  <link rel="stylesheet" href="/plugin/galmenu/GalMenu.css">
  <script src="/plugin/galmenu/GalMenu.js"></script>
  <div class="GalMenu GalDropDown">
      <div class="circle" id="gal">
        <div class="ring">
          
            <a href="/" title="" class="menuItem">首页</a>
          
            <a href="/tags" title="" class="menuItem">标签</a>
          
            <a href="/categories" title="" class="menuItem">分类</a>
          
            <a href="/archives" title="" class="menuItem">归档</a>
          
            <a href="/about" title="" class="menuItem">关于</a>
          
        </div>
        
          <audio id="audio" src="#"></audio>
        
      </div> 
</div>
<div id="overlay" style="opacity: 1; cursor: pointer;"></div>
  <script type="text/javascript">var items = document.querySelectorAll('.menuItem');
    for (var i = 0,
    l = items.length; i < l; i++) {
      items[i].style.left = (50 - 35 * Math.cos( - 0.5 * Math.PI - 2 * (1 / l) * i * Math.PI)).toFixed(4) + "%";
      items[i].style.top = (50 + 35 * Math.sin( - 0.5 * Math.PI - 2 * (1 / l) * i * Math.PI)).toFixed(4) + "%"
    }</script>
<script type="text/javascript">
  $(document).ready(function() {
    $('body').GalMenu({
      'menu': 'GalDropDown'
    })
  });
</script>

  <!-- <section class="hidden-xs"> 
  <ul class="cb-slideshow"> 
    <li><span>我</span></li> 
    <li><span>永</span></li> 
    <li><span>远</span></li> 
    <li><span>喜</span></li> 
    <li><span>欢</span></li> 
    <li><span>02</span></li> 
  </ul>
</section> -->

<script src="/js/script.js"></script>


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-155992609-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-155992609-1');
</script>


<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>


  </div>
	<script>
	/*
		var host = "localhost:4000"
		var mainPageUrl = "http://" + host +"/blog";
		var $folder = document.getElementById('main_folder');
		var $main = document.getElementById('wrap');
		var $container = document.getElementById('container');
		if ( document.referrer.includes(host) || !(window.location.href === mainPageUrl || window.location.href === mainPageUrl + "/")) {
			$folder.style.display = "none";	
		} else {
			$main.style.display = "none";
		}
		$container.style = "";
		document.getElementById('go_to_main_page').onclick = function() {
			$folder.style.display = "none";	
			$main.style = "";
		}
*/
	</script>
</body>
</html>
